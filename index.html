<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <title>Travel Sync v5.10HKT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/phosphor-icons/web.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <style>
    /* --- iOS 26 System Variables --- */
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.65);
      --ios-card-border: rgba(255, 255, 255, 0.4);
      --ios-primary: #007AFF;
      --ios-danger: #FF3B30;
      --ios-warning: #FFCC00;
      --ios-success: #34C759;
      --glass-blur: blur(25px);
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    html {
      height: 100%;
      overscroll-behavior-y: none;
    }
    body {
      height: 100%;
      font-family: var(--font-stack);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background-color: #000;
      margin: 0;
      color: #000;
      overflow: hidden;
      user-select: none;
    }
    /* Scrollable Container */
    .app {
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    /* Main Scroll Area */
    main {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-top: 20px;
    }
    /* Utilities */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 100px); }
    /* Components */
    /* iOS Glass Card Light */
    .ios-card {
      background: var(--ios-card-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--ios-card-border);
      border-radius: 22px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      overflow: hidden;
    }
    /* iOS Premium Dark Glass Card FlightExpense */
    .ios-card-dark-glass {
      background: rgba(22, 22, 24, 0.85);
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 26px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      color: white;
      position: relative;
      overflow: hidden;
    }
    .dark-glass-gradient {
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 80% 20%, rgba(10, 132, 255, 0.25), transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    /* List Items */
    .ios-list-item {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      border-radius: 18px;
      margin-bottom: 8px;
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.2s, transform 0.2s;
      border: 1px solid rgba(255,255,255,0.5);
      touch-action: manipulation;
    }
    .ios-list-item.active {
      background: rgba(255, 255, 255, 0.95);
      transform: scale(0.98);
    }
    /* Drag Drop Styles */
    .sortable-ghost {
      opacity: 0.4;
      background: #e5e7eb;
      border: 1px dashed #9ca3af;
    }
    .sortable-drag {
      opacity: 1;
      background: #fff;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      transform: scale(1.02);
      z-index: 50;
    }
    /* Strict Drag Handle for iOS Stability */
    .drag-handle {
      cursor: grab;
      padding: 10px;
      margin: -10px;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: pan-y;
      -webkit-user-select: none;
      user-select: none;
    }
    .sortable-expenses {
      position: relative;
      z-index: 20;
    }
    /* Action Buttons */
    .action-btn-group {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      padding-left: 8px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    .ios-list-item:hover .action-btn-group, .action-btn-group.active {
      opacity: 1;
    }
    .icon-btn {
      padding: 6px;
      color: #8E8E93;
      transition: color 0.2s;
      border-radius: 50%;
    }
    .icon-btn:hover {
      background: rgba(0,0,0,0.05);
    }
    .icon-btn.edit:hover {
      color: var(--ios-primary);
    }
    .icon-btn.delete:hover {
      color: var(--ios-danger);
    }
    /* Inputs */
    .ios-input {
      background: rgba(118, 118, 128, 0.12);
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 17px;
      color: #000;
      width: 100%;
      box-sizing: border-box;
      transition: background 0.2s;
    }
    .ios-input:focus {
      background: rgba(118, 118, 128, 0.2);
      outline: none;
    }
    .ios-input::placeholder {
      color: #8E8E93;
    }
    /* Modals */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(5px);
      z-index: 100;
    }
    .ios-modal-container {
      background: rgba(250, 250, 250, 0.9);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 32px;
      display: flex;
      flex-direction: column;
      max-height: 92vh;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.4);
    }
    .ios-modal-header {
      padding: 16px;
      text-align: center;
      font-weight: 600;
      font-size: 17px;
      border-bottom: 0.5px solid rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .ios-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      -webkit-overflow-scrolling: touch;
    }
    /* Calculator specific modal padding */
    .ios-modal-body.calc-body {
      padding: 16px 16px 8px 16px;
      overflow-y: hidden;
      display: flex;
      flex-direction: column;
    }
    .ios-modal-footer {
      padding: 16px 24px;
      border-top: 0.5px solid rgba(0,0,0,0.1);
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      background: rgba(255,255,255,0.5);
    }
    /* Buttons */
    .btn-ios-cancel {
      flex: 1;
      height: 50px;
      border-radius: 14px;
      background: rgba(118, 118, 128, 0.12);
      color: #000;
      font-weight: 600;
      font-size: 17px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-ios-primary {
      flex: 1;
      height: 50px;
      border-radius: 14px;
      background: var(--ios-primary);
      color: white;
      font-weight: 600;
      font-size: 17px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 15px rgba(0, 122, 255, 0.4);
    }
    .btn-ios-primary:active {
      opacity: 0.8;
      transform: scale(0.98);
    }
    .btn-ios-primary:disabled {
      opacity: 0.5;
      box-shadow: none;
    }
    /* Calculator Buttons */
    .calc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      flex: 1;
    }
    .calc-btn {
      border-radius: 10px;
      background: white;
      font-size: 20px;
      font-weight: 500;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      transition: background 0.1s;
      height: 100%;
      min-height: 40px;
    }
    .calc-btn:active {
      background: #E5E5EA;
    }
    .calc-btn.op {
      background: #FF9500;
      color: white;
      font-weight: 600;
    }
    .calc-btn.op:active {
      background: #D47B00;
    }
    .calc-btn.top-op {
      background: #D1D1D6;
      color: black;
    }
    .calc-btn.top-op:active {
      background: #A0A0A5;
    }
    .calc-btn.done-btn {
      background: var(--ios-primary);
      color: white;
      font-size: 17px;
      font-weight: 600;
    }
    /* Dock */
    .iphone-dock {
      background: rgba(245, 245, 245, 0.75);
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      border-radius: 38px;
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }
    /* Tabs */
    .day-tab {
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .day-tab.active {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(255,255,255,0.5);
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      transform: translateY(-2px);
    }
    .task-done {
      text-decoration: line-through;
      color: #8E8E93;
      opacity: 0.7;
    }
    .rotate-icon {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    /* Fade Transition */
    .fade-enter-active, .fade-leave-active {
      transition: opacity 0.2s ease;
    }
    .fade-enter-from, .fade-leave-to {
      opacity: 0;
    }
    /* Flight Status */
    .status-ontime {
      color: var(--ios-success);
      background: rgba(52, 199, 89, 0.15);
      border: 1px solid rgba(52, 199, 89, 0.2);
    }
    .status-delayed {
      color: var(--ios-danger);
      background: rgba(255, 59, 48, 0.15);
      border: 1px solid rgba(255, 59, 48, 0.2);
    }
    .status-boarding {
      color: var(--ios-warning);
      background: rgba(255, 204, 0, 0.15);
      border: 1px solid rgba(255, 204, 0, 0.2);
    }
    /* --- HKG Board Style v5.10 --- */
    .ios-card-dark-glass.hkg-style {
      background: #353E53 !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      border: none !important;
      border-radius: 6px !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .hkg-style .dark-glass-gradient {
      display: none;
    }
    /* HKG Style Internal Overrides */
    .hkg-style .text-shadow-none {
      text-shadow: none !important;
    }
    /* HKG Style Force Reset Default Apply */
    .ios-card-dark-glass.hkg-style {
      background: #353E53 !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      box-shadow: none !important;
    }
    .ios-card-dark-glass.hkg-style:before, .ios-card-dark-glass.hkg-style:after {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="fixed inset-0 z-0 pointer-events-none">
      <img src="IMG6732.jpeg?auto=format&fit=crop&w=2000&q=80" class="w-full h-full object-cover blur-4px scale-105" alt="Taipei Background">
      <div class="absolute inset-0 bg-white/70 backdrop-blur-2px"></div>
    </div>
    <main class="relative z-10 no-scrollbar pb-safe px-5">
      <div class="flex items-center justify-between mb-8 mt-4">
        <h1 class="text-34px leading-tight font-bold tracking-tight text-black drop-shadow-sm font-SF Pro Display">eMenu Taipei</h1>
        <div class="flex items-center gap-2 mt-0.5 pl-1">
          <span class="text-9px font-semibold text-gray-400/80 uppercase tracking-widest">appVersion</span>
        </div>
        <div class="flex items-center gap-2 bg-white/50 backdrop-blur-md px-2 py-0.5 rounded-full border border-black/5">
          <div class="w-1.5 h-1.5 rounded-full transition-colors duration-300" :class="syncState === 'synced' ? 'bg-green-500' : syncState === 'saving' || syncState === 'loading' ? 'bg-yellow-400' : 'bg-red-500'"></div>
          <span class="text-10px font-medium text-gray-500">{{ syncStatusText }}</span>
        </div>
        <button @click="forceReloadCloud" class="text-gray-400 hover:text-gray-600 transition p-1" title="Reload">
          <i class="ph ph-arrows-clockwise text-xs" :class="syncState === 'loading' ? 'rotate-icon'"></i>
        </button>
      </div>
      <div class="flex flex-col items-end text-right">
        <span class="text-10px font-bold text-007AFF uppercase tracking-wide mb-0.5"></span>
        <span class="text-9px font-bold text-gray-400 uppercase tracking-wide mb-0.5">HKD TWD</span>
      </div>
      <div class="text-2xl font-bold text-gray-800 tracking-tight font-mono leading-none my-0.5">{{ formattedRate }}</div>
      <div class="text-9px font-medium text-gray-500 mb-0.5 font-mono tracking-tight"></div>
      <div class="text-9px font-medium text-gray-400/80 font-mono tracking-tight">
        <div>{{ lastRateUpdateLabel }}</div>
      </div>
      <div class="mb-8">
        <div class="flex justify-between gap-3 overflow-x-auto no-scrollbar py-1 px-1">
          <button v-for="i in days" :key="i" @click="selectDay(i)" :class="['day-tab', selectedDay === i ? 'active' : '']">
            <i class="ph ph-list-checks text-2xl mb-1 text-gray-400 transition-colors" :class="selectedDay === i ? 'text-007AFF' : ''"></i>
            <span class="font-medium text-gray-500" :class="selectedDay === i ? 'font-bold' : ''">Day {{ i }}</span>
          </button>
        </div>
      </div>
      <div v-if="currentTab" class="space-y-5 mb-6 transition" name="fade">
        <div v-if="shouldShowFlightCard" class="ios-card-dark-glass p-0 mb-4 transition-all duration-500" :class="flightBoardStyle === 'hkg' ? 'hkg-style' : ''">
          <div class="dark-glass-gradient"></div>
          <div class="absolute top-3 right-3 z-30 flex items-center gap-2">
            <button @click.stop="flightBoardStyle = flightBoardStyle === 'hkg' ? 'ios' : 'hkg'" :class="['px-3 py-1.5 rounded-full text-10px font-bold border transition-all active:scale-95 select-none', flightBoardStyle === 'hkg' ? 'bg-white text-black border-white shadow-md' : 'bg-black/20 text-white border-white/20 backdrop-blur-md hover:bg-black/30']">
              {{ flightBoardStyle === 'hkg' ? 'iOS' : 'HKG' }}
              <i class="ph ph-arrow-square-out text-xs opacity-70"></i>
            </button>
            <a v-if="activeFlight.liveLink" :href="activeFlight.liveLink" target="_blank" class="flex items-center gap-1.5 bg-white/20 hover:bg-white/30 border border-white/20 px-3 py-1.5 rounded-full text-[11px] font-bold text-white transition-all active:scale-95">
              <i class="ph ph-broadcast text-[#34C759] animate-pulse"></i>
              Flighty 實況
              <i class="ph ph-arrow-square-out text-xs opacity-70"></i>
            </a>
            <button @click.stop="openFlightModal(activeFlight.id)" class="text-white/70 hover:text-white bg-black/20 hover:bg-black/40 border border-white/10 p-1.5 rounded-full transition backdrop-blur-md active:scale-95">
              <i class="ph ph-pencil-simple text-sm"></i>
            </button>
          </div>
          <div v-if="flightBoardStyle === 'hkg'" class="flex flex-col h-full relative z-10 w-full">
            <div class="pt-6 pb-4 text-center flex flex-col items-center justify-center">
              <div class="text-10px text-white/50 uppercase tracking-widest font-bold mb-1">Gate</div>
              <div class="text-4.5rem leading-0.85 font-bold text-FFCC00 font-sans drop-shadow-lg tracking-tighter">{{ activeFlight.gate || '--' }}</div>
            </div>
            <div class="mx-0 mb-0 bg-F2F2F7 border-t-4 border-FFCC00 px-6 py-4 flex items-center justify-between shadow-2xl relative z-20">
              <div class="flex flex-col items-start">
                <span class="text-10px text-gray-400 font-bold uppercase tracking-wider">Flight</span>
                <span class="text-3xl font-bold text-black font-mono text-shadow-none tracking-tight">{{ activeFlight.code }}</span>
              </div>
              <div class="flex flex-col items-end">
                <span class="text-10px text-gray-400 font-bold uppercase tracking-wider">Dep</span>
                <span class="text-3xl font-bold text-black font-mono text-shadow-none tracking-tight">{{ activeFlight.depTime }}</span>
              </div>
            </div>
            <div class="bg-BF443B mx-0 px-5 pt-4 pb-5 flex justify-between items-end relative shadow-inner">
              <div class="flex flex-col items-start gap-3">
                <div class="flex items-baseline gap-2">
                  <span class="text-2xl font-bold text-white font-mono leading-none">{{ activeFlight.fromCode }}</span>
                  <span class="text-sm font-bold text-white/80 uppercase">{{ activeFlight.fromTerminal }}</span>
                  <span class="text-2xl font-bold text-white font-mono leading-none">to</span>
                </div>
                <div class="flex items-baseline gap-2">
                  <span class="text-4xl font-bold text-FFCC00 font-mono leading-none drop-shadow-md">{{ activeFlight.toCode }}</span>
                  <span class="text-xl font-bold text-FFCC00/90 uppercase">{{ activeFlight.toTerminal }}</span>
                </div>
              </div>
              <div class="flex flex-col items-end">
                <div class="text-lg font-extrabold text-white mb-1 uppercase tracking-wider">{{ activeFlight.status }}</div>
                <div class="flex flex-col items-end">
                  <span class="text-9px text-white/60 uppercase font-bold tracking-wide">Arr</span>
                  <span class="text-2xl font-bold text-white font-mono leading-none mt-0.5">{{ activeFlight.arrTime }}</span>
                </div>
              </div>
            </div>
            <div class="h-1 bg-275CC0"></div>
          </div>
          <div v-else class="p-5 pb-6 relative z-10">
            <div class="flex justify-start items-center mb-6 mt-1">
              <div :class="['px-3 py-1 rounded-full text-11px font-bold tracking-wide border backdrop-blur-md', getStatusClass(activeFlight.status)]">{{ activeFlight.status }}</div>
            </div>
            <div class="flex items-center justify-between mt-4">
              <div class="text-center min-w-60px">
                <div class="text-3xl font-bold tracking-wider text-white">{{ activeFlight.fromCode }}</div>
                <div class="text-10px font-bold opacity-60 mt-1 uppercase">{{ activeFlight.fromTerminal }}</div>
              </div>
              <div class="flex-1 px-4 flex flex-col items-center">
                <div class="text-10px font-mono opacity-50 mb-1">{{ activeFlight.code }}</div>
                <div class="w-full flex items-center gap-2">
                  <div class="h-2px bg-white/20 flex-1 rounded-full"></div>
                  <i class="ph ph-airplane-tilt text-xl opacity-90 text-007AFF"></i>
                  <div class="h-2px bg-white/20 flex-1 rounded-full"></div>
                </div>
                <div class="text-10px mt-1.5 opacity-80 font-medium tracking-wide text-center">{{ activeFlight.note }}</div>
              </div>
              <div class="text-center min-w-60px">
                <div class="text-3xl font-bold tracking-wider text-white">{{ activeFlight.toCode }}</div>
                <div class="text-10px font-bold opacity-60 mt-1 uppercase">{{ activeFlight.toTerminal }}</div>
              </div>
            </div>
            <div class="flex justify-between items-end mt-6 pt-4 border-t border-white/10">
              <div>
                <div class="text-10px opacity-50 uppercase tracking-wider mb-0.5">預計起飛</div>
                <div class="text-2xl font-mono font-bold leading-none">{{ activeFlight.depTime }}</div>
              </div>
              <div class="flex flex-col items-center bg-white/10 px-4 py-2 rounded-xl border border-white/10">
                <div class="text-9px opacity-50 uppercase tracking-widest mb-0.5">Gate</div>
                <div class="text-xl font-bold text-FFCC00">{{ activeFlight.gate || '--' }}</div>
              </div>
              <div class="text-right">
                <div class="text-10px opacity-50 uppercase tracking-wider mb-0.5">預計抵達</div>
                <div class="text-2xl font-mono font-bold leading-none">{{ activeFlight.arrTime }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</body>
</html>
<script>
  // --- Date/Day Info ---
  const days = reactive([
    { date: 15, week: 'Mon', label: 'Day 1', type: 'flight-out' },
    { date: 16, week: 'Tue', label: 'Day 2', type: 'normal' },
    { date: 17, week: 'Wed', label: 'Day 3', type: 'normal' },
    { date: 18, week: 'Thu', label: 'Day 4', type: 'flight-return' },
  ]);
  const isFlightDay = computed(() => ['flight-out', 'flight-return'].includes(days[selectedDay.value]?.type));

  // --- Data ---
  const itinerary = reactive([], [], [], []);
  const sortedItinerary = computed(() => itinerary[selectedDay.value]);
  const selectedMapLocation = ref(null);

  function showLocationOnMap(item) {
    selectedMapLocation.value = item.address.trim() ? { title: item.title, address: item.address, id: item.id } : null;
  }

  function generateMapLink(address, type) {
    if (!address) return;
    const q = encodeURIComponent(address);
    if (type === 'search') {
      return `https://www.google.com/maps/search/?api=1&query=${q}`;
    } else {
      return `https://www.google.com/maps/dir/?api=1&destination=${q}&travelmode=walking`;
    }
  }

  function determineInitialState() {
    const now = new Date();
    const tripStart = new Date('2025-12-15T00:00:00');
    const tripEnd = new Date('2025-12-18T23:59:59');
    if (now < tripStart) {
      currentTab.value = 0;
    } else if (now >= tripStart && now <= tripEnd) {
      const diffTime = Math.abs(now - tripStart);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      let idx = diffDays - 1;
      if (idx < 0) idx = 0;
      if (idx > 3) idx = 3;
      selectedDay.value = idx;
    } else {
      currentTab.value = 3;
    }
  }

  const flights = ref([
    {
      id: 'outbound',
      type: 'outbound',
      date: '2025-12-15',
      code: 'CX400',
      depTime: '1245',
      arrTime: '1445',
      fromCode: 'HKG',
      fromTerminal: 'T1',
      toCode: 'TPE',
      toTerminal: 'T1',
      title: 'Cathay Pacific',
      note: 'Economy',
      isConfirmed: true,
      status: 'On Time',
      gate: '24',
      liveLink: 'https://live.flighty.app/2af42e286-3d91-4f25-91b8-d22148de4e6a',
    },
    {
      id: 'return',
      type: 'return',
      date: '2025-12-18',
      code: 'CX443',
      depTime: '1700',
      arrTime: '1855',
      fromCode: 'TPE',
      fromTerminal: 'T1',
      toCode: 'HKG',
      toTerminal: 'T1',
      title: 'Cathay Pacific',
      note: 'Economy',
      isConfirmed: false,
      status: 'Scheduled',
      gate: '--',
      liveLink: 'https://live.flighty.app/29fab3b3b-3e56-439f-8292-853a0a6f1bf3',
    },
  ]);

  const activeFlight = computed(() => {
    const type = days[selectedDay.value]?.type;
    let f = type === 'flight-out' ? flights.value.find(f => f.type === 'outbound') : type === 'flight-return' ? flights.value.find(f => f.type === 'return') : null;
    return f;
  });

  const shouldShowFlightCard = computed(() => activeFlight.value !== null && currentTab.value);

  function getStatusClass(status) {
    if (status === 'On Time' || status === 'Landed') return 'status-ontime';
    if (status === 'Delayed') return 'status-delayed';
    if (status === 'Boarding') return 'status-boarding';
    return 'bg-white/10 border-white/20 text-white';
  }

  // --- File Upload ---
  const isUploading = ref(false);
  const uploadStatus = reactive({ shopping: '', info: '' });
  const tempUploadPreview = reactive({ shopping: null, info: null });
  const pendingUploadFiles = reactive({ shopping: null, info: null });

  // --- App Initialization ---
  const app = Vue.createApp({
    setup() {
      const currentTab = ref(0);
      const selectedDay = ref(0);
      const flightBoardStyle = ref('ios');
      const syncState = ref('synced');
      const syncStatusText = ref('Synced');
      const appVersion = '5.10';
      const formattedRate = '4.1';
      const lastRateUpdateLabel = 'Last updated: 2025-12-21 17:00';

      const openFlightModal = (id) => {
        const def = {
          id: null,
          type: 'outbound',
          date: '2025-12-15',
          code: '',
          depTime: '',
          arrTime: '',
          fromCode: 'HKG',
          toCode: 'TPE',
          status: 'Scheduled',
          gate: '--',
          fromTerminal: '',
          toTerminal: '',
        };
        if (id) {
          const f = flights.value.find(x => x.id === id) || flights.value.find(x => x.type === id);
          Object.assign(newFlight, f ? deepClone(f) : def);
        } else {
          Object.assign(newFlight, def);
        }
        flightModalOpen.value = true;
      };

      const closeFlightModal = () => {
        flightModalOpen.value = false;
      };

      const saveFlight = () => {
        const item = { ...newFlight, id: newFlight.id, type: newFlight.type };
        const idx = flights.value.findIndex(f => f.id === item.id);
        if (idx !== -1) {
          flights.value.splice(idx, 1, item);
        } else {
          flights.value.push(item);
        }
        closeFlightModal();
        saveAll();
      };

      const openAddModal = () => {
        const t = currentTab.value;
        if (t === 0) openItineraryModal();
        else if (t === 1) openShoppingModal();
        else if (t === 2) openInfoModal();
        else if (t === 3) addPreNote();
        else if (t === 4) openExpenseModal(null);
      };

      return {
        days,
        selectedDay,
        currentTab,
        flightBoardStyle,
        syncState,
        syncStatusText,
        appVersion,
        formattedRate,
        lastRateUpdateLabel,
        openFlightModal,
        closeFlightModal,
        saveFlight,
        openAddModal,
        shouldShowFlightCard,
        activeFlight,
        getStatusClass,
        isFlightDay,
        flights,
      };
    },
  });

  app.mount('#app');
</script>
<!-- Additional Components and Modals -->
<div v-if="imageViewer.open" class="fixed inset-0 z-60 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4" @click="imageViewer.open = false">
  <button class="absolute top-8 right-8 text-white/50 hover:text-white p-2 transition">
    <i class="ph ph-x-circle text-4xl"></i>
  </button>
  <img v-if="imageViewer.url" :src="imageViewer.url" class="max-w-full max-h-85vh object-contain rounded-lg shadow-2xl" @click.stop>
</div>

<transition name="fade">
  <div v-if="preNoteModalOpen" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" @click.self="closePreNoteModal">
    <div class="ios-modal-container">
      <div class="ios-modal-header">
        {{ editingPreNote.id ? 'Edit Note' : 'Add Note' }}
      </div>
      <div class="ios-modal-body space-y-4">
        <input v-model="editingPreNote.name" class="ios-input" placeholder="Note">
        <div class="flex items-center gap-3 p-3 bg-gray-100 rounded-xl">
          <input type="checkbox" id="pre-note-done" v-model="editingPreNote.isDone" class="w-6 h-6 text-007AFF rounded focus:ring-007AFF">
          <label for="pre-note-done" class="text-gray-900 font-medium select-none flex-1">Done</label>
        </div>
      </div>
      <div class="ios-modal-footer">
        <button @click="closePreNoteModal" class="btn-ios-cancel">Cancel</button>
        <button @click="savePreNoteEdit" class="btn-ios-primary">Save</button>
      </div>
    </div>
  </div>
</transition>

<transition name="fade">
  <div v-if="flightModalOpen" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" @click.self="closeFlightModal">
    <div class="ios-modal-container">
      <div class="ios-modal-header">
        {{ newFlight.id ? 'Edit Flight' : 'Add Flight' }}
      </div>
      <div class="ios-modal-body space-y-4">
        <div class="p-1 bg-gray-200/50 rounded-xl flex">
          <button :class="['flex-1 py-1.5 rounded-lg text-xs font-bold transition-all', newFlight.type === 'outbound' ? 'bg-white shadow text-black' : 'text-gray-400']" @click="newFlight.type = 'outbound'">Outbound</button>
          <button :class="['flex-1 py-1.5 rounded-lg text-xs font-bold transition-all', newFlight.type === 'return' ? 'bg-white shadow text-black' : 'text-gray-400']" @click="newFlight.type = 'return'">Return</button>
        </div>
        <div>
          <label class="text-xs text-gray-400 ml-1 font-bold">Flight Code</label>
          <input v-model="newFlight.code" class="ios-input" placeholder="CX400">
        </div>
        <div>
          <label class="text-xs text-gray-400 ml-1 font-bold">Status</label>
          <select v-model="newFlight.status" class="ios-input appearance-none">
            <option value="On Time">On Time</option>
            <option value="Boarding">Boarding</option>
            <option value="Delayed">Delayed</option>
            <option value="Landed">Landed</option>
          </select>
        </div>
        <div class="flex gap-2">
          <div class="flex-1 min-w-0">
            <label class="text-xs text-gray-400 ml-1 font-bold">From</label>
            <div class="flex gap-1">
              <input v-model="newFlight.fromCode" class="ios-input text-center uppercase w-23" placeholder="HKG">
              <input v-model="newFlight.fromTerminal" class="ios-input text-center uppercase w-13 text-sm px-1" placeholder="T1">
            </div>
          </div>
          <div class="flex-1 min-w-0">
            <label class="text-xs text-gray-400 ml-1 font-bold">To</label>
            <div class="flex gap-1">
              <input v-model="newFlight.toCode" class="ios-input text-center uppercase w-23" placeholder="TPE">
              <input v-model="newFlight.toTerminal" class="ios-input text-center uppercase w-13 text-sm px-1" placeholder="T1">
            </div>
          </div>
        </div>
        <div class="flex gap-3">
          <div class="flex-1 min-w-0">
            <label class="text-xs text-gray-400 ml-1 font-bold">Departure Time</label>
            <input v-model="newFlight.depTime" type="time" class="ios-input w-full">
          </div>
          <div class="flex-1 min-w-0">
            <label class="text-xs text-gray-400 ml-1 font-bold">Arrival Time</label>
            <input v-model="newFlight.arrTime" type="time" class="ios-input w-full">
          </div>
        </div>
        <div>
          <label class="text-xs text-gray-400 ml-1 font-bold">Gate</label>
          <input v-model="newFlight.gate" class="ios-input" placeholder="B42">
        </div>
        <textarea v-model="newFlight.note" class="ios-input" rows="2" placeholder="Note"></textarea>
      </div>
      <div class="ios-modal-footer">
        <button @click="closeFlightModal" class="btn-ios-cancel">Cancel</button>
        <button @click="saveFlight" class="btn-ios-primary">Save</button>
      </div>
    </div>
  </div>
</transition>
