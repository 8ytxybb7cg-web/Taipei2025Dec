<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>eMenu Taipei — 行程助手</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.86);
      --card-radius: 18px;
    }
    html,body,#app { height:100%; }
    body{
      font-family: 'Noto Sans TC', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background-color:#0f172a; /* slate-900 */
      margin:0;
    }
    /* hide scrollbar on WebKit */
    .no-scrollbar::-webkit-scrollbar { display:none;
    }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
    /* small fade animation */
    .fade-enter-active, .fade-leave-active { transition: opacity .25s ease;
    }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
  </style>
</head>
<body>
  <div id="app" class="h-full max-w-xl mx-auto flex flex-col pt-8 pb-4">
    <header class="flex-shrink-0 px-4">
      <h1 class="text-3xl font-bold text-white mb-4">行程助手</h1>
      <div class="flex space-x-2 p-1 bg-slate-800 rounded-full">
        <button
          v-for="tab in ['行程','購物','備忘','資訊','機票/費用']"
          :key="tab"
          @click="currentTab = tab"
          :class="['px-4 py-2 rounded-full text-sm font-medium transition-colors', currentTab === tab ? 'bg-indigo-500 text-white shadow-md' : 'text-slate-400 hover:text-white']"
        >{{ tab }}</button>
      </div>
    </header>

    <main class="flex-grow overflow-y-auto mt-4 px-4 no-scrollbar">
      
      <div v-if="currentTab === '行程'" class="mb-4 flex space-x-2 overflow-x-auto no-scrollbar pb-2">
        <button 
          v-for="day in days" 
          :key="day.index" 
          @click="selectDay(day.index)"
          :class="['flex-shrink-0 px-4 py-2 rounded-lg text-sm font-medium transition-colors', selectedDay === day.index ? 'bg-indigo-500 text-white shadow-md' : 'bg-slate-800 text-slate-400 hover:bg-slate-700']"
        >
          {{ day.label }}
        </button>
      </div>

      <transition name="fade">
        <div v-if="shouldShowFlightCard" class="glass-card mb-4 p-4 shadow-lg rounded-xl bg-white/80 backdrop-blur-xl border border-white/30 text-slate-800">
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-xl font-bold">航班資料 ({{ activeFlight.flightNo || '未設定' }})</h2>
            <i class="ph ph-airplane text-indigo-500 text-2xl"></i>
          </div>
          <p class="text-sm">出發：{{ activeFlight.departureTime }} / 抵達：{{ activeFlight.arrivalTime }}</p>
          <div class="mt-3 pt-3 border-t border-slate-300 flex justify-between text-sm">
             <div><span class="font-medium">匯率 (TWD/HKD):</span> {{ formattedRate }}</div>
             <div><span class="font-medium">天氣 (台北):</span> {{ weather.temp }}°C <i :class="weatherIconClass"></i></div>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="selectedMapAddress" class="glass-card mb-4 p-4 shadow-lg rounded-xl bg-white/80 backdrop-blur-xl border border-white/30 text-slate-800">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold truncate">地點動作：{{ selectedLocationName }}</h2>
                <button @click="selectedMapAddress = ''" class="text-slate-500 hover:text-slate-800 p-1">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <div class="flex space-x-3">
                <a :href="openMapLink" target="_blank" class="flex-1 flex items-center justify-center p-3 rounded-lg bg-indigo-500 text-white font-medium hover:bg-indigo-600 transition-colors">
                    <i class="ph ph-map-pin-line mr-2 text-xl"></i>
                    在 Google 地圖中打開
                </a>
                <a :href="navigateMapLink" target="_blank" class="flex-1 flex items-center justify-center p-3 rounded-lg bg-green-500 text-white font-medium hover:bg-green-600 transition-colors">
                    <i class="ph ph-navigation-arrow mr-2 text-xl"></i>
                    開始導航
                </a>
            </div>
        </div>
      </transition>

      <div v-if="currentTab === '行程'">
        <h2 class="text-2xl font-bold text-white mb-3">第 {{ selectedDay + 1 }} 日行程</h2>
        <div v-if="sortedItinerary.length === 0" class="text-slate-400 italic text-center py-10">
          今日暫無行程。
        </div>

        <div v-for="(item, index) in sortedItinerary" :key="index" class="glass-card mb-3 p-4 shadow-md rounded-xl bg-white/80 backdrop-blur-xl text-slate-800 flex justify-between items-start">
            <div>
                <div class="text-xs text-slate-500 font-semibold">{{ item.time }}</div>
                <div class="text-lg font-bold mb-1">{{ item.title }}</div>
                <div 
                    :class="['text-sm text-slate-600 flex items-center', {'cursor-pointer text-indigo-600 hover:underline': item.googleMapAddress}]"
                    @click="item.googleMapAddress && selectLocation(item)"
                >
                    <i class="ph ph-map-pin mr-1"></i>
                    {{ item.location }}
                </div>
                <p v-if="item.notes" class="text-xs mt-2 italic text-slate-700">{{ item.notes }}</p>
            </div>
            <div class="flex space-x-2 flex-shrink-0">
                <button @click="openItineraryModal(item)" class="text-indigo-500 hover:text-indigo-700 p-1">
                    <i class="ph ph-pencil-simple text-xl"></i>
                </button>
                <button @click="removeItineraryItem(item)" class="text-red-500 hover:text-red-700 p-1">
                    <i class="ph ph-trash-simple text-xl"></i>
                </button>
            </div>
        </div>
      </div>
      
      <div v-if="currentTab !== '行程'" class="py-10 text-center text-slate-400">
        {{ currentTab }} 內容...
      </div>
      
    </main>

    <div class="sticky bottom-0 p-4 flex-shrink-0">
        <button 
            @click="openAddModal"
            class="w-16 h-16 rounded-full bg-indigo-500 text-white shadow-xl hover:bg-indigo-600 transition-colors absolute right-4 -mt-20 flex items-center justify-center"
        >
            <i class="ph ph-plus text-3xl"></i>
        </button>
    </div>

    <transition name="fade">
      <div v-if="itineraryModalOpen" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-xl bg-white/95 text-slate-800 shadow-2xl">
          <h3 class="text-2xl font-bold mb-4">{{ newItineraryItem.title ? '編輯行程' : '新增行程' }}</h3>
          <form @submit.prevent="saveItineraryItem">
            <div class="space-y-3">
              <div>
                <label for="item-time" class="block text-sm font-medium text-slate-700">時間</label>
                <input type="time" id="item-time" v-model="newItineraryItem.time" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" required>
              </div>
              <div>
                <label for="item-title" class="block text-sm font-medium text-slate-700">標題/活動名稱</label>
                <input type="text" id="item-title" v-model="newItineraryItem.title" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" required>
              </div>
              <div>
                <label for="item-location" class="block text-sm font-medium text-slate-700">地點</label>
                <input type="text" id="item-location" v-model="newItineraryItem.location" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
              </div>
              <div>
                <label for="item-map-address" class="block text-sm font-medium text-slate-700">Google Map 地址 (可選)</label>
                <input type="text" id="item-map-address" v-model="newItineraryItem.googleMapAddress" placeholder="輸入地址或地點名稱" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
              </div>
              <div>
                <label for="item-notes" class="block text-sm font-medium text-slate-700">備註 (可選)</label>
                <textarea id="item-notes" v-model="newItineraryItem.notes" rows="2" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
              </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
              <button type="button" @click="closeItineraryModal" class="px-4 py-2 text-sm font-medium text-slate-700 rounded-lg hover:bg-slate-200 transition-colors">取消</button>
              <button type="submit" class="px-4 py-2 text-sm font-medium bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">儲存</button>
            </div>
          </form>
        </div>
      </div>
    </transition>

  </div>

  <script>
    const { ref, reactive, computed, watch, nextTick } = Vue;

    // Helper functions (Simplified for example)
    const loadAll = () => {
        // Simulate loading from localStorage (or a database)
        const stored = localStorage.getItem('tripData');
        if (stored) {
            return JSON.parse(stored);
        }
        return {
            currentTab: '行程',
            selectedDay: 0,
            itinerary: new Array(365).fill(0).map(()=>[]),
            flights: [{ id: 1, flightNo: 'CX450', departureTime: '09:00', arrivalTime: '11:00' }],
            rate: { TWD_HKD: 0.25, lastUpdate: Date.now() },
            weather: { temp: 22, condition: 'Clear' },
        };
    };

    const saveAll = () => {
        const dataToSave = {
            currentTab: app.currentTab,
            selectedDay: app.selectedDay,
            itinerary: app.itinerary,
            flights: app.flights,
            rate: app.rate,
            weather: app.weather,
            // ... (other data like preTripNotes, shoppingList, expenses, infoList)
        };
        localStorage.setItem('tripData', JSON.stringify(dataToSave));
    };

    const fetchRate = () => { /* Simulate fetch */ };
    const fetchWeather = () => { /* Simulate fetch */ };

    const app = Vue.createApp({
        setup() {
        const data = reactive(loadAll());
        
        const currentTab = ref(data.currentTab);
        const selectedDay = ref(data.selectedDay);
        const itinerary = reactive(data.itinerary);
        const flights = reactive(data.flights);
        const rate = reactive(data.rate);
        const weather = reactive(data.weather);
        
        // Modal state
        const itineraryModalOpen = ref(false);
        const editingItineraryItem = ref(null);

        // **NEW: State for Google Map Location Module**
        const selectedMapAddress = ref('');
        const selectedLocationName = ref('');

        // Itinerary data structure (updated)
        const newItineraryItem = ref({
            dayIndex: selectedDay.value,
            time: '',
            title: '',
            location: '',
            googleMapAddress: '', // <-- NEW FIELD
            notes: '',
            done: false
        });

        // Days setup (Simulated for 7 days)
        const days = computed(() => Array.from({ length: 7 }, (_, i) => ({
            index: i,
            label: `Day ${i + 1}`
        })));

        // Select Day
        const selectDay = (index) => {
            selectedDay.value = index;
            // Clear location module when changing day
            selectedMapAddress.value = ''; 
        };
        
        // Itinerary Computed/Methods
        const sortedItinerary = computed(() => {
            if (itinerary[selectedDay.value]) {
                // Sort by time (simplified comparison)
                return itinerary[selectedDay.value].slice().sort((a, b) => (a.time > b.time) ? 1 : -1);
            }
            return [];
        });

        const openItineraryModal = (item = null) => {
            editingItineraryItem.value = item;
            if (item) {
                // Edit existing item
                newItineraryItem.value = { ...item };
            } else {
                // Add new item
                newItineraryItem.value = {
                    dayIndex: selectedDay.value,
                    time: '',
                    title: '',
                    location: '',
                    googleMapAddress: '', // <-- NEW FIELD reset
                    notes: '',
                    done: false
                };
            }
            itineraryModalOpen.value = true;
        };

        const closeItineraryModal = () => {
            itineraryModalOpen.value = false;
            editingItineraryItem.value = null;
        };

        const saveItineraryItem = () => {
            const dayList = itinerary[selectedDay.value];
            if (editingItineraryItem.value) {
                // Find and update the existing item in place
                const index = dayList.findIndex(i => i === editingItineraryItem.value);
                if (index !== -1) {
                    dayList[index] = { ...newItineraryItem.value };
                }
            } else {
                // Add new item
                dayList.push({ ...newItineraryItem.value });
            }
            closeItineraryModal();
            saveAll(); // Save after change
        };

        const removeItineraryItem = (item) => {
            if (confirm('確定要刪除此行程項目嗎？')) {
                const dayList = itinerary[selectedDay.value];
                const index = dayList.findIndex(i => i === item);
                if (index !== -1) {
                    dayList.splice(index, 1);
                }
                // Clear location module if the removed item was selected
                if (item.googleMapAddress === selectedMapAddress.value) {
                    selectedMapAddress.value = '';
                }
                saveAll(); // Save after change
            }
        };
        
        // **NEW: Function to select a location for the map module**
        const selectLocation = (item) => {
            // Only select if a Google Maps address is provided
            if (item.googleMapAddress && item.googleMapAddress.trim() !== '') {
                selectedMapAddress.value = item.googleMapAddress.trim();
                selectedLocationName.value = item.title || item.location || '未知地點';
            } else {
                selectedMapAddress.value = '';
                selectedLocationName.value = '';
            }
        };

        // **NEW: Computed properties for map links**
        const openMapLink = computed(() => {
            if (!selectedMapAddress.value) return '#';
            const encodedAddress = encodeURIComponent(selectedMapAddress.value);
            // Link to open the location (Search/View)
            return `https://maps.google.com/?q=${encodedAddress}`;
        });

        const navigateMapLink = computed(() => {
            if (!selectedMapAddress.value) return '#';
            const encodedAddress = encodeURIComponent(selectedMapAddress.value);
            // Link to start navigation (using directions API)
            return `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
        });

        // Other utility computed properties (Simplified)
        const activeFlight = computed(() => flights[0] || {});
        const shouldShowFlightCard = computed(() => currentTab.value === '行程' || currentTab.value === '機票/費用');
        const formattedRate = computed(() => `1 HKD ≈ ${rate.TWD_HKD.toFixed(3)} TWD`);
        const weatherIconClass = computed(() => {
             // Simplified icon logic
             return weather.condition === 'Clear' ? 'ph ph-sun-dim' : 'ph ph-cloud';
        });

        // Combined modal open for FAB (Simplified)
        const openAddModal = () => {
            if (currentTab.value === '行程') {
                openItineraryModal();
            }
            // ... (other tabs: shopping, info, flight modals would be here)
        };


        // Lifecycle & Watchers
        nextTick(() => {
          // Simulate initial data fetch
          fetchRate();
          fetchWeather();
          // setInterval(fetchRate, 10*60*1000); // Original
          // setInterval(fetchWeather, 10*60*1000); // Original
        });
        
        watch([currentTab, selectedDay, () => itinerary.map(d=>d.length), flights, rate, () => weather.temp], () => { 
          saveAll();
        }, { deep:true });
        
        // expose
        return {
          currentTab, days, selectedDay, selectDay,
          
          // Itinerary
          itinerary, sortedItinerary,
          itineraryModalOpen, newItineraryItem, openItineraryModal, closeItineraryModal, saveItineraryItem, removeItineraryItem,
          
          // **NEW** Map Module
          selectedMapAddress,
          selectedLocationName,
          selectLocation, // <-- NEW
          openMapLink,    // <-- NEW
          navigateMapLink,// <-- NEW

          // flight/weather/rate
          activeFlight, shouldShowFlightCard, weather, weatherIconClass, formattedRate,
          openAddModal,

          // Placeholder exposures for compile
          preTripNotes: [], newPreNote: {}, addPreNote:()=>{}, removePreNote:()=>{},
          shoppingList: [], shoppingModalOpen: false, newShoppingItem: {}, openShoppingModal:()=>{}, closeShoppingModal:()=>{}, saveShoppingItem:()=>{}, removeShoppingItem:()=>{}, isInstagramLink: false,
          expenses: [], newExpense: {}, addExpense:()=>{}, removeExpense:()=>{}, toggleExpenseDone:()=>{}, totalExpense: 0,
          infoList: [], infoModalOpen: false, newInfoItem: {}, openInfoModal:()=>{}, closeInfoModal:()=>{}, saveInfoItem:()=>{}, removeInfo:()=>{},
          flightModalOpen: false, newFlight: {}, openFlightModal:()=>{}, closeFlightModal:()=>{}, saveFlight:()=>{}, removeFlight:()=>{},
          lastRateUpdateLabel: '剛剛', // Placeholder
          rate: rate, // Expose for watcher
        };
        }
    }).mount('#app');
  </script>
</body>
</html>
