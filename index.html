<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync v5.09.1</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    /* --- iOS 26 System Variables --- */
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.65);
      --ios-card-border: rgba(255, 255, 255, 0.4);
      --ios-primary: #007AFF;
      --ios-danger: #FF3B30;
      --ios-warning: #FFCC00;
      --ios-success: #34C759;
      --glass-blur: blur(25px);
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    html { height: 100%; overscroll-behavior-y: none; }
    body {
      height: 100%;
      font-family: var(--font-stack);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background-color: #000;
      margin: 0;
      color: #000;
      overflow: hidden;
      user-select: none;
    }

    /* Scrollable Container */
    #app { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

    /* Main Scroll Area */
    main {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-top: 20px;
    }

    /* Utilities */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 100px); }
    
    /* --- Components --- */

    /* iOS Glass Card (Light) */
    .ios-card {
      background: var(--ios-card-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--ios-card-border);
      border-radius: 22px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      overflow: hidden;
    }

    /* iOS Premium Dark Glass Card (Flight/Expense) */
    .ios-card-dark-glass {
      background: rgba(22, 22, 24, 0.85);
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 26px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .dark-glass-gradient {
        position: absolute;
        top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle at 80% 20%, rgba(10, 132, 255, 0.25), transparent 60%);
        pointer-events: none; z-index: 0;
    }

    /* List Items */
    .ios-list-item {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      border-radius: 18px;
      margin-bottom: 8px; 
      padding: 14px;
      display: flex;
      align-items: center; 
      justify-content: space-between;
      transition: background 0.2s, transform 0.2s;
      border: 1px solid rgba(255,255,255,0.5);
      touch-action: manipulation;
    }
    .ios-list-item:active { background: rgba(255, 255, 255, 0.95); transform: scale(0.98); }

    /* Drag & Drop Styles */
    .sortable-ghost { opacity: 0.4; background: #e5e7eb; border: 1px dashed #9ca3af; }
    .sortable-drag { opacity: 1; background: #fff; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); transform: scale(1.02); z-index: 50; }
    
    /* Strict Drag Handle for iOS Stability */
    .drag-handle { 
        cursor: grab;
        padding: 10px; 
        margin: -10px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        touch-action: pan-y;
        -webkit-user-select: none;
        user-select: none;
    }
    
    #sortable-expenses { position: relative; z-index: 20; }
    
    /* Action Buttons */
    .action-btn-group {
        display: flex;
        align-items: center; gap: 4px; flex-shrink: 0; padding-left: 8px;
        opacity: 0.6; transition: opacity 0.2s;
    }
    .ios-list-item:hover .action-btn-group, .action-btn-group:active { opacity: 1; }
    .icon-btn { padding: 6px; color: #8E8E93; transition: color 0.2s; border-radius: 50%; }
    .icon-btn:hover { background: rgba(0,0,0,0.05); }
    .icon-btn.edit:hover { color: var(--ios-primary); }
    .icon-btn.delete:hover { color: var(--ios-danger); }

    /* Inputs */
    .ios-input {
      background: rgba(118, 118, 128, 0.12);
      border: none; border-radius: 12px; padding: 12px 16px;
      font-size: 17px; color: #000; width: 100%; box-sizing: border-box;
      transition: background 0.2s;
    }
    .ios-input:focus { background: rgba(118, 118, 128, 0.2); outline: none; }
    .ios-input::placeholder { color: #8E8E93; }

    /* Modals */
    .modal-backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); z-index: 100; }
    
    .ios-modal-container {
      background: rgba(250, 250, 250, 0.9);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 32px;
      display: flex; flex-direction: column;
      max-height: 92vh; width: 100%; max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.4);
    }

    .ios-modal-header { padding: 16px; text-align: center; font-weight: 600; font-size: 17px; border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; }
    .ios-modal-body { flex: 1; overflow-y: auto; padding: 24px; -webkit-overflow-scrolling: touch; }
    .ios-modal-body.calc-body { padding: 16px 16px 8px 16px; overflow-y: hidden; display: flex; flex-direction: column; } 
    .ios-modal-footer { padding: 16px 24px; border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; gap: 12px; flex-shrink: 0; background: rgba(255,255,255,0.5); }

    /* Buttons */
    .btn-ios-cancel {
      flex: 1; height: 50px; border-radius: 14px;
      background: rgba(118, 118, 128, 0.12);
      color: #000; font-weight: 600; font-size: 17px;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-ios-primary {
      flex: 1; height: 50px; border-radius: 14px;
      background: var(--ios-primary);
      color: white; font-weight: 600; font-size: 17px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 15px rgba(0, 122, 255, 0.4);
    }
    .btn-ios-primary:active { opacity: 0.8; transform: scale(0.98); }
    .btn-ios-primary:disabled { opacity: 0.5; box-shadow: none; }

    /* Calculator Buttons */
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex: 1; }
    .calc-btn {
        border-radius: 10px; background: white;
        font-size: 20px; font-weight: 500; color: #333;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: background 0.1s;
        height: 100%; min-height: 40px;
    }
    .calc-btn:active { background: #E5E5EA; }
    .calc-btn.op { background: #FF9500; color: white; font-weight: 600; }
    .calc-btn.op:active { background: #D47B00; }
    .calc-btn.top-op { background: #D1D1D6; color: black; }
    .calc-btn.top-op:active { background: #A0A0A5; }
    .calc-btn.done-btn { background: var(--ios-primary); color: white; font-size: 17px; font-weight: 600; }

    /* Dock */
    .iphone-dock {
      background: rgba(245, 245, 245, 0.75);
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      border-radius: 38px;
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      display: flex; justify-content: space-between; align-items: flex-end;
    }

    /* Tabs */
    .day-tab { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255,255,255,0.2); }
    .day-tab.active { background: rgba(255, 255, 255, 0.9); border-color: rgba(255,255,255,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.05); transform: translateY(-2px); }

    .task-done { text-decoration: line-through; color: #8E8E93; opacity: 0.7; }
    .rotate-icon { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    /* Flight Status */
    .status-ontime { color: var(--ios-success); background: rgba(52, 199, 89, 0.15); border: 1px solid rgba(52, 199, 89, 0.2); }
    .status-delayed { color: var(--ios-danger); background: rgba(255, 59, 48, 0.15); border: 1px solid rgba(255, 59, 48, 0.2); }
    .status-boarding { color: var(--ios-warning); background: rgba(255, 204, 0, 0.15); border: 1px solid rgba(255, 204, 0, 0.2); }
  </style>
</head>

<body>
  <div id="app">
    <div class="fixed inset-0 z-0 pointer-events-none">
      <img src="./IMG_6732.jpeg?auto=format&fit=crop&w=2000&q=80"
           class="w-full h-full object-cover blur-[4px] scale-105" alt="Taipei Background">
      <div class="absolute inset-0 bg-white/70 backdrop-blur-[2px]"></div>
    </div>

    <main class="relative z-10 no-scrollbar pb-safe px-5">
      <div class="flex items-center justify-between mb-8 mt-4">
        <div>
          <h1 class="text-[34px] leading-tight font-bold tracking-tight text-black drop-shadow-sm font-[SF Pro Display]">
            eMenu Taipei
          </h1>
          <div class="flex items-center gap-2 mt-0.5 pl-1">
            <span class="text-[9px] font-semibold text-gray-400/80 uppercase tracking-widest">{{ appVersion }}</span>
            <div class="flex items-center gap-2 bg-white/50 backdrop-blur-md px-2 py-0.5 rounded-full border border-black/5">
                <div class="w-1.5 h-1.5 rounded-full transition-colors duration-300"
                     :class="{
                        'bg-green-500': syncState === 'synced',
                        'bg-yellow-400': syncState === 'saving' || syncState === 'loading',
                        'bg-red-500': syncState === 'error'
                     }"></div>
                <span class="text-[10px] font-medium text-gray-500">{{ syncStatusText }}</span>
            </div>
             <button @click="forceReloadCloud" class="text-gray-400 hover:text-gray-600 transition p-1" title="Reload">
                <i class="ph ph-arrows-clockwise text-xs" :class="{'rotate-icon': syncState === 'loading'}"></i>
            </button>
          </div>
        </div>
      
        <div class="flex flex-col items-end text-right">
           <span class="text-[10px] font-bold text-[#007AFF] uppercase tracking-wide mb-0.5">即時匯率</span>
           <span class="text-[9px] font-bold text-gray-400 uppercase tracking-wide mb-0.5">HKD / TWD</span>
           <div class="text-2xl font-bold text-gray-800 tracking-tight font-mono leading-none my-0.5">
             {{ formattedRate }}
           </div>
           <div class="text-[9px] font-medium text-gray-500 mb-0.5 font-mono tracking-tight">(含2%手續費)</div>
           <div class="text-[9px] font-medium text-gray-400/80 font-mono tracking-tight">
                更新：{{ lastRateUpdateLabel }}
           </div>
        </div>
      </div>

      <div class="mb-8">
        <div class="flex justify-between gap-3 overflow-x-auto no-scrollbar py-1 px-1">
          <button @click="currentTab = '準備'" 
               class="day-tab flex-shrink-0 w-[20%] h-[76px] rounded-2xl flex flex-col items-center justify-center text-xs relative overflow-hidden group"
               :class="{ 'active': currentTab === '準備' }">
             <i class="ph ph-list-checks text-2xl mb-1 text-gray-400 transition-colors group-[.active]:text-[#007AFF]"></i>
             <span class="font-medium text-gray-500 group-[.active]:font-bold">準備</span>
          </button>
         
          <button v-for="(d, i) in days" :key="i"
                  @click="selectDay(i); currentTab = '行程'"
                  class="day-tab flex-shrink-0 w-[22%] h-[76px] rounded-2xl flex flex-col items-center justify-center relative overflow-hidden group"
                  :class="{ 'active': selectedDay === i && currentTab === '行程' }">
            <span class="text-[10px] font-bold uppercase text-gray-400 mb-0.5 group-[.active]:text-[#007AFF]">Day {{ i + 1 }}</span>
            <span class="text-[11px] font-medium text-gray-400 group-[.active]:text-gray-800">{{ d.week }}</span>
            <span class="text-lg font-bold mt-0.5 leading-none text-gray-600 group-[.active]:text-black">{{ d.date }}</span>
          </button>
        </div>
      </div>

      <div v-if="currentTab === '行程'" class="space-y-5 mb-6">
        <div class="ios-card p-5 relative">
          <div class="flex justify-between items-center">
            <div class="flex-1">
                 <div class="flex items-center gap-1.5 text-gray-500 mb-2">
                    <i class="ph ph-map-pin-simple-area text-xs"></i>
                    <span class="text-[11px] font-bold uppercase tracking-wider">台北市</span>
                </div>
                
                <div class="flex items-center gap-5"> 
                    <div class="text-[64px] leading-none font-light tracking-tighter text-black flex items-start">
                      {{ weather.temp }}<span class="text-4xl mt-1 font-normal">°</span>
                    </div>
                    
                    <div class="flex flex-col gap-0.5 pb-1">
                        <div class="flex items-center gap-1.5 text-xs font-semibold text-gray-500">
                             <span class="text-[10px] uppercase text-gray-400 font-bold w-6">體感</span>
                            <span class="text-gray-800">{{ weather.feelsLike }}°</span>
                        </div>
                        <div class="flex items-center gap-1.5 text-xs font-semibold text-gray-500">
                           <span class="text-[10px] uppercase text-gray-400 font-bold w-6">濕度</span>
                           <span class="text-gray-800">{{ weather.humidity }}%</span>
                        </div>
                        <div class="flex items-center gap-1.5 text-xs font-semibold text-gray-500">
                           <span class="text-[10px] uppercase text-gray-400 font-bold w-6">UV</span>
                           <span class="text-gray-800">{{ weather.uv }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-right pt-1 pl-2">
                <i :class="weatherIconClass" class="text-[4rem] text-gray-800/80 drop-shadow-sm"></i>
            </div>
          </div>
          
          <div class="mt-4 border-t border-gray-400/20 pt-3">
             <div class="flex flex-wrap items-center justify-between gap-y-2">
                 <div class="flex items-center gap-2">
                     <span class="text-lg font-bold text-gray-800 tracking-tight">{{ weather.desc }}</span>
                     <div class="flex items-center gap-1 text-[11px] font-bold text-[#007AFF] bg-blue-50/80 px-2 py-0.5 rounded-full border border-blue-100/50">
                        <i class="ph ph-drop-fill text-xs"></i> 降雨機率 {{ weather.rain }}%
                     </div>
                     <div v-if="weather.warning" class="flex items-center gap-1 text-xs font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded-full border border-red-100 animate-pulse">
                        <i class="ph ph-warning-fill"></i> {{ weather.warning }}
                     </div>
                 </div>
                 <div class="flex gap-2 text-sm font-semibold text-gray-700/80">
                      <span>H:{{ weather.max }}°</span>
                      <span>L:{{ weather.min }}°</span>
                 </div>
             </div>
          </div>
        </div>
      </div>

<div v-if="currentTab === '行程' && shouldShowFlightCard" class="mb-8">
        <div class="flex items-center justify-between mb-3 px-1">
          <div class="flex items-center gap-2">
            <i class="ph ph-airplane-tilt text-lg text-[#007AFF]"></i>
            <span class="text-[13px] font-bold text-gray-800 uppercase tracking-wider">航班動態</span>
          </div>
          <button @click="flightBoardStyle = (flightBoardStyle === 'hkg' ? 'ios' : 'hkg')" 
                  class="text-[10px] font-bold px-3 py-1 rounded-full border border-black/10 bg-white/50 text-gray-500 active:scale-95 transition">
            切換風格：{{ flightBoardStyle === 'hkg' ? '香港機場' : 'iOS 玻璃' }}
          </button>
        </div>

        <div :class="[
          'relative overflow-hidden transition-all duration-500',
          flightBoardStyle === 'hkg' ? 'hkg-flight-card' : 'ios-card-dark-glass p-6'
        ]">
          <div v-if="flightBoardStyle === 'ios'" class="dark-glass-gradient"></div>

          <div class="relative z-10 flex flex-col h-full">
            <div :class="flightBoardStyle === 'hkg' ? 'hkg-top-row' : 'flex justify-between items-start mb-6'">
              <div :class="flightBoardStyle === 'hkg' ? 'hkg-gate-info' : 'flex flex-col'">
                <span :class="flightBoardStyle === 'hkg' ? 'hkg-label' : 'text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1'">GATE</span>
                <span :class="flightBoardStyle === 'hkg' ? 'hkg-gate-num' : 'text-4xl font-black tracking-tighter'">{{ activeFlight.gate }}</span>
              </div>
              <div :class="flightBoardStyle === 'hkg' ? 'hkg-flight-info' : 'text-right'">
                <div :class="flightBoardStyle === 'hkg' ? 'hkg-flight-num-box' : 'text-xl font-bold tracking-tight mb-1'">{{ activeFlight.no }}</div>
                <div :class="flightBoardStyle === 'hkg' ? 'hkg-time-box' : 'text-[10px] font-medium text-gray-400 uppercase tracking-widest'">{{ activeFlight.time }} DEPARTURE</div>
              </div>
            </div>

            <div :class="flightBoardStyle === 'hkg' ? 'hkg-bottom-row' : 'flex justify-between items-end'">
              <div class="flex flex-col">
                <span :class="flightBoardStyle === 'hkg' ? 'hkg-loc-label' : 'text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1'">FROM</span>
                <span :class="flightBoardStyle === 'hkg' ? 'hkg-loc-name' : 'text-2xl font-bold tracking-tight'">{{ activeFlight.from }}</span>
              </div>
              
              <div :class="flightBoardStyle === 'hkg' ? 'hkg-arrow' : 'px-4 mb-1'">
                <i class="ph ph-caret-double-right text-xl" :class="flightBoardStyle === 'hkg' ? 'text-[#E9EB4F]' : 'text-blue-500'"></i>
              </div>

              <div class="flex flex-col items-center">
                <span :class="flightBoardStyle === 'hkg' ? 'hkg-loc-label' : 'text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1'">TO</span>
                <span :class="flightBoardStyle === 'hkg' ? 'hkg-loc-dest' : 'text-2xl font-bold tracking-tight text-blue-400'">{{ activeFlight.to }}</span>
              </div>

              <div :class="flightBoardStyle === 'hkg' ? 'hkg-status-box' : 'flex flex-col items-end'">
                 <span :class="[
                    flightBoardStyle === 'hkg' ? 'hkg-status-text' : 'px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ' + getStatusClass(activeFlight.status)
                 ]">
                   {{ activeFlight.status }}
                 </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <style>
        /* --- HKG Airport Gate Board Style --- */
        .hkg-flight-card {
            background-color: #353E53;
            border-radius: 4px;
            padding: 0;
            color: white;
            font-family: "Oswald", "Impact", sans-serif; /* 工業感字體預設 */
            box-shadow: none;
        }

        /* Top Row Style */
        .hkg-top-row {
            display: flex;
            align-items: stretch;
            border-bottom: 2px solid #353E53;
        }

        .hkg-gate-info {
            background-color: #353E53;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 100px;
        }

        .hkg-label {
            color: #FFFFFF;
            font-size: 12px;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .hkg-gate-num {
            color: #E9EB4F;
            font-size: 64px;
            font-weight: 900;
            line-height: 1;
            margin-top: -5px;
        }

        /* Flight & Time Info White Box */
        .hkg-flight-info {
            flex: 1;
            background-color: #FFFFFF;
            color: #000000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .hkg-flight-num-box {
            font-size: 32px;
            font-weight: 900;
            letter-spacing: -1px;
            line-height: 1;
        }

        .hkg-time-box {
            font-size: 14px;
            font-weight: 700;
            margin-top: 4px;
        }

        /* Bottom Row Style (Red Bar) */
        .hkg-bottom-row {
            background-color: #BF443B;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .hkg-loc-label {
            display: none; /* HKG 風格通常簡化不顯示標籤 */
        }

        .hkg-loc-name {
            color: #FFFFFF;
            font-size: 20px;
            font-weight: 700;
        }

        .hkg-loc-dest {
            color: #E9EB4F;
            font-size: 28px;
            font-weight: 900;
        }

        .hkg-arrow {
            display: flex;
            align-items: center;
        }

        .hkg-status-box {
            text-align: right;
        }

        .hkg-status-text {
            color: #FFFFFF;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 1px;
        }
      </style>

<div v-if="currentTab === '行程'" class="space-y-4">
        <div class="flex items-center justify-between px-1">
          <div class="flex items-center gap-2">
            <i class="ph ph-calendar-blank text-lg text-[#007AFF]"></i>
            <span class="text-[13px] font-bold text-gray-800 uppercase tracking-wider">今日行程</span>
          </div>
          <button @click="openItineraryModal()" class="text-[#007AFF] text-sm font-bold active:opacity-60">+ 新增</button>
        </div>

        <div id="sortable-itinerary" class="space-y-3">
          <div v-for="(item, idx) in sortedItinerary" :key="item.id" 
               class="ios-list-item flex-col items-stretch gap-3 relative group" :data-id="item.id">
            <div class="flex items-start justify-between">
              <div class="flex items-start gap-3">
                <div class="drag-handle mt-1">
                  <i class="ph ph-dots-six-vertical text-gray-300 text-xl"></i>
                </div>
                <div>
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-bold text-[#007AFF] font-mono bg-blue-50 px-1.5 py-0.5 rounded">{{ item.time }}</span>
                    <h3 class="font-bold text-gray-900">{{ item.title }}</h3>
                  </div>
                  <p class="text-sm text-gray-500 leading-snug">{{ item.desc }}</p>
                  <div v-if="item.location" @click="showLocationOnMap(item.location)" 
                       class="mt-2 flex items-center gap-1.5 text-[11px] font-bold text-gray-400 hover:text-[#007AFF] transition-colors cursor-pointer">
                    <i class="ph ph-map-pin-fill"></i>
                    <span>{{ item.location }}</span>
                  </div>
                </div>
              </div>
              <div class="action-btn-group">
                <button @click="openItineraryModal(item)" class="icon-btn edit"><i class="ph ph-pencil-simple"></i></button>
                <button @click="removeItineraryItem(item.id)" class="icon-btn delete"><i class="ph ph-trash"></i></button>
              </div>
            </div>
          </div>
        </div>

        <div class="flex gap-2 overflow-x-auto no-scrollbar py-2">
            <button v-for="q in quickItinerary" :key="q.title" @click="addQuickItinerary(q)"
                    class="flex-shrink-0 bg-white/60 backdrop-blur-md border border-white/40 px-4 py-2 rounded-full text-xs font-bold text-gray-600 active:scale-95 transition">
                + {{ q.title }}
            </button>
        </div>
      </div>

      <div v-if="currentTab === '準備'" class="space-y-6">
        <section>
          <div class="flex items-center justify-between mb-3 px-1">
            <div class="flex items-center gap-2">
              <i class="ph ph-check-square-offset text-lg text-[#007AFF]"></i>
              <span class="text-[13px] font-bold text-gray-800 uppercase tracking-wider">準備清單</span>
            </div>
            <button @click="preNoteModalOpen = true" class="text-[#007AFF] text-sm font-bold">+ 新增</button>
          </div>
          <div class="ios-card overflow-hidden">
            <div v-for="note in preTripNotes" :key="note.id" 
                 class="flex items-center justify-between p-4 border-b border-gray-100 last:border-0 active:bg-gray-50 transition"
                 @click.self="togglePreNoteDone(note)">
                <div class="flex items-center gap-3 flex-1" @click="togglePreNoteDone(note)">
                    <i :class="['ph text-xl', note.done ? 'ph-check-circle-fill text-green-500' : 'ph-circle text-gray-300']"></i>
                    <span :class="['text-[15px] font-medium transition-all', note.done ? 'task-done' : 'text-gray-800']">{{ note.content }}</span>
                </div>
                <div class="flex gap-1">
                    <button @click="editPreNote(note)" class="p-2 text-gray-400 hover:text-[#007AFF]"><i class="ph ph-pencil-simple text-lg"></i></button>
                    <button @click="removePreNote(note.id)" class="p-2 text-gray-400 hover:text-red-500"><i class="ph ph-trash text-lg"></i></button>
                </div>
            </div>
            <div v-if="preTripNotes.length === 0" class="p-8 text-center text-gray-400 text-sm">尚無準備事項</div>
          </div>
        </section>

        <section>
          <div class="flex items-center justify-between mb-3 px-1">
            <div class="flex items-center gap-2">
              <i class="ph ph-bag-simple text-lg text-[#FF2D55]"></i>
              <span class="text-[13px] font-bold text-gray-800 uppercase tracking-wider">採購清單</span>
            </div>
            <button @click="openShoppingModal()" class="text-[#FF2D55] text-sm font-bold">+ 新增</button>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div v-for="item in shoppingList" :key="item.id" class="ios-card p-3 relative group">
                <div v-if="item.imageUrl" class="aspect-square rounded-xl mb-2 overflow-hidden bg-gray-100 cursor-zoom-in" @click="openImageViewer(item.imageUrl)">
                    <img :src="item.imageUrl" class="w-full h-full object-cover">
                </div>
                <div v-else class="aspect-square rounded-xl mb-2 bg-gray-50 flex items-center justify-center border border-dashed border-gray-200">
                    <i class="ph ph-image text-gray-300 text-3xl"></i>
                </div>
                <h4 class="font-bold text-sm text-gray-800 mb-1 truncate">{{ item.name }}</h4>
                <div class="flex items-center justify-between">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Budget: ${{ item.price }}</span>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button @click="openShoppingModal(item)" class="text-gray-400 hover:text-blue-500"><i class="ph ph-pencil-simple"></i></button>
                        <button @click="removeShoppingItem(item.id)" class="text-gray-400 hover:text-red-500"><i class="ph ph-trash"></i></button>
                    </div>
                </div>
            </div>
          </div>
        </section>
      </div>

      <div v-if="currentTab === '行程'" class="mt-10 space-y-4">
          <div class="flex items-center justify-between px-1">
            <div class="flex flex-col">
               <div class="flex items-center gap-2">
                <i class="ph ph-credit-card text-lg text-[#34C759]"></i>
                <span class="text-[13px] font-bold text-gray-800 uppercase tracking-wider">開支記錄</span>
              </div>
              <div class="text-[10px] font-bold text-gray-400 mt-0.5">TOTAL: <span class="text-[#34C759]">NT$ {{ formatNumber(totalExpense) }}</span></div>
            </div>
            <button @click="openExpenseModal()" class="bg-[#34C759] text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg shadow-green-500/30 active:scale-95 transition">+ 記帳</button>
          </div>

          <div class="flex gap-2 mb-2 overflow-x-auto no-scrollbar">
              <button v-for="cat in expenseCats" :key="cat" @click="expenseFilter = cat"
                      :class="['flex-shrink-0 px-3 py-1 rounded-full text-[11px] font-bold transition', 
                               expenseFilter === cat ? 'bg-gray-800 text-white' : 'bg-white/50 text-gray-500 border border-black/5']">
                  {{ cat }}
              </button>
          </div>

          <div id="sortable-expenses" class="space-y-2">
            <div v-for="exp in filteredExpenses" :key="exp.id" 
                 class="ios-list-item py-3 px-4" :data-id="exp.id">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-xl">
                  {{ getCategoryIcon(exp.category) }}
                </div>
                <div>
                  <div class="font-bold text-gray-900">{{ exp.item }}</div>
                  <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{{ exp.category }} • {{ exp.payer }}</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="text-right">
                  <div class="font-mono font-bold text-gray-900">NT$ {{ formatNumber(exp.amount) }}</div>
                  <div class="text-[10px] font-medium text-gray-400">≈ HK$ {{ formatNumber(exp.amount / rate) }}</div>
                </div>
                <div class="action-btn-group">
                  <button @click="openExpenseModal(exp)" class="icon-btn edit"><i class="ph ph-pencil-simple"></i></button>
                  <button @click="removeExpense(exp.id)" class="icon-btn delete"><i class="ph ph-trash"></i></button>
                </div>
              </div>
            </div>
            <div v-if="filteredExpenses.length === 0" class="py-10 text-center text-gray-400 text-sm bg-white/30 rounded-3xl border border-dashed border-black/5">暫無此類開支</div>
          </div>
      </div>

<div v-if="currentTab === '行程'" class="mt-10 mb-20">
        <div class="flex items-center justify-between mb-3 px-1">
          <div class="flex items-center gap-2">
            <i class="ph ph-info text-lg text-gray-600"></i>
            <span class="text-[13px] font-bold text-gray-800 uppercase tracking-wider">實用資訊</span>
          </div>
          <button @click="openInfoModal()" class="text-gray-500 text-sm font-bold">+ 新增</button>
        </div>
        <div class="grid grid-cols-1 gap-3">
          <div v-for="info in infoList" :key="info.id" class="ios-card p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
               <div class="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center text-xl text-gray-500">
                  <i :class="['ph', info.icon || 'ph-note-text']"></i>
               </div>
               <div>
                  <div class="font-bold text-gray-900">{{ info.title }}</div>
                  <div class="text-xs text-gray-500">{{ info.content }}</div>
               </div>
            </div>
            <div class="flex gap-1">
               <button @click="openInfoModal(info)" class="icon-btn edit"><i class="ph ph-pencil-simple"></i></button>
               <button @click="removeInfo(info.id)" class="icon-btn delete"><i class="ph ph-trash"></i></button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="fixed bottom-8 left-5 right-5 z-50">
      <div class="iphone-dock">
        <button v-for="tab in ['行程', '準備']" :key="tab" @click="currentTab = tab"
                class="flex flex-col items-center gap-1 transition-all duration-300 relative px-4 py-1"
                :class="currentTab === tab ? 'scale-110' : 'opacity-40 scale-95'">
          <div :class="['w-12 h-12 rounded-2xl flex items-center justify-center text-2xl shadow-sm', 
                       tab === '行程' ? 'bg-gradient-to-br from-blue-400 to-blue-600 text-white' : 'bg-gradient-to-br from-pink-400 to-pink-600 text-white']">
             <i :class="tab === '行程' ? 'ph ph-map-trifold' : 'ph ph-suitcase'"></i>
          </div>
          <span class="text-[10px] font-extrabold text-black uppercase tracking-tighter">{{ tab }}</span>
          <div v-if="currentTab === tab" class="absolute -bottom-2 w-1 h-1 bg-black rounded-full"></div>
        </button>
        
        <button @click="openAddModal" class="flex flex-col items-center gap-1 opacity-100 px-4 py-1 active:scale-90 transition">
           <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center text-3xl shadow-lg border border-black/5">
             <i class="ph ph-plus-circle text-gray-900"></i>
           </div>
           <span class="text-[10px] font-extrabold text-black uppercase tracking-tighter">新增</span>
        </button>

        <button @click="openMemberModal" class="flex flex-col items-center gap-1 transition-all duration-300 px-4 py-1 opacity-40 hover:opacity-100">
           <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center text-2xl shadow-sm text-white">
             <i class="ph ph-users"></i>
           </div>
           <span class="text-[10px] font-extrabold text-black uppercase tracking-tighter">成員</span>
        </button>
      </div>
    </div>

    <transition name="fade">
      <div v-if="itineraryModalOpen || expenseModalOpen || shoppingModalOpen || preNoteModalOpen || infoModalOpen || flightModalOpen || memberModalOpen" 
           class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[100]">
        
        <div v-if="flightModalOpen" class="ios-modal-container">
           <div class="ios-modal-header">航班資訊設置</div>
           <div class="ios-modal-body space-y-4">
              <label class="block"><span class="text-xs font-bold text-gray-400 ml-1">GATE</span><input v-model="newFlight.gate" class="ios-input" placeholder="e.g. B7"></label>
              <label class="block"><span class="text-xs font-bold text-gray-400 ml-1">FLIGHT NO.</span><input v-model="newFlight.no" class="ios-input" placeholder="e.g. BR870"></label>
              <label class="block"><span class="text-xs font-bold text-gray-400 ml-1">TIME</span><input v-model="newFlight.time" class="ios-input" placeholder="e.g. 15:40"></label>
              <div class="grid grid-cols-2 gap-3">
                 <label class="block"><span class="text-xs font-bold text-gray-400 ml-1">FROM</span><input v-model="newFlight.from" class="ios-input" placeholder="HKG"></label>
                 <label class="block"><span class="text-xs font-bold text-gray-400 ml-1">TO</span><input v-model="newFlight.to" class="ios-input" placeholder="TPE"></label>
              </div>
              <label class="block"><span class="text-xs font-bold text-gray-400 ml-1">STATUS</span><input v-model="newFlight.status" class="ios-input" placeholder="e.g. ON TIME"></label>
           </div>
           <div class="ios-modal-footer">
              <button @click="closeFlightModal" class="btn-ios-cancel">取消</button>
              <button @click="saveFlight" class="btn-ios-primary">儲存</button>
           </div>
        </div>

        <div v-if="itineraryModalOpen" class="ios-modal-container">
           <div class="ios-modal-header">{{ editingItineraryId ? '編輯行程' : '新增行程' }}</div>
           <div class="ios-modal-body space-y-4">
              <input v-model="newItineraryItem.time" class="ios-input" type="time">
              <input v-model="newItineraryItem.title" class="ios-input" placeholder="標題">
              <textarea v-model="newItineraryItem.desc" class="ios-input h-24" placeholder="描述內容"></textarea>
              <input v-model="newItineraryItem.location" class="ios-input" placeholder="地點名稱 (Google Maps)">
           </div>
           <div class="ios-modal-footer">
              <button @click="closeItineraryModal" class="btn-ios-cancel">取消</button>
              <button @click="saveItineraryItem" class="btn-ios-primary">儲存</button>
           </div>
        </div>

        <div v-if="expenseModalOpen" class="ios-modal-container">
           <div class="ios-modal-header">{{ editingExpenseId ? '編輯開支' : '新增開支' }}</div>
           <div class="ios-modal-body calc-body">
              <div class="mb-4">
                  <div class="flex items-center justify-between mb-2">
                      <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">AMOUNT (TWD)</span>
                      <span class="text-xs font-bold text-blue-500 font-mono">≈ HKD {{ formatNumber(newExpense.amount / rate) }}</span>
                  </div>
                  <div class="ios-input text-right text-3xl font-mono font-bold py-4 min-h-[68px] overflow-hidden">
                    {{ newExpense.amount || 0 }}
                  </div>
              </div>
              <div class="calc-grid mb-4">
                  <button v-for="n in ['7','8','9','/','4','5','6','*','1','2','3','-','0','.','C','+']" 
                          :key="n" @click="handleCalcInput(n)"
                          :class="['calc-btn', ['/','*','-','+'].includes(n) ? 'op' : ['C'].includes(n) ? 'top-op' : '']">
                      {{ n === '*' ? '×' : n === '/' ? '÷' : n }}
                  </button>
              </div>
              <div class="grid grid-cols-2 gap-3 mb-4">
                  <select v-model="newExpense.category" class="ios-input text-sm">
                      <option v-for="c in expenseCats.slice(1)" :key="c" :value="c">{{ c }}</option>
                  </select>
                  <select v-model="newExpense.payer" class="ios-input text-sm">
                      <option v-for="m in members" :key="m.name" :value="m.name">{{ m.name }}</option>
                  </select>
              </div>
              <input v-model="newExpense.item" class="ios-input mb-4" placeholder="消費項目內容">
              
              <div class="mb-4">
                  <div class="flex items-center justify-between px-1 mb-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">分攤成員</span>
                    <button @click="toggleAllParticipants" class="text-[10px] font-bold text-blue-500">全選/不選</button>
                  </div>
                  <div class="flex flex-wrap gap-2">
                      <button v-for="m in members" :key="m.name" 
                              @click="toggleParticipant(m.name)"
                              :class="['px-3 py-1.5 rounded-full text-xs font-bold transition border', 
                                       newExpense.participants.includes(m.name) ? 'bg-blue-500 text-white border-blue-500 shadow-md' : 'bg-white text-gray-400 border-gray-100']">
                          {{ m.name }}
                      </button>
                  </div>
              </div>
           </div>
           <div class="ios-modal-footer">
              <button @click="closeExpenseModal" class="btn-ios-cancel">取消</button>
              <button @click="saveExpense" class="btn-ios-primary">完成儲存</button>
           </div>
        </div>
        
        <div v-if="shoppingModalOpen" class="ios-modal-container">
            <div class="ios-modal-header">新增採購項目</div>
            <div class="ios-modal-body space-y-4 text-center">
                <div @click="$refs.fileInput.click()" class="w-full aspect-video bg-gray-100 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed border-gray-200 cursor-pointer overflow-hidden relative">
                    <img v-if="tempUploadPreview" :src="tempUploadPreview" class="w-full h-full object-cover">
                    <div v-else class="flex flex-col items-center">
                        <i class="ph ph-cloud-arrow-up text-4xl text-gray-300 mb-2"></i>
                        <span class="text-xs font-bold text-gray-400">{{ isUploading ? '上傳中...' : '點擊上傳商品圖片' }}</span>
                    </div>
                </div>
                <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleFileUpload">
                <input v-model="newShoppingItem.name" class="ios-input" placeholder="商品名稱">
                <input v-model="newShoppingItem.price" class="ios-input" type="number" placeholder="預期價格 (TWD)">
            </div>
            <div class="ios-modal-footer">
                <button @click="closeShoppingModal" class="btn-ios-cancel">取消</button>
                <button @click="saveShoppingItem" class="btn-ios-primary">儲存</button>
            </div>
        </div>

        <div v-if="preNoteModalOpen" class="ios-modal-container">
            <div class="ios-modal-header">新增準備事項</div>
            <div class="ios-modal-body">
                <input v-model="newPreNote" class="ios-input" placeholder="需要做什麼？" @keyup.enter="savePreNoteEdit">
            </div>
            <div class="ios-modal-footer">
                <button @click="closePreNoteModal" class="btn-ios-cancel">取消</button>
                <button @click="savePreNoteEdit" class="btn-ios-primary">儲存</button>
            </div>
        </div>

        <div v-if="memberModalOpen" class="ios-modal-container">
            <div class="ios-modal-header">團隊成員</div>
            <div class="ios-modal-body space-y-4">
                <div class="flex gap-2">
                    <input v-model="newMemberName" class="ios-input" placeholder="成員名稱" @keyup.enter="addMember">
                    <button @click="addMember" class="btn-ios-primary w-20 flex-shrink-0">加入</button>
                </div>
                <div class="space-y-2">
                    <div v-for="m in members" :key="m.id" class="flex items-center justify-between p-3 bg-white/50 rounded-xl">
                        <span class="font-bold text-gray-800">{{ m.name }}</span>
                        <button @click="removeMember(m.id)" class="text-red-500"><i class="ph ph-user-minus text-xl"></i></button>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-100">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 px-1">結算狀態</h4>
                    <div v-for="s in settlementList" :key="s.name" class="p-4 bg-gray-50 rounded-2xl mb-2 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-gray-900">{{ s.name }}</div>
                            <div class="text-[10px] font-bold text-gray-400">總計支付: NT$ {{ formatNumber(s.paid) }}</div>
                        </div>
                        <div class="text-right">
                            <div :class="['font-mono font-bold', s.balance >= 0 ? 'text-green-500' : 'text-red-500']">
                                {{ s.balance >= 0 ? '+' : '' }}{{ formatNumber(s.balance) }}
                            </div>
                            <div class="text-[10px] font-medium text-gray-400">NTD</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ios-modal-footer">
                <button @click="closeMemberModal" class="btn-ios-cancel w-full">關閉</button>
            </div>
        </div>

      </div>
    </transition>

    <transition name="fade">
      <div v-if="addModalOpen" class="fixed inset-0 z-[110] flex flex-col justify-end p-5 bg-black/40 backdrop-blur-sm" @click.self="addModalOpen = false">
          <div class="ios-card p-2 space-y-1 bg-white/90">
              <button @click="openItineraryModal(); addModalOpen = false" class="w-full p-4 flex items-center gap-4 hover:bg-gray-50 transition rounded-xl">
                  <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center text-xl"><i class="ph ph-calendar-blank"></i></div>
                  <span class="font-bold text-gray-800">新增行程項目</span>
              </button>
              <button @click="openExpenseModal(); addModalOpen = false" class="w-full p-4 flex items-center gap-4 hover:bg-gray-50 transition rounded-xl">
                  <div class="w-10 h-10 rounded-full bg-green-100 text-green-500 flex items-center justify-center text-xl"><i class="ph ph-credit-card"></i></div>
                  <span class="font-bold text-gray-800">新增開支記錄</span>
              </button>
              <button @click="openShoppingModal(); addModalOpen = false" class="w-full p-4 flex items-center gap-4 hover:bg-gray-50 transition rounded-xl">
                  <div class="w-10 h-10 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center text-xl"><i class="ph ph-bag-simple"></i></div>
                  <span class="font-bold text-gray-800">新增採購清單</span>
              </button>
              <button @click="openFlightModal(); addModalOpen = false" class="w-full p-4 flex items-center gap-4 hover:bg-gray-50 transition rounded-xl">
                  <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center text-xl"><i class="ph ph-airplane"></i></div>
                  <span class="font-bold text-gray-800">更新航班資訊</span>
              </button>
          </div>
          <button @click="addModalOpen = false" class="mt-4 w-full bg-white h-14 rounded-2xl font-bold text-gray-500 active:scale-95 transition">取消</button>
      </div>
    </transition>

    <transition name="fade">
        <div v-if="imageViewer.show" class="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-4" @click="imageViewer.show = false">
            <img :src="imageViewer.url" class="max-w-full max-h-full object-contain shadow-2xl">
            <button class="absolute top-10 right-10 text-white text-3xl opacity-50"><i class="ph ph-x-circle"></i></button>
        </div>
    </transition>
  </div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    // --- Configuration & Supabase Init ---
    const SUPABASE_URL = 'https://your-project-url.supabase.co';
    const SUPABASE_KEY = 'your-anon-key';
    const supabase = reflections.supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

    createApp({
      setup() {
        // App State
        const appVersion = 'v251220-5.09.1';
        const syncState = ref('synced'); // synced, saving, loading, error
        const currentTab = ref('行程');
        const selectedDay = ref(0);
        const addModalOpen = ref(false);

        // Days Configuration
        const days = [
          { date: '21', week: 'SAT', full: '2025-12-21' },
          { date: '22', week: 'MON', full: '2025-12-22' },
          { date: '23', week: 'TUE', full: '2025-12-23' },
          { date: '24', week: 'WED', full: '2025-12-24' },
          { date: '25', week: 'THU', full: '2025-12-25' }
        ];

        // --- Weather State (Mock or API) ---
        const weather = ref({
          temp: 22, feelsLike: 21, humidity: 65, uv: '低',
          desc: '局部多雲', rain: 10, max: 24, min: 18,
          icon: 'cloud-sun', warning: null
        });

        const weatherIconClass = computed(() => `ph ph-${weather.value.icon}-fill`);

        // --- Exchange Rate Logic ---
        const rate = ref(4.12); 
        const lastUpdate = ref(new Date());
        const formattedRate = computed(() => rate.value.toFixed(2));
        const lastRateUpdateLabel = computed(() => lastUpdate.value.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));

        // --- Flight State ---
        const flightBoardStyle = ref('hkg');
        const activeFlight = ref({
            gate: 'B7', no: 'BR870', time: '15:40', 
            from: 'HKG', to: 'TPE', status: 'ON TIME'
        });
        const flightModalOpen = ref(false);
        const newFlight = ref({ ...activeFlight.value });

        const shouldShowFlightCard = computed(() => {
            if (selectedDay.value === 0) return true; // Day 1
            if (selectedDay.value === 4) return true; // Day 5
            return false;
        });

        const getStatusClass = (status) => {
            const s = status.toUpperCase();
            if (s.includes('ON TIME')) return 'status-ontime';
            if (s.includes('DELAY')) return 'status-delayed';
            if (s.includes('BOARD') || s.includes('GATE')) return 'status-boarding';
            return 'bg-gray-100 text-gray-500';
        };

        // --- Itinerary Logic ---
        const itineraryModalOpen = ref(false);
        const editingItineraryId = ref(null);
        const itineraryItems = ref([]); // From DB
        const newItineraryItem = ref({ time: '12:00', title: '', desc: '', location: '' });
        
        const sortedItinerary = computed(() => {
            return itineraryItems.value
                .filter(item => item.day_index === selectedDay.value)
                .sort((a, b) => a.time.localeCompare(b.time));
        });

        const quickItinerary = [
            { title: '🍴 午餐', desc: '在地美食' },
            { title: '☕ 下午茶', desc: '休息一下' },
            { title: '🛍️ 逛街', desc: '西門町/中山' },
            { title: '✨ 景點', desc: '拍照留念' }
        ];

        // --- Expense Logic ---
        const expenseModalOpen = ref(false);
        const editingExpenseId = ref(null);
        const expenses = ref([]);
        const expenseFilter = ref('全部');
        const expenseCats = ['全部', '餐飲', '交通', '購物', '住宿', '景點', '其他'];
        const newExpense = ref({ amount: '', item: '', category: '餐飲', payer: '阿強', participants: [] });

        const filteredExpenses = computed(() => {
            let list = expenses.value.filter(e => e.day_index === selectedDay.value);
            if (expenseFilter.value !== '全部') {
                list = list.filter(e => e.category === expenseFilter.value);
            }
            return list;
        });

        const totalExpense = computed(() => {
            return filteredExpenses.value.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
        });

        // --- Member & Settlement Logic ---
        const memberModalOpen = ref(false);
        const members = ref([{ id: 1, name: '阿強' }, { id: 2, name: '小明' }]);
        const newMemberName = ref('');

        const settlementList = computed(() => {
            const results = {};
            members.value.forEach(m => results[m.name] = { name: m.name, paid: 0, debt: 0 });
            
            expenses.value.forEach(exp => {
                // Paid by someone
                if (results[exp.payer]) results[exp.payer].paid += parseFloat(exp.amount);
                
                // Split among participants
                const parts = exp.participants || [];
                if (parts.length > 0) {
                    const share = parseFloat(exp.amount) / parts.length;
                    parts.forEach(p => {
                        if (results[p]) results[p].debt += share;
                    });
                }
            });

            return Object.values(results).map(r => ({
                ...r,
                balance: r.paid - r.debt
            }));
        });

        // --- Preparation & Shopping ---
        const preNoteModalOpen = ref(false);
        const preTripNotes = ref([]);
        const newPreNote = ref('');
        const shoppingModalOpen = ref(false);
        const shoppingList = ref([]);
        const newShoppingItem = ref({ name: '', price: '', imageUrl: '' });
        const isUploading = ref(false);
        const tempUploadPreview = ref(null);

        // --- Info Cards ---
        const infoModalOpen = ref(false);
        const infoList = ref([
            { id: 1, title: '飯店地址', content: '台北市信義區...', icon: 'ph-house' },
            { id: 2, title: '保險單號', content: 'ZA-12345678', icon: 'ph-shield-check' }
        ]);
        const newInfoItem = ref({ title: '', content: '', icon: 'ph-note-text' });

        // --- Image Viewer ---
        const imageViewer = ref({ show: false, url: '' });

        // (下段將繼續完成各項 Methods 的實作代碼)

// --- Core Methods ---
        const formatNumber = (num) => {
            return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        };

        const selectDay = (index) => {
            selectedDay.value = index;
            // 可在此加入切換天數時的自動載入邏輯
        };

        // Calculator Logic
        const handleCalcInput = (key) => {
            if (key === 'C') {
                newExpense.value.amount = '';
            } else if (['+','-','*','/'].includes(key)) {
                newExpense.value.amount += key;
            } else if (key === '.') {
                if (!newExpense.value.amount.includes('.')) newExpense.value.amount += '.';
            } else {
                newExpense.value.amount += key;
            }
        };

        // Participant Logic
        const toggleParticipant = (name) => {
            const idx = newExpense.value.participants.indexOf(name);
            if (idx > -1) newExpense.value.participants.splice(idx, 1);
            else newExpense.value.participants.push(name);
        };

        const toggleAllParticipants = () => {
            if (newExpense.value.participants.length === members.value.length) {
                newExpense.value.participants = [];
            } else {
                newExpense.value.participants = members.value.map(m => m.name);
            }
        };

        // Map Jump
        const showLocationOnMap = (loc) => {
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;
            window.open(url, '_blank');
        };

        // File Upload (Supabase Storage)
        const handleFileUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            isUploading.value = true;
            tempUploadPreview.value = URL.createObjectURL(file);
            
            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const filePath = `shopping/${fileName}`;

                let { error: uploadError } = await supabase.storage
                    .from('travel-images')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                const { data } = supabase.storage.from('travel-images').getPublicUrl(filePath);
                newShoppingItem.value.imageUrl = data.publicUrl;
            } catch (error) {
                alert('上傳失敗: ' + error.message);
            } finally {
                isUploading.value = false;
            }
        };

        const openImageViewer = (url) => {
            imageViewer.value.url = url;
            imageViewer.value.show = true;
        };

        // --- Data Persistence (Supabase Sync) ---
        const syncStatusText = computed(() => {
            if (syncState.value === 'synced') return '已同步';
            if (syncState.value === 'saving') return '儲存中...';
            if (syncState.value === 'loading') return '載入中...';
            return '連線錯誤';
        });

        const forceReloadCloud = async () => {
            syncState.value = 'loading';
            try {
                // Fetch Itinerary
                const { data: itins } = await supabase.from('itinerary').select('*');
                itineraryItems.value = itins || [];
                
                // Fetch Expenses
                const { data: exps } = await supabase.from('expenses').select('*');
                expenses.value = exps || [];

                // Fetch Pre-trip Notes
                const { data: notes } = await supabase.from('pre_notes').select('*');
                preTripNotes.value = notes || [];

                syncState.value = 'synced';
            } catch (e) {
                syncState.value = 'error';
            }
        };

        // Save Logic (Example for Expense)
        const saveExpense = async () => {
            syncState.value = 'saving';
            // 處理計算機表達式 eval (簡單實作)
            try {
                const finalAmount = eval(newExpense.value.amount.replace('×','*').replace('÷','/')) || 0;
                newExpense.value.amount = finalAmount;
                
                const payload = {
                    ...newExpense.value,
                    day_index: selectedDay.value,
                    updated_at: new Date()
                };

                const { error } = await supabase.from('expenses').upsert(payload);
                if (error) throw error;
                
                await forceReloadCloud();
                closeExpenseModal();
            } catch (e) {
                alert('儲存失敗');
                syncState.value = 'error';
            }
        };

        // --- Drag & Drop Initialization ---
        const initSortable = () => {
            const el = document.getElementById('sortable-itinerary');
            if (el) {
                Sortable.create(el, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: async (evt) => {
                        // 此處可實作排序更新至 Supabase 的邏輯
                        console.log('Reordered', evt.oldIndex, 'to', evt.newIndex);
                    }
                });
            }
        };

        // --- Lifecycle Hooks ---
        onMounted(() => {
            forceReloadCloud();
            nextTick(() => {
                initSortable();
            });
        });

        // --- Modal Open/Close Toggles ---
        const openAddModal = () => { addModalOpen.value = true; };
        const openFlightModal = () => { flightModalOpen.value = true; };
        const closeFlightModal = () => { flightModalOpen.value = false; };
        const openItineraryModal = (item = null) => {
            if (item) {
                newItineraryItem.value = { ...item };
                editingItineraryId.value = item.id;
            } else {
                newItineraryItem.value = { time: '12:00', title: '', desc: '', location: '' };
                editingItineraryId.value = null;
            }
            itineraryModalOpen.value = true;
        };
        const closeItineraryModal = () => { itineraryModalOpen.value = false; };
        const openExpenseModal = (exp = null) => {
            if (exp) {
                newExpense.value = { ...exp };
                editingExpenseId.value = exp.id;
            } else {
                newExpense.value = { amount: '', item: '', category: '餐飲', payer: '阿強', participants: members.value.map(m=>m.name) };
                editingExpenseId.value = null;
            }
            expenseModalOpen.value = true;
        };
        const closeExpenseModal = () => { expenseModalOpen.value = false; };
        const openShoppingModal = (item = null) => {
            newShoppingItem.value = item ? { ...item } : { name: '', price: '', imageUrl: '' };
            tempUploadPreview.value = item?.imageUrl || null;
            shoppingModalOpen.value = true;
        };
        const closeShoppingModal = () => { shoppingModalOpen.value = false; };
        const openMemberModal = () => { memberModalOpen.value = true; };
        const closeMemberModal = () => { memberModalOpen.value = false; };

        return {
            appVersion, syncState, syncStatusText, currentTab, days, selectedDay, selectDay,
            weather, weatherIconClass, rate, formattedRate, lastRateUpdateLabel, forceReloadCloud,
            activeFlight, flightBoardStyle, flightModalOpen, newFlight, shouldShowFlightCard, getStatusClass,
            itineraryItems, sortedItinerary, quickItinerary, itineraryModalOpen, newItineraryItem, editingItineraryId,
            expenses, totalExpense, filteredExpenses, expenseFilter, expenseCats, expenseModalOpen, newExpense, editingExpenseId,
            members, newMemberName, memberModalOpen, settlementList,
            preTripNotes, preNoteModalOpen, newPreNote, shoppingList, shoppingModalOpen, newShoppingItem,
            isUploading, tempUploadPreview, imageViewer, infoList, infoModalOpen, addModalOpen,
            formatNumber, handleCalcInput, toggleParticipant, toggleAllParticipants, showLocationOnMap,
            handleFileUpload, openImageViewer, saveExpense, openAddModal, openFlightModal, closeFlightModal,
            openItineraryModal, closeItineraryModal, openExpenseModal, closeExpenseModal,
            openShoppingModal, closeShoppingModal, openMemberModal, closeMemberModal
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
