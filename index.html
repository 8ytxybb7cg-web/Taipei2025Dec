<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync v5.09a</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    /* --- iOS 26 System Variables --- */
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.65);
      --ios-card-border: rgba(255, 255, 255, 0.4);
      --ios-primary: #007AFF;
      --ios-danger: #FF3B30;
      --ios-warning: #FFCC00;
      --ios-success: #34C759;
      --glass-blur: 20px;
    }

    body {
      background-color: #000;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      color: #fff;
      margin: 0;
      padding-bottom: 40px;
      -webkit-tap-highlight-color: transparent;
    }

    /* Background Gradient */
    .bg-gradient-mesh {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at 0% 0%, #1a2a6c, #b21f1f, #fdbb2d);
      z-index: -1;
      opacity: 0.6;
    }
    
    /* Glassmorphism Utilities */
    .glass-panel {
      background: rgba(30, 30, 30, 0.6);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }

    .glass-card {
      background: rgba(50, 50, 50, 0.5);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
    }

    /* Modal Transitions */
    .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
    .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 0px; background: transparent; }

    /* Inputs */
    input, select, textarea {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--ios-primary);
      background: rgba(255, 255, 255, 0.15);
    }
    
    /* HKIA Style Specifics */
    .hkia-shadow {
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .hkia-text-glow {
      text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
    }
  </style>
</head>
<body class="text-white">
  <div id="app" class="max-w-md mx-auto relative min-h-screen pb-24">
    <div class="bg-gradient-mesh"></div>

    <header class="sticky top-0 z-40 px-6 py-4 flex justify-between items-center glass-panel rounded-b-3xl">
      <div>
        <h1 class="text-xs font-bold text-gray-400 tracking-wider uppercase">Travel Sync</h1>
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
           v251220-5.09a
           <span v-if="isUploading" class="animate-pulse text-xs text-blue-400">Syncing...</span>
        </h2>
      </div>
      <div class="flex gap-3">
        <button @click="openAddModal" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition backdrop-blur-md">
           <i class="ph ph-plus text-xl text-blue-300"></i>
        </button>
        <button @click="openMemberModal" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition backdrop-blur-md relative">
           <i class="ph ph-users text-xl text-purple-300"></i>
           <span v-if="members.length > 0" class="absolute -top-1 -right-1 bg-red-500 text-[10px] w-4 h-4 flex items-center justify-center rounded-full">
             {{ members.length }}
           </span>
        </button>
      </div>
    </header>

    <main class="px-4 py-6 space-y-6">

      <section v-if="shouldShowFlightCard" class="relative">
        
        <button @click="toggleStyle" class="absolute top-2 right-2 z-20 p-2 text-white/50 hover:text-white transition" title="Change Style">
          <i class="ph ph-arrows-clockwise text-lg"></i>
        </button>

        <div v-if="flightCardStyle === 'hkia'" class="rounded-t-2xl overflow-hidden hkia-shadow select-none transform transition-all duration-300">
           <div class="bg-[#1a1a1a] pt-5 pb-3 text-center border-b border-gray-700 relative">
               <div class="text-gray-400 text-[10px] tracking-[0.2em] uppercase font-bold mb-0">Gate / ÈñòÂè£</div>
               <div class="text-6xl font-black text-[#fbbf24] tracking-tighter hkia-text-glow leading-none font-mono">
                   {{ activeFlight.gate || '---' }}
               </div>
               <div class="absolute top-3 left-3 w-2 h-2 rounded-full bg-gray-700"></div>
               <div class="absolute top-3 right-3 w-2 h-2 rounded-full bg-gray-700"></div>
           </div>

           <div class="bg-[#cc0000] text-white px-4 py-5 flex flex-col items-center justify-center text-center relative border-b border-white/20">
               <div class="text-xs opacity-80 mb-1 font-medium">ÂâçÂæÄ To</div>
               <div class="text-3xl font-bold tracking-wide leading-tight line-clamp-1">
                   {{ activeFlight.dest_city }}
               </div>
               <div class="text-sm opacity-90 mt-1 font-mono tracking-wider">{{ activeFlight.dest_airport }}</div>
           </div>

           <div class="bg-[#f2f2f7] text-black p-5 space-y-4">
               
               <div class="flex justify-between items-end border-b border-gray-300 pb-3 border-dashed">
                   <div class="text-left">
                       <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Flight / Ëà™Áè≠</div>
                       <div class="text-2xl font-bold font-mono text-[#003366] leading-none mt-1">
                          {{ activeFlight.airline }} {{ activeFlight.flight_no }}
                       </div>
                   </div>
                   <div class="text-right">
                       <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Time / ÊôÇÈñì</div>
                       <div class="text-2xl font-bold font-mono text-[#003366] leading-none mt-1">
                          {{ formatTime(activeFlight.dep_time) }}
                       </div>
                   </div>
               </div>

               <div class="flex justify-between items-center">
                   <div class="text-left">
                       <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Status / ÁãÄÊ≥Å</div>
                       <div class="text-lg font-bold mt-0.5" :class="getHkiaStatusClass(activeFlight.status)">
                           {{ activeFlight.status || 'Scheduled' }}
                       </div>
                   </div>
                   <div class="text-right" v-if="activeFlight.terminal">
                       <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Term / ÂÆ¢ÈÅãÂ§ßÊ®ì</div>
                       <div class="text-lg font-bold text-gray-800 mt-0.5">{{ activeFlight.terminal }}</div>
                   </div>
               </div>
           </div>
           <div class="h-3 bg-[#0a0a0a]"></div>
        </div>

        <div v-else class="glass-card p-5 relative overflow-hidden transition-all duration-300">
          <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500 opacity-10 blur-3xl rounded-full pointer-events-none"></div>
          
          <div class="flex justify-between items-start mb-4">
            <div>
              <div class="flex items-center gap-2">
                 <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-white/10 text-blue-200">
                   {{ activeFlight.airline }}
                 </span>
                 <span class="text-sm font-bold text-white/80">{{ activeFlight.flight_no }}</span>
              </div>
              <h2 class="text-2xl font-bold text-white mt-1">{{ activeFlight.dest_city }}</h2>
              <p class="text-xs text-gray-300">{{ activeFlight.dest_airport }}</p>
            </div>
            <div class="text-right">
               <div class="text-3xl font-light text-white">{{ formatTime(activeFlight.dep_time) }}</div>
               <div class="text-xs text-gray-400 mt-1">{{ activeFlight.dep_date }}</div>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2 mt-4">
             <div class="bg-white/5 p-2 rounded-lg text-center backdrop-blur-sm">
                <div class="text-[10px] text-gray-400 uppercase">Gate</div>
                <div class="text-lg font-bold text-yellow-400">{{ activeFlight.gate || '--' }}</div>
             </div>
             <div class="bg-white/5 p-2 rounded-lg text-center backdrop-blur-sm">
                <div class="text-[10px] text-gray-400 uppercase">Term</div>
                <div class="text-lg font-bold text-white">{{ activeFlight.terminal || '1' }}</div>
             </div>
             <div class="bg-white/5 p-2 rounded-lg text-center backdrop-blur-sm">
                <div class="text-[10px] text-gray-400 uppercase">Status</div>
                <div class="text-sm font-bold truncate mt-1" :class="getStatusClass(activeFlight.status)">
                  {{ activeFlight.status || 'On Time' }}
                </div>
             </div>
          </div>
          
          <button @click="openFlightModal(activeFlight)" class="w-full mt-4 py-2 text-xs font-medium text-white/50 hover:text-white bg-white/5 rounded hover:bg-white/10 transition">
             Update Status
          </button>
        </div>

      </section>

      <section class="glass-card p-4">
        <div class="flex justify-between items-center mb-3">
           <h3 class="text-sm font-bold text-gray-300 flex items-center gap-2">
             <i class="ph ph-currency-yen text-yellow-400"></i> JPY Rate
           </h3>
           <button @click="fetchRate" class="text-xs text-blue-300 hover:text-white transition flex items-center gap-1">
             <i class="ph ph-arrows-clockwise" :class="{'animate-spin': loadingRate}"></i> 
             {{ currentLiveRate ? currentLiveRate.toFixed(3) : '...' }}
           </button>
        </div>
        
        <div class="flex flex-col gap-3">
          <div class="flex items-center gap-3 bg-black/20 p-2 rounded-lg">
             <div class="flex-1">
               <label class="block text-[10px] text-gray-400 mb-1">JPY Amount</label>
               <input type="number" v-model="calcJpy" @input="calculateHkd" class="w-full bg-transparent border-none text-xl font-bold p-0 focus:ring-0 text-white placeholder-gray-600" placeholder="0">
             </div>
             <div class="text-gray-500"><i class="ph ph-arrow-right"></i></div>
             <div class="flex-1 text-right">
                <label class="block text-[10px] text-gray-400 mb-1">HKD Approx</label>
                <div class="text-xl font-bold text-green-300">{{ calcHkd }}</div>
             </div>
          </div>
          
          <div class="text-[10px] text-gray-500 text-center">
             {{ lastRateUpdateLabel }}
          </div>
        </div>
      </section>

      <section>
        <div class="flex justify-between items-center mb-2 px-1">
          <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Pre-Trip</h3>
          <button @click="newPreNote" class="text-xs bg-white/10 px-2 py-1 rounded text-blue-300 hover:bg-white/20">+ Add</button>
        </div>
        <div class="glass-card p-1 min-h-[60px]">
           <ul v-if="preTripNotes.length > 0" class="divide-y divide-white/10">
             <li v-for="note in preTripNotes" :key="note.id" class="p-3 flex items-start gap-3 group">
                <button @click="togglePreNoteDone(note)" class="mt-0.5 text-lg" :class="note.done ? 'text-green-400' : 'text-gray-600'">
                   <i :class="note.done ? 'ph-fill ph-check-circle' : 'ph ph-circle'"></i>
                </button>
                <div class="flex-1" :class="{'opacity-40 line-through': note.done}">
                   <div class="text-sm font-medium text-white">{{ note.text }}</div>
                </div>
                <button @click="editPreNote(note)" class="text-gray-500 hover:text-white opacity-0 group-hover:opacity-100 transition"><i class="ph ph-pencil-simple"></i></button>
             </li>
           </ul>
           <div v-else class="text-center py-4 text-xs text-gray-500">No tasks yet.</div>
        </div>
      </section>

      <section>
        <div class="flex justify-between items-center mb-2 px-1">
           <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Itinerary</h3>
           <div class="flex gap-2">
             <button @click="quickItinerary" class="text-xs bg-purple-500/20 px-2 py-1 rounded text-purple-300 hover:bg-purple-500/30">Quick</button>
             <button @click="newItineraryItem" class="text-xs bg-white/10 px-2 py-1 rounded text-blue-300 hover:bg-white/20">+ Add</button>
           </div>
        </div>
        
        <div id="itinerary-list" class="space-y-2">
           <div v-for="item in sortedItinerary" :key="item.id" class="glass-card p-3 flex gap-3 active:scale-[0.98] transition-transform touch-manipulation">
              <div class="flex flex-col items-center justify-center text-gray-600 cursor-grab handle">
                 <i class="ph ph-dots-six-vertical text-lg"></i>
              </div>
              
              <div class="flex flex-col items-center justify-center min-w-[50px] border-r border-white/10 pr-3">
                 <span class="text-sm font-bold text-blue-300">{{ item.time }}</span>
                 <span class="text-[10px] text-gray-500">{{ item.dayLabel }}</span>
              </div>
              
              <div class="flex-1" @click="openItineraryModal(item)">
                 <h4 class="font-bold text-white text-sm">{{ item.title }}</h4>
                 <p v-if="item.desc" class="text-xs text-gray-400 line-clamp-1 mt-0.5">{{ item.desc }}</p>
                 <div v-if="item.tags" class="flex flex-wrap gap-1 mt-1.5">
                    <span v-for="tag in item.tags.split(',')" :key="tag" class="px-1.5 py-0.5 bg-white/5 rounded text-[9px] text-gray-300">{{ tag.trim() }}</span>
                 </div>
              </div>

              <div v-if="item.location" class="flex items-center">
                 <a :href="generateMapLink(item.location)" target="_blank" class="p-2 bg-blue-500/20 rounded-full text-blue-400 hover:bg-blue-500/30">
                    <i class="ph-fill ph-map-pin"></i>
                 </a>
              </div>
           </div>
        </div>
        <div v-if="sortedItinerary.length === 0" class="text-center py-6 text-gray-500 text-sm glass-card rounded-xl">
           Empty itinerary. Add some plans!
        </div>
      </section>

      <section>
         <div class="flex justify-between items-center mb-2 px-1">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Shopping</h3>
            <button @click="newShoppingItem" class="text-xs bg-white/10 px-2 py-1 rounded text-blue-300 hover:bg-white/20">+ Add</button>
         </div>
         <div class="glass-card p-2 grid grid-cols-2 gap-2">
            <div v-for="item in shoppingList" :key="item.id" 
                 class="relative bg-black/20 rounded-lg p-2 flex flex-col justify-between group h-24 overflow-hidden"
                 @click="openShoppingModal(item)">
               
               <div v-if="item.image_url" class="absolute inset-0 z-0 opacity-40">
                  <img :src="item.image_url" class="w-full h-full object-cover">
               </div>
               <div v-else class="absolute inset-0 z-0 opacity-10 flex items-center justify-center">
                  <i class="ph ph-bag text-4xl"></i>
               </div>
               
               <div class="relative z-10 flex justify-between items-start">
                  <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-black/50 text-white backdrop-blur-sm truncate max-w-[80px]">
                     {{ item.buyer || 'Anyone' }}
                  </span>
                  <i v-if="item.bought" class="ph-fill ph-check-circle text-green-400 text-lg shadow-black drop-shadow-md"></i>
               </div>
               
               <div class="relative z-10 mt-auto">
                  <div class="font-bold text-sm text-white drop-shadow-md truncate">{{ item.name }}</div>
                  <div class="text-[10px] text-gray-200 drop-shadow-md truncate" v-if="item.price">~{{ item.price }}</div>
               </div>
            </div>
         </div>
         <div v-if="shoppingList.length === 0" class="text-center py-4 text-xs text-gray-500">No items yet.</div>
      </section>

      <section>
         <div class="flex justify-between items-center mb-2 px-1">
             <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Expenses</h3>
             <button @click="newExpense" class="text-xs bg-white/10 px-2 py-1 rounded text-green-300 hover:bg-white/20">+ Add</button>
         </div>
         
         <div class="grid grid-cols-2 gap-3 mb-3">
             <div class="glass-card p-3 flex flex-col items-center justify-center">
                <div class="text-xs text-gray-400">Total Spent</div>
                <div class="text-xl font-bold text-white mt-1">¬•{{ formatNumber(totalExpense) }}</div>
             </div>
             <div class="glass-card p-3 flex flex-col items-center justify-center cursor-pointer hover:bg-white/5" @click="toggleAllParticipants">
                <div class="text-xs text-gray-400">Settlement</div>
                <div class="text-[10px] text-blue-300 mt-1">View Breakdown ></div>
             </div>
         </div>

         <div v-if="settlementStatus" class="mb-3 glass-card p-3 animate-fade-in">
             <h4 class="text-xs font-bold text-gray-400 mb-2 border-b border-white/10 pb-1">Who owes Who (Simplified)</h4>
             <ul class="space-y-1">
                <li v-for="(txt, idx) in settlementList" :key="idx" class="text-xs text-gray-300">
                   {{ txt }}
                </li>
             </ul>
             <div v-if="settlementList.length===0" class="text-xs text-gray-500 italic">All settled up!</div>
         </div>

         <div class="glass-card overflow-hidden">
            <div class="flex overflow-x-auto p-2 border-b border-white/10 gap-2 no-scrollbar">
               <button @click="expenseFilter = 'All'" :class="expenseFilter === 'All' ? 'bg-blue-500 text-white' : 'bg-white/10 text-gray-400'" class="px-3 py-1 rounded-full text-[10px] whitespace-nowrap transition">All</button>
               <button v-for="cat in expenseCats" :key="cat.name" @click="expenseFilter = cat.name"
                  :class="expenseFilter === cat.name ? 'bg-blue-500 text-white' : 'bg-white/10 text-gray-400'"
                  class="px-3 py-1 rounded-full text-[10px] whitespace-nowrap transition">
                  {{ cat.icon }} {{ cat.name }}
               </button>
            </div>
            <div class="max-h-[200px] overflow-y-auto">
               <div v-for="exp in filteredExpenses" :key="exp.id" @click="openExpenseModal(exp)" class="p-3 border-b border-white/5 flex justify-between items-center hover:bg-white/5 transition">
                  <div class="flex items-center gap-3">
                     <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-lg">
                        {{ getCategoryIcon(exp.category) }}
                     </div>
                     <div>
                        <div class="text-sm font-bold text-white">{{ exp.title }}</div>
                        <div class="text-[10px] text-gray-400">Paid by {{ exp.payer }} ‚Ä¢ For {{ exp.involved ? exp.involved.length : 0 }}</div>
                     </div>
                  </div>
                  <div class="text-right">
                     <div class="text-sm font-bold text-white">¬•{{ formatNumber(exp.amount) }}</div>
                     <div class="text-[9px] text-gray-500">{{ new Date(exp.date).toLocaleDateString() }}</div>
                  </div>
               </div>
               <div v-if="filteredExpenses.length === 0" class="p-4 text-center text-xs text-gray-500">No records found.</div>
            </div>
         </div>
      </section>

      <section>
          <div class="flex justify-between items-center mb-2 px-1">
             <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Info & Docs</h3>
             <button @click="newInfoItem" class="text-xs bg-white/10 px-2 py-1 rounded text-blue-300 hover:bg-white/20">+ Add</button>
          </div>
          <div class="grid grid-cols-2 gap-3">
             <div v-for="info in infoList" :key="info.id" @click="openInfoModal(info)" class="glass-card p-3 hover:bg-white/10 transition cursor-pointer">
                <div class="flex justify-between items-start mb-2">
                   <i class="ph text-2xl text-yellow-500" :class="info.icon || 'ph-info'"></i>
                   <i class="ph ph-caret-right text-gray-500 text-xs"></i>
                </div>
                <div class="font-bold text-sm text-white truncate">{{ info.title }}</div>
                <div class="text-[10px] text-gray-400 truncate">{{ info.content }}</div>
             </div>
          </div>
      </section>

    </main>

    <div v-if="preNoteModalOpen || itineraryModalOpen || shoppingModalOpen || expenseModalOpen || infoModalOpen || flightModalOpen || memberModalOpen || imageViewer.open" 
         class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
         
         <div v-if="preNoteModalOpen" class="bg-[#1c1c1e] w-full max-w-sm rounded-2xl p-5 border border-gray-700 shadow-2xl animate-fade-in-up">
            <h3 class="text-lg font-bold text-white mb-4">{{ editingPreNote ? 'Edit Task' : 'New Task' }}</h3>
            <input v-model="currentPreNote.text" type="text" placeholder="What needs to be done?" class="w-full p-3 mb-4 bg-gray-800 rounded-xl border-none focus:ring-2 focus:ring-blue-500">
            <div class="flex gap-2">
               <button @click="closePreNoteModal" class="flex-1 py-3 rounded-xl bg-gray-700 text-white font-medium">Cancel</button>
               <button @click="savePreNoteEdit" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold">Save</button>
            </div>
            <button v-if="editingPreNote" @click="removePreNote" class="w-full mt-2 py-2 text-red-400 text-sm">Delete</button>
         </div>

         <div v-if="itineraryModalOpen" class="bg-[#1c1c1e] w-full max-w-sm rounded-2xl p-5 border border-gray-700 shadow-2xl max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-white">{{ currentItinerary.id ? 'Edit Plan' : 'New Plan' }}</h3>
              <button @click="closeItineraryModal" class="text-gray-400"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="space-y-3">
               <div>
                  <label class="text-xs text-gray-500 ml-1">Title</label>
                  <input v-model="currentItinerary.title" class="w-full p-2 bg-gray-800 rounded-lg border-none" placeholder="e.g. Dinner at X">
               </div>
               <div class="flex gap-2">
                  <div class="flex-1">
                     <label class="text-xs text-gray-500 ml-1">Day</label>
                     <select v-model="currentItinerary.day" class="w-full p-2 bg-gray-800 rounded-lg border-none">
                        <option value="1">Day 1</option>
                        <option value="2">Day 2</option>
                        <option value="3">Day 3</option>
                        <option value="4">Day 4</option>
                        <option value="5">Day 5</option>
                     </select>
                  </div>
                  <div class="flex-1">
                     <label class="text-xs text-gray-500 ml-1">Time</label>
                     <input type="time" v-model="currentItinerary.time" class="w-full p-2 bg-gray-800 rounded-lg border-none">
                  </div>
               </div>
               <div>
                  <label class="text-xs text-gray-500 ml-1">Description / Notes</label>
                  <textarea v-model="currentItinerary.desc" rows="3" class="w-full p-2 bg-gray-800 rounded-lg border-none"></textarea>
               </div>
               <div>
                  <label class="text-xs text-gray-500 ml-1">Location (Google Maps Query)</label>
                  <div class="flex gap-2">
                     <input v-model="currentItinerary.location" class="w-full p-2 bg-gray-800 rounded-lg border-none" placeholder="Paste address or name">
                     <button v-if="currentItinerary.location" @click="showLocationOnMap(currentItinerary.location)" class="p-2 bg-blue-600 rounded-lg"><i class="ph ph-map-pin text-white"></i></button>
                  </div>
               </div>
               <div>
                   <label class="text-xs text-gray-500 ml-1">Tags (comma separated)</label>
                   <input v-model="currentItinerary.tags" class="w-full p-2 bg-gray-800 rounded-lg border-none" placeholder="Food, Shopping, Photo">
               </div>
            </div>

            <div class="mt-6 flex gap-3">
               <button v-if="currentItinerary.id" @click="removeItineraryItem" class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400">Delete</button>
               <button @click="saveItineraryItem" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold">Save Plan</button>
            </div>
         </div>

         <div v-if="shoppingModalOpen" class="bg-[#1c1c1e] w-full max-w-sm rounded-2xl p-5 border border-gray-700 shadow-2xl">
             <h3 class="text-lg font-bold text-white mb-4">{{ currentShopping.id ? 'Edit Item' : 'New Item' }}</h3>
             <div class="space-y-3">
                <input v-model="currentShopping.name" placeholder="Item Name" class="w-full p-3 bg-gray-800 rounded-lg border-none">
                <div class="flex gap-2">
                   <input v-model="currentShopping.price" placeholder="Approx Price" class="flex-1 p-3 bg-gray-800 rounded-lg border-none">
                   <select v-model="currentShopping.buyer" class="flex-1 p-3 bg-gray-800 rounded-lg border-none">
                      <option value="">Any Buyer</option>
                      <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                   </select>
                </div>
                
                <div>
                   <label class="text-xs text-gray-500 ml-1">Image URL (or Paste Link)</label>
                   <div class="flex gap-2">
                      <input v-model="currentShopping.image_url" class="w-full p-2 bg-gray-800 rounded-lg border-none text-xs" placeholder="https://...">
                      <label class="p-2 bg-gray-700 rounded-lg cursor-pointer flex items-center justify-center">
                         <i class="ph ph-camera text-xl"></i>
                         <input type="file" @change="handleFileUpload($event, 'shopping')" class="hidden" accept="image/*">
                      </label>
                   </div>
                   <div v-if="currentShopping.image_url" class="mt-2 h-32 rounded-lg overflow-hidden border border-gray-700 relative">
                       <img :src="currentShopping.image_url" class="w-full h-full object-cover">
                   </div>
                </div>

                <div class="flex items-center gap-2 p-2 bg-gray-800 rounded-lg cursor-pointer" @click="currentShopping.bought = !currentShopping.bought">
                   <i :class="currentShopping.bought ? 'ph-fill ph-check-square text-green-400' : 'ph ph-square text-gray-500'" class="text-xl"></i>
                   <span class="text-sm">Mark as Bought</span>
                </div>
             </div>
             <div class="mt-6 flex gap-3">
                <button v-if="currentShopping.id" @click="removeShoppingItem" class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400">Delete</button>
                <button @click="saveShoppingItem" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold">Save</button>
             </div>
         </div>

         <div v-if="expenseModalOpen" class="bg-[#1c1c1e] w-full max-w-sm rounded-2xl p-5 border border-gray-700 shadow-2xl">
             <h3 class="text-lg font-bold text-white mb-4">{{ currentExpense.id ? 'Edit Expense' : 'New Expense' }}</h3>
             <div class="space-y-3">
                <input v-model="currentExpense.title" placeholder="What was it?" class="w-full p-3 bg-gray-800 rounded-lg border-none">
                <div class="flex gap-2">
                   <div class="relative flex-1">
                      <span class="absolute left-3 top-3 text-gray-500">¬•</span>
                      <input type="number" v-model="currentExpense.amount" class="w-full pl-7 p-3 bg-gray-800 rounded-lg border-none" placeholder="0">
                   </div>
                   <select v-model="currentExpense.category" class="flex-1 p-3 bg-gray-800 rounded-lg border-none text-sm">
                      <option v-for="c in expenseCats" :key="c.name" :value="c.name">{{ c.icon }} {{ c.name }}</option>
                   </select>
                </div>
                
                <div>
                   <label class="text-xs text-gray-500 ml-1">Who Paid?</label>
                   <div class="flex gap-2 overflow-x-auto py-1 no-scrollbar">
                      <button v-for="m in members" :key="m" @click="currentExpense.payer = m"
                         :class="currentExpense.payer === m ? 'bg-blue-600 text-white border-blue-400' : 'bg-gray-800 text-gray-400 border-transparent'"
                         class="px-3 py-1.5 rounded-full text-xs border border-white/5 transition whitespace-nowrap">
                         {{ m }}
                      </button>
                   </div>
                </div>

                <div>
                   <label class="text-xs text-gray-500 ml-1">Split Between</label>
                   <div class="grid grid-cols-3 gap-2 mt-1">
                      <div v-for="m in members" :key="'split-'+m" 
                           @click="toggleParticipant(m)"
                           :class="currentExpense.involved.includes(m) ? 'bg-green-600/30 text-green-300 border-green-500/50' : 'bg-gray-800 text-gray-500 border-transparent'"
                           class="px-2 py-1.5 rounded-lg text-xs border text-center cursor-pointer select-none">
                           {{ m }}
                      </div>
                   </div>
                </div>
             </div>
             
             <div class="mt-6 flex gap-3">
                <button v-if="currentExpense.id" @click="removeExpense" class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400">Delete</button>
                <button @click="saveExpense" class="flex-1 py-2 rounded-lg bg-green-600 text-white font-bold">Save</button>
             </div>
         </div>
         
         <div v-if="infoModalOpen" class="bg-[#1c1c1e] w-full max-w-sm rounded-2xl p-5 border border-gray-700 shadow-2xl">
             <h3 class="text-lg font-bold text-white mb-4">{{ currentInfo.id ? 'Edit Info' : 'New Info' }}</h3>
             <div class="space-y-3">
                <input v-model="currentInfo.title" placeholder="Title (e.g. Hotel Wifi)" class="w-full p-3 bg-gray-800 rounded-lg border-none">
                <textarea v-model="currentInfo.content" rows="4" placeholder="Details..." class="w-full p-3 bg-gray-800 rounded-lg border-none font-mono text-sm"></textarea>
                
                <div class="flex gap-2">
                   <input v-model="currentInfo.icon" placeholder="Phosphor Icon Name (e.g. ph-wifi)" class="flex-1 p-2 bg-gray-800 rounded-lg text-xs">
                   <div class="w-10 h-10 bg-gray-700 rounded flex items-center justify-center">
                      <i class="ph text-xl" :class="currentInfo.icon || 'ph-question'"></i>
                   </div>
                </div>

                 <div>
                    <label class="text-xs text-gray-500 ml-1">Attachment</label>
                    <label class="block p-3 bg-gray-800 rounded-lg cursor-pointer text-center hover:bg-gray-700 transition">
                       <span v-if="!currentInfo.image_url" class="text-gray-400 text-xs"><i class="ph ph-image"></i> Upload Image</span>
                       <span v-else class="text-green-400 text-xs">Change Image</span>
                       <input type="file" @change="handleFileUpload($event, 'info')" class="hidden" accept="image/*">
                    </label>
                    <div v-if="currentInfo.image_url" class="mt-2 h-32 rounded-lg overflow-hidden border border-gray-700 relative">
                        <img :src="currentInfo.image_url" class="w-full h-full object-cover" @click="openImageViewer(currentInfo.image_url)">
                    </div>
                 </div>
             </div>

             <div class="mt-6 flex gap-3">
                <button v-if="currentInfo.id" @click="removeInfo" class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400">Delete</button>
                <button @click="saveInfoItem" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold">Save</button>
             </div>
         </div>

         <div v-if="flightModalOpen" class="bg-[#1c1c1e] w-full max-w-sm rounded-2xl p-5 border border-gray-700 shadow-2xl">
             <h3 class="text-lg font-bold text-white mb-4">Update Flight</h3>
             <div class="space-y-3">
                 <div class="grid grid-cols-2 gap-2">
                    <div>
                       <label class="text-[10px] text-gray-500">Gate</label>
                       <input v-model="tempFlight.gate" class="w-full p-2 bg-gray-800 rounded border-none font-mono text-lg font-bold text-center">
                    </div>
                    <div>
                       <label class="text-[10px] text-gray-500">Terminal</label>
                       <input v-model="tempFlight.terminal" class="w-full p-2 bg-gray-800 rounded border-none font-mono text-lg font-bold text-center">
                    </div>
                 </div>
                 <div>
                    <label class="text-[10px] text-gray-500">Status</label>
                    <select v-model="tempFlight.status" class="w-full p-2 bg-gray-800 rounded border-none">
                       <option value="Scheduled">Scheduled</option>
                       <option value="On Time">On Time</option>
                       <option value="Delayed">Delayed</option>
                       <option value="Boarding">Boarding</option>
                       <option value="Final Call">Final Call</option>
                       <option value="Gate Closed">Gate Closed</option>
                    </select>
                 </div>
                 <div class="pt-2">
                    <label class="text-[10px] text-gray-500">Departure Time</label>
                    <input type="datetime-local" v-model="tempFlight.dep_time" class="w-full p-2 bg-gray-800 rounded border-none">
                 </div>
             </div>
             <div class="mt-5 flex gap-2">
                <button @click="closeFlightModal" class="flex-1 py-2 bg-gray-700 rounded text-white">Cancel</button>
                <button @click="saveFlight" class="flex-1 py-2 bg-blue-600 rounded text-white font-bold">Update</button>
             </div>
         </div>

         <div v-if="memberModalOpen" class="bg-[#1c1c1e] w-full max-w-sm rounded-2xl p-5 border border-gray-700 shadow-2xl">
             <h3 class="text-lg font-bold text-white mb-4">Travelers</h3>
             <div class="flex gap-2 mb-4">
                <input v-model="newMemberName" placeholder="Name" class="flex-1 p-2 bg-gray-800 rounded-lg border-none" @keyup.enter="addMember">
                <button @click="addMember" class="px-3 bg-blue-600 rounded-lg text-white"><i class="ph ph-plus"></i></button>
             </div>
             <ul class="space-y-2 max-h-40 overflow-y-auto">
                <li v-for="m in members" :key="m" class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
                   <span>{{ m }}</span>
                   <button @click="removeMember(m)" class="text-red-400 hover:text-red-300"><i class="ph ph-trash"></i></button>
                </li>
             </ul>
             <button @click="closeMemberModal" class="w-full mt-4 py-2 bg-gray-700 rounded-lg text-white">Done</button>
         </div>
         
         <div v-if="imageViewer.open" class="fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center p-2" @click="imageViewer.open = false">
             <img :src="imageViewer.url" class="max-w-full max-h-[85vh] object-contain shadow-2xl rounded-lg">
             <button class="mt-4 px-4 py-2 bg-white/20 rounded-full text-white text-sm">Close</button>
         </div>

    </div>

  </div>

  <script>
    const { createApp, ref, computed, onMounted, reactive, watch } = Vue;
    const supabaseUrl = 'YOUR_SUPABASE_URL'; // User to fill
    const supabaseKey = 'YOUR_SUPABASE_KEY'; // User to fill
    // const supabase = supabase.createClient(supabaseUrl, supabaseKey); 
    // MOCK MODE active as no keys provided.

    createApp({
      setup() {
        // --- State ---
        // FLIGHT DATA
        const activeFlight = ref({
           id: 1,
           airline: 'CX',
           flight_no: '500',
           dest_city: 'Tokyo',
           dest_airport: 'Narita (NRT)',
           dep_time: '2025-10-15T15:10:00', // ISO format
           dep_date: 'Oct 15',
           gate: '201',
           terminal: '1',
           status: 'On Time'
        });

        const flightCardStyle = ref('hkia'); // 'hkia' or 'ios'

        // MEMBERS
        const members = ref(['Alice', 'Bob', 'Charlie']);
        const memberModalOpen = ref(false);
        const newMemberName = ref('');

        // RATE
        const rate = ref(0.052); // JPY to HKD
        const loadingRate = ref(false);
        const lastRateUpdateLabel = ref('Last updated: Just now (Mock)');
        const currentLiveRate = ref(0.0523);
        
        // CALC
        const calcJpy = ref('');
        const calcHkd = ref('0.00');

        // PRE-TRIP
        const preTripNotes = ref([
           { id: 1, text: 'Buy Travel Insurance', done: true },
           { id: 2, text: 'Book Skyliner Tickets', done: false },
           { id: 3, text: 'Download Offline Maps', done: false }
        ]);
        const preNoteModalOpen = ref(false);
        const currentPreNote = ref({ id: null, text: '', done: false });
        const editingPreNote = ref(false);

        // ITINERARY
        const itinerary = ref([
           { id: 1, day: 1, time: '10:00', title: 'Arrive NRT', desc: 'Pick up Wifi', location: 'Narita T1', tags: 'Travel', dayLabel: 'Day 1' },
           { id: 2, day: 1, time: '13:00', title: 'Hotel Check-in', desc: 'Shinjuku Prince', location: 'Shinjuku', tags: 'Hotel', dayLabel: 'Day 1' },
           { id: 3, day: 2, time: '09:00', title: 'DisneySea', desc: 'Full day', location: 'Maihama', tags: 'Fun', dayLabel: 'Day 2' }
        ]);
        const itineraryModalOpen = ref(false);
        const currentItinerary = ref({});

        // SHOPPING
        const shoppingList = ref([
           { id: 1, name: 'Matcha KitKat', price: '300', buyer: 'Alice', bought: false, image_url: '' },
           { id: 2, name: 'Face Mask', price: '1200', buyer: '', bought: true, image_url: '' }
        ]);
        const shoppingModalOpen = ref(false);
        const currentShopping = ref({});

        // EXPENSES
        const expenses = ref([
           { id: 1, title: 'Skyliner Tickets', amount: 7500, category: 'Transport', payer: 'Alice', involved: ['Alice','Bob','Charlie'], date: new Date().toISOString() },
           { id: 2, title: 'Convenience Store', amount: 1200, category: 'Food', payer: 'Bob', involved: ['Alice','Bob'], date: new Date().toISOString() }
        ]);
        const expenseModalOpen = ref(false);
        const currentExpense = ref({ involved: [] });
        const expenseFilter = ref('All');
        const expenseCats = [
           { name: 'Food', icon: 'üçî' },
           { name: 'Transport', icon: 'üöÜ' },
           { name: 'Shopping', icon: 'üõçÔ∏è' },
           { name: 'Stay', icon: 'üè®' },
           { name: 'Other', icon: 'üìÑ' }
        ];

        // INFO
        const infoList = ref([
           { id: 1, title: 'Hotel Wifi', content: 'Pass: shinjuku2025', icon: 'ph-wifi', image_url: '' },
           { id: 2, title: 'Passport Copies', content: 'In Dropbox', icon: 'ph-file-text', image_url: '' }
        ]);
        const infoModalOpen = ref(false);
        const currentInfo = ref({});

        // MODALS & UPLOAD
        const flightModalOpen = ref(false);
        const tempFlight = ref({});
        const isUploading = ref(false);
        const imageViewer = ref({ open: false, url: '' });

        // --- Computed & Logic ---

        // Flight Logic
        const shouldShowFlightCard = computed(() => !!activeFlight.value);
        
        const toggleStyle = () => {
          flightCardStyle.value = flightCardStyle.value === 'hkia' ? 'ios' : 'hkia';
        };

        const getStatusClass = (status) => {
           if (!status) return 'text-gray-400';
           const s = status.toLowerCase();
           if (s.includes('delay')) return 'text-red-400';
           if (s.includes('board') || s.includes('final')) return 'text-green-400 animate-pulse';
           if (s.includes('cancel')) return 'text-red-600 line-through';
           return 'text-blue-300';
        };

        const getHkiaStatusClass = (status) => {
           if (!status) return 'text-gray-600';
           const s = status.toLowerCase();
           if (s.includes('delay')) return 'text-[#cc0000]';
           if (s.includes('board') || s.includes('final')) return 'text-green-600 animate-pulse';
           if (s.includes('cancel')) return 'text-gray-400 line-through';
           return 'text-black';
        };

        const formatTime = (iso) => {
           if(!iso) return '--:--';
           const d = new Date(iso);
           return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        };

        // Rate
        const fetchRate = async () => {
           loadingRate.value = true;
           // Mock delay
           setTimeout(() => {
              currentLiveRate.value = 0.0520 + (Math.random() * 0.001);
              lastRateUpdateLabel.value = 'Updated: ' + new Date().toLocaleTimeString();
              loadingRate.value = false;
              calculateHkd();
           }, 800);
        };
        const calculateHkd = () => {
           if (!calcJpy.value) { calcHkd.value = '0.00'; return; }
           calcHkd.value = (parseFloat(calcJpy.value) * currentLiveRate.value).toFixed(2);
        };

        // Itinerary Sort
        const sortedItinerary = computed(() => {
           return [...itinerary.value].sort((a,b) => {
              if (a.day !== b.day) return a.day - b.day;
              return a.time.localeCompare(b.time);
           });
        });
        
        const generateMapLink = (loc) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;

        // Expenses
        const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
        
        const filteredExpenses = computed(() => {
           let list = expenses.value;
           if (expenseFilter.value !== 'All') {
              list = list.filter(e => e.category === expenseFilter.value);
           }
           return list.sort((a,b) => new Date(b.date) - new Date(a.date));
        });

        const getCategoryIcon = (catName) => {
           const c = expenseCats.find(x => x.name === catName);
           return c ? c.icon : 'üí∏';
        };

        const settlementStatus = computed(() => expenses.value.length > 0);
        const settlementList = computed(() => {
           // Simple naive split logic for display
           let balances = {};
           members.value.forEach(m => balances[m] = 0);
           
           expenses.value.forEach(exp => {
              const paidBy = exp.payer;
              const share = exp.amount / exp.involved.length;
              balances[paidBy] += exp.amount;
              exp.involved.forEach(person => {
                 balances[person] -= share;
              });
           });

           // Format strings
           let result = [];
           for (let m in balances) {
              let val = balances[m];
              if (val > 1) result.push(`${m} is owed ¬•${val.toFixed(0)}`);
              else if (val < -1) result.push(`${m} owes ¬•${Math.abs(val).toFixed(0)}`);
           }
           return result;
        });


        // --- Actions ---
        
        // Modals
        const openAddModal = () => alert('Quick Add Menu Placeholder'); 
        
        // PreNote
        const newPreNote = () => {
           currentPreNote.value = { id: null, text: '', done: false };
           editingPreNote.value = false;
           preNoteModalOpen.value = true;
        };
        const editPreNote = (note) => {
           currentPreNote.value = { ...note };
           editingPreNote.value = true;
           preNoteModalOpen.value = true;
        };
        const savePreNoteEdit = () => {
           if (editingPreNote.value) {
              const idx = preTripNotes.value.findIndex(n => n.id === currentPreNote.value.id);
              if (idx !== -1) preTripNotes.value[idx] = { ...currentPreNote.value };
           } else {
              currentPreNote.value.id = Date.now();
              preTripNotes.value.push({ ...currentPreNote.value });
           }
           closePreNoteModal();
        };
        const removePreNote = () => {
           preTripNotes.value = preTripNotes.value.filter(n => n.id !== currentPreNote.value.id);
           closePreNoteModal();
        };
        const togglePreNoteDone = (note) => { note.done = !note.done; };
        const closePreNoteModal = () => preNoteModalOpen.value = false;

        // Itinerary
        const quickItinerary = () => alert('Quick AI Plan Feature Placeholder');
        const newItineraryItem = () => {
           currentItinerary.value = { id: null, day: 1, tags: '' };
           itineraryModalOpen.value = true;
        };
        const openItineraryModal = (item) => {
           currentItinerary.value = { ...item };
           itineraryModalOpen.value = true;
        };
        const saveItineraryItem = () => {
            if (currentItinerary.value.id) {
               const idx = itinerary.value.findIndex(i => i.id === currentItinerary.value.id);
               if(idx!==-1) itinerary.value[idx] = {...currentItinerary.value, dayLabel: 'Day '+currentItinerary.value.day};
            } else {
               currentItinerary.value.id = Date.now();
               currentItinerary.value.dayLabel = 'Day '+currentItinerary.value.day;
               itinerary.value.push({...currentItinerary.value});
            }
            closeItineraryModal();
        };
        const removeItineraryItem = () => {
            itinerary.value = itinerary.value.filter(i => i.id !== currentItinerary.value.id);
            closeItineraryModal();
        };
        const closeItineraryModal = () => itineraryModalOpen.value = false;

        // Shopping
        const newShoppingItem = () => {
           currentShopping.value = { id: null, buyer: '', bought: false };
           shoppingModalOpen.value = true;
        };
        const openShoppingModal = (item) => {
           currentShopping.value = { ...item };
           shoppingModalOpen.value = true;
        };
        const saveShoppingItem = () => {
           if(currentShopping.value.id) {
              const idx = shoppingList.value.findIndex(s => s.id === currentShopping.value.id);
              if(idx!==-1) shoppingList.value[idx] = {...currentShopping.value};
           } else {
              currentShopping.value.id = Date.now();
              shoppingList.value.push({...currentShopping.value});
           }
           closeShoppingModal();
        };
        const removeShoppingItem = () => {
           shoppingList.value = shoppingList.value.filter(s => s.id !== currentShopping.value.id);
           closeShoppingModal();
        };
        const closeShoppingModal = () => shoppingModalOpen.value = false;

        // Expense
        const newExpense = () => {
           currentExpense.value = { id: null, payer: members.value[0], involved: [...members.value], category: 'Food' };
           expenseModalOpen.value = true;
        };
        const openExpenseModal = (exp) => {
           currentExpense.value = JSON.parse(JSON.stringify(exp)); // deep copy
           expenseModalOpen.value = true;
        };
        const saveExpense = () => {
           const val = parseFloat(currentExpense.value.amount);
           if(isNaN(val)) return;
           currentExpense.value.amount = val;
           
           if(currentExpense.value.id) {
               const idx = expenses.value.findIndex(e => e.id === currentExpense.value.id);
               if(idx!==-1) expenses.value[idx] = {...currentExpense.value};
           } else {
               currentExpense.value.id = Date.now();
               currentExpense.value.date = new Date().toISOString();
               expenses.value.push({...currentExpense.value});
           }
           closeExpenseModal();
        };
        const removeExpense = () => {
           expenses.value = expenses.value.filter(e => e.id !== currentExpense.value.id);
           closeExpenseModal();
        };
        const toggleParticipant = (name) => {
           const idx = currentExpense.value.involved.indexOf(name);
           if(idx > -1) currentExpense.value.involved.splice(idx, 1);
           else currentExpense.value.involved.push(name);
        };
        const toggleAllParticipants = () => {
           // Detail view placeholder
           alert(settlementList.value.join('\n'));
        };
        const closeExpenseModal = () => expenseModalOpen.value = false;

        // Info
        const newInfoItem = () => {
           currentInfo.value = { id: null, icon: 'ph-note' };
           infoModalOpen.value = true;
        };
        const openInfoModal = (item) => {
           currentInfo.value = { ...item };
           infoModalOpen.value = true;
        };
        const saveInfoItem = () => {
           if(currentInfo.value.id) {
              const idx = infoList.value.findIndex(i => i.id === currentInfo.value.id);
              if(idx!==-1) infoList.value[idx] = {...currentInfo.value};
           } else {
              currentInfo.value.id = Date.now();
              infoList.value.push({...currentInfo.value});
           }
           closeInfoModal();
        };
        const removeInfo = () => {
           infoList.value = infoList.value.filter(i => i.id !== currentInfo.value.id);
           closeInfoModal();
        };
        const closeInfoModal = () => infoModalOpen.value = false;

        // Flight Edit
        const openFlightModal = (f) => {
           tempFlight.value = { ...f };
           flightModalOpen.value = true;
        };
        const closeFlightModal = () => flightModalOpen.value = false;
        const saveFlight = () => {
           activeFlight.value = { ...activeFlight.value, ...tempFlight.value };
           closeFlightModal();
        };

        // Members
        const openMemberModal = () => memberModalOpen.value = true;
        const closeMemberModal = () => memberModalOpen.value = false;
        const addMember = () => {
           if(newMemberName.value && !members.value.includes(newMemberName.value)){
              members.value.push(newMemberName.value);
              newMemberName.value = '';
           }
        };
        const removeMember = (m) => {
           members.value = members.value.filter(x => x !== m);
        };

        // Utils
        const formatNumber = (num) => {
           return new Intl.NumberFormat('en-US').format(num);
        };
        const handleFileUpload = (event, type) => {
           const file = event.target.files[0];
           if(!file) return;
           isUploading.value = true;
           // Fake upload delay
           setTimeout(() => {
              const fakeUrl = URL.createObjectURL(file);
              if(type === 'shopping') currentShopping.value.image_url = fakeUrl;
              if(type === 'info') currentInfo.value.image_url = fakeUrl;
              isUploading.value = false;
           }, 1000);
        };
        const openImageViewer = (url) => {
           imageViewer.value = { open: true, url };
        };


        // Lifecycle
        onMounted(() => {
           // Sortable for Itinerary
           new Sortable(document.getElementById('itinerary-list'), {
              handle: '.handle',
              animation: 150
           });
           
           // Init calc
           calculateHkd();
        });

        return {
           activeFlight, flightCardStyle, toggleStyle, getHkiaStatusClass,
           lastRateUpdateLabel, rate, currentLiveRate, fetchRate, loadingRate, calcJpy, calcHkd, calculateHkd,
           shouldShowFlightCard, getStatusClass, formatTime,
           preTripNotes, newPreNote, addPreNote, removePreNote, editPreNote, togglePreNoteDone, preNoteModalOpen, currentPreNote, editingPreNote, closePreNoteModal, savePreNoteEdit,
           sortedItinerary, openItineraryModal, closeItineraryModal, saveItineraryItem, removeItineraryItem, itineraryModalOpen, newItineraryItem, quickItinerary, currentItinerary,
           shoppingList, openShoppingModal, closeShoppingModal, saveShoppingItem, removeShoppingItem, shoppingModalOpen, newShoppingItem, currentShopping,
           expenses, totalExpense, filteredExpenses, expenseFilter, openExpenseModal, closeExpenseModal, saveExpense, removeExpense, expenseModalOpen, newExpense, currentExpense,
           expenseCats, getCategoryIcon, toggleParticipant, settlementList, settlementStatus, toggleAllParticipants,
           infoList, openInfoModal, closeInfoModal, saveInfoItem, removeInfo, infoModalOpen, newInfoItem, currentInfo,
           openAddModal, flightModalOpen, tempFlight, openFlightModal, closeFlightModal, saveFlight,
           handleFileUpload, isUploading,
           imageViewer, openImageViewer, formatNumber, generateMapLink,
           members, memberModalOpen, openMemberModal, closeMemberModal, addMember, removeMember, newMemberName
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
