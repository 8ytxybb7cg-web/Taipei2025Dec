<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync v5.11</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    /* --- iOS 18 System Variables --- */
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.65);
      --ios-card-border: rgba(255, 255, 255, 0.4);
      --ios-primary: #007AFF;
      --ios-danger: #FF3B30;
      --ios-warning: #FFCC00;
      --ios-success: #34C759;
      --glass-blur: blur(25px);
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    html { height: 100%; overscroll-behavior-y: none; }
    body {
      height: 100%;
      font-family: var(--font-stack);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background-color: #000;
      margin: 0;
      color: #000;
      overflow: hidden;
      user-select: none;
    }

    /* Scrollable Container */
    #app { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

    /* Main Scroll Area */
    main {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-top: 20px;
    }

    /* Utilities */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 100px); }
    
    /* --- Components --- */

    /* iOS Glass Card (Light) */
    .ios-card {
      background: var(--ios-card-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--ios-card-border);
      border-radius: 22px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      overflow: hidden;
    }

    /* iOS Premium Dark Glass Card (Flight/Expense) */
    .ios-card-dark-glass {
      background: rgba(22, 22, 24, 0.85);
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 26px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .dark-glass-gradient {
        position: absolute;
        top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle at 80% 20%, rgba(10, 132, 255, 0.25), transparent 60%);
        pointer-events: none; z-index: 0;
    }

    /* List Items */
    .ios-list-item {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      border-radius: 18px;
      margin-bottom: 8px; 
      padding: 14px;
      display: flex;
      align-items: center; 
      justify-content: space-between;
      transition: background 0.2s, transform 0.2s;
      border: 1px solid rgba(255,255,255,0.5);
      touch-action: manipulation;
    }
    .ios-list-item:active { background: rgba(255, 255, 255, 0.95); transform: scale(0.98); }

    /* Drag & Drop Styles */
    .sortable-ghost { opacity: 0.4; background: #e5e7eb; border: 1px dashed #9ca3af; }
    .sortable-drag { opacity: 1; background: #fff; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); transform: scale(1.02); z-index: 50; }
    
    /* Strict Drag Handle for iOS Stability */
    .drag-handle { 
        cursor: grab;
        padding: 10px; 
        margin: -10px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        touch-action: pan-y;
        -webkit-user-select: none;
        user-select: none;
    }
    
    #sortable-expenses { position: relative; z-index: 20; }
    
    /* Action Buttons */
    .action-btn-group {
        display: flex;
        align-items: center; gap: 4px; flex-shrink: 0; padding-left: 8px;
        opacity: 0.6; transition: opacity 0.2s;
    }
    .ios-list-item:hover .action-btn-group, .action-btn-group:active { opacity: 1; }
    .icon-btn { padding: 6px; color: #8E8E93; transition: color 0.2s; border-radius: 50%; }
    .icon-btn:hover { background: rgba(0,0,0,0.05); }
    .icon-btn.edit:hover { color: var(--ios-primary); }
    .icon-btn.delete:hover { color: var(--ios-danger); }

    /* Inputs */
    .ios-input {
      background: rgba(118, 118, 128, 0.12);
      border: none; border-radius: 12px; padding: 12px 16px;
      font-size: 17px; color: #000; width: 100%; box-sizing: border-box;
      transition: background 0.2s;
    }
    .ios-input:focus { background: rgba(118, 118, 128, 0.2); outline: none; }
    .ios-input::placeholder { color: #8E8E93; }

    /* Modals */
    .modal-backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); z-index: 100; }
    
    .ios-modal-container {
      background: rgba(250, 250, 250, 0.9);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 32px;
      display: flex; flex-direction: column;
      max-height: 92vh; width: 100%; max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.4);
    }

    .ios-modal-header { padding: 16px; text-align: center; font-weight: 600; font-size: 17px; border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; }
    .ios-modal-body { flex: 1; overflow-y: auto; padding: 24px; -webkit-overflow-scrolling: touch; }
    
    /* Calculator specific modal padding */
    .ios-modal-body.calc-body { padding: 16px 16px 8px 16px; overflow-y: hidden; display: flex; flex-direction: column; } 

    .ios-modal-footer { padding: 16px 24px; border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; gap: 12px; flex-shrink: 0; background: rgba(255,255,255,0.5); }

    /* Buttons */
    .btn-ios-cancel {
      flex: 1;
      height: 50px; border-radius: 14px;
      background: rgba(118, 118, 128, 0.12);
      color: #000; font-weight: 600; font-size: 17px;
      display: flex; align-items: center;
      justify-content: center;
    }
    .btn-ios-primary {
      flex: 1; height: 50px; border-radius: 14px;
      background: var(--ios-primary);
      color: white; font-weight: 600; font-size: 17px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 15px rgba(0, 122, 255, 0.4);
    }
    .btn-ios-primary:active { opacity: 0.8; transform: scale(0.98); }
    .btn-ios-primary:disabled { opacity: 0.5; box-shadow: none; }

    /* Calculator Buttons */
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex: 1; }
    .calc-btn {
        border-radius: 10px; background: white;
        font-size: 20px; font-weight: 500; color: #333;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: background 0.1s;
        height: 100%; min-height: 40px;
    }
    .calc-btn:active { background: #E5E5EA; }
    .calc-btn.op { background: #FF9500; color: white; font-weight: 600; }
    .calc-btn.op:active { background: #D47B00; }
    .calc-btn.top-op { background: #D1D1D6; color: black; }
    .calc-btn.top-op:active { background: #A0A0A5; }
    
    .calc-btn.done-btn {
        background: var(--ios-primary);
        color: white;
        font-size: 17px;
        font-weight: 600;
    }

    /* Dock */
    .iphone-dock {
      background: rgba(245, 245, 245, 0.75);
      backdrop-filter: blur(50px);
      -webkit-backdrop-filter: blur(50px);
      border-radius: 38px;
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      display: flex; justify-content: space-between; align-items: flex-end;
    }

    /* Tabs */
    .day-tab { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255,255,255,0.2); }
    .day-tab.active { background: rgba(255, 255, 255, 0.9); border-color: rgba(255,255,255,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.05); transform: translateY(-2px); }

    .task-done { text-decoration: line-through; color: #8E8E93; opacity: 0.7; }
    .rotate-icon { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    /* Flight Status */
    .status-ontime { color: var(--ios-success); background: rgba(52, 199, 89, 0.15); border: 1px solid rgba(52, 199, 89, 0.2); }
    .status-delayed { color: var(--ios-danger); background: rgba(255, 59, 48, 0.15); border: 1px solid rgba(255, 59, 48, 0.2); }
    .status-boarding { color: var(--ios-warning); background: rgba(255, 204, 0, 0.15); border: 1px solid rgba(255, 204, 0, 0.2); }

    /* --- HKG Board Style (v5.11) --- */
    .ios-card-dark-glass.hkg-style {
      background: #353E53 !important;
      backdrop-filter: none !important; -webkit-backdrop-filter: none !important;
      border: none !important; border-radius: 6px !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
      display: flex;
      flex-direction: column; overflow: hidden;
    }
    .hkg-style .dark-glass-gradient { display: none; }
    
    /* HKG Style Internal Overrides */
    .hkg-style .text-shadow-none { text-shadow: none !important; }

    /* Yellow line changed to Blue #275CC0 as requested */
    .hkg-style .border-custom-blue { border-color: #275CC0 !important; }
  </style>
</head>

<body>
  <div id="app">

    <div class="fixed inset-0 z-0 pointer-events-none">
      <img src="./IMG_6732.jpeg?auto=format&fit=crop&w=2000&q=80"
           class="w-full h-full object-cover blur-[4px] scale-105" alt="Taipei Background">
      <div class="absolute inset-0 bg-white/70 backdrop-blur-[2px]"></div>
    </div>

    <main class="relative z-10 no-scrollbar pb-safe px-5">

      <div class="flex items-center justify-between mb-8 mt-4">
        <div>
          <h1 class="text-[34px] leading-tight font-bold tracking-tight text-black drop-shadow-sm font-[SF Pro Display]">
            eMenu Taipei
          </h1>
          <div class="flex items-center gap-2 mt-0.5 pl-1">
            <span class="text-[9px] font-semibold text-gray-400/80 uppercase tracking-widest">{{ appVersion }}</span>
            
            <div class="flex items-center gap-2 bg-white/50 backdrop-blur-md px-2 py-0.5 rounded-full border border-black/5">
                 <div class="w-1.5 h-1.5 rounded-full transition-colors duration-300"
                     :class="{
                        'bg-green-500': syncState === 'synced',
                        'bg-yellow-400': syncState === 'saving' || syncState === 'loading',
                        'bg-red-500': syncState === 'error'
                     }"></div>
                <span class="text-[10px] font-medium text-gray-500">{{ syncStatusText }}</span>
            </div>
             <button @click="forceReloadCloud" class="text-gray-400 hover:text-gray-600 transition p-1" title="Reload">
                <i class="ph ph-arrows-clockwise text-xs" :class="{'rotate-icon': syncState === 'loading'}"></i>
            </button>
          </div>
        </div>
      
        <div class="flex flex-col items-end text-right">
           <span class="text-[10px] font-bold text-[#007AFF] uppercase tracking-wide mb-0.5">即時匯率</span>
           <span class="text-[9px] font-bold text-gray-400 uppercase tracking-wide mb-0.5">HKD / TWD</span>
           <div class="text-2xl font-bold text-gray-800 tracking-tight font-mono leading-none my-0.5">
             {{ formattedRate }}
           </div>
           <div class="text-[9px] font-medium text-gray-500 mb-0.5 font-mono tracking-tight">(含2%手續費)</div>
            <div class="text-[9px] font-medium text-gray-400/80 font-mono tracking-tight">
                更新：{{ lastRateUpdateLabel }}
           </div>
        </div>
      </div>

      <div class="mb-8">
        <div class="flex justify-between gap-3 overflow-x-auto no-scrollbar py-1 px-1">
          <button @click="currentTab = '準備'" 
             class="day-tab flex-shrink-0 w-[20%] h-[76px] rounded-2xl flex flex-col items-center justify-center text-xs relative overflow-hidden group"
               :class="{ 'active': currentTab === '準備' }">
             <i class="ph ph-list-checks text-2xl mb-1 text-gray-400 transition-colors group-[.active]:text-[#007AFF]"></i>
             <span class="font-medium text-gray-500 group-[.active]:font-bold">準備</span>
          </button>
         
           <button v-for="(d, i) in days" :key="i"
                  @click="selectDay(i); currentTab = '行程'"
                  class="day-tab flex-shrink-0 w-[22%] h-[76px] rounded-2xl flex flex-col items-center justify-center relative overflow-hidden group"
                  :class="{ 'active': selectedDay === i && currentTab === '行程' }">
            <span class="text-[10px] font-bold uppercase text-gray-400 mb-0.5 group-[.active]:text-[#007AFF]">Day {{ i + 1 }}</span>
            <span class="text-[11px] font-medium text-gray-400 group-[.active]:text-gray-800">{{ d.week }}</span>
            <span class="text-lg font-bold mt-0.5 leading-none text-gray-600 group-[.active]:text-black">{{ d.date }}</span>
          </button>
        </div>
      </div>

      <div v-if="currentTab === '行程'" class="space-y-5 mb-6">
        
        <transition name="fade">
          <div v-if="shouldShowFlightCard" class="ios-card-dark-glass p-0 mb-4 transition-all duration-500"
             :class="{ 'hkg-style': flightBoardStyle === 'hkg' }">
              
              <div class="dark-glass-gradient"></div>
              
              <div class="absolute top-3 right-3 z-50 flex items-center gap-2">
                 
                 <a v-if="activeFlight.liveLink" :href="activeFlight.liveLink" target="_blank" 
                    class="flex items-center gap-1.5 bg-white/20 hover:bg-white/30 border border-white/20 px-3 py-1.5 rounded-full text-[11px] font-bold text-white transition-all active:scale-95">
                      <i class="ph ph-broadcast text-[#34C759] animate-pulse"></i>
                      Flighty 實況
                      <i class="ph ph-arrow-square-out text-xs opacity-70"></i>
                 </a>

                 <button @click.stop="flightBoardStyle = flightBoardStyle === 'hkg' ? 'ios' : 'hkg'" 
                         class="px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all active:scale-95 select-none flex items-center gap-1 cursor-pointer"
                         :class="flightBoardStyle === 'hkg' ? 'bg-white text-black border-white shadow-md' : 'bg-black/20 text-white border-white/20 backdrop-blur-md hover:bg-black/30'">
                     {{ flightBoardStyle === 'hkg' ? 'iOS' : 'HKG' }}
                     <i class="ph" :class="flightBoardStyle === 'hkg' ? 'ph-toggle-right' : 'ph-toggle-left'"></i>
                 </button>

                 <button @click.stop="openFlightModal(activeFlight.id)" class="text-white/70 hover:text-white bg-black/20 hover:bg-black/40 border border-white/10 p-1.5 rounded-full transition backdrop-blur-md active:scale-95 cursor-pointer">
                      <i class="ph ph-pencil-simple text-sm"></i>
                 </button>
              </div>

              <div v-if="flightBoardStyle === 'hkg'" class="flex flex-col h-full relative z-10 w-full">
                  
                  <div class="pt-6 pb-6 text-center flex flex-col items-center justify-center relative">
                       <div class="text-[10px] text-white/50 uppercase tracking-widest font-bold mb-1">Gate</div>
                      <div class="text-[4.5rem] leading-[0.85] font-bold text-[#FFCC00] font-sans drop-shadow-lg tracking-tighter">{{ activeFlight.gate || '--' }}</div>
                      
                      <div class="absolute bottom-2 right-4 px-3 py-1 rounded-full text-[11px] font-bold tracking-wide border backdrop-blur-md"
                           :class="getStatusClass(activeFlight.status)">
                          {{ activeFlight.status || 'Scheduled' }}
                      </div>
                  </div>

                  <div class="mx-0 mb-0 bg-[#F2F2F7] border-t-4 border-custom-blue px-6 py-4 flex items-center justify-between shadow-2xl relative z-20">
                      <div class="flex flex-col items-center">
                          <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">航班 Flight</span>
                          <span class="text-3xl font-bold text-black font-mono text-shadow-none tracking-tight">{{ activeFlight.code }}</span>
                      </div>
                       <div class="flex flex-col items-center">
                          <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">預計起飛</span>
                          <span class="text-3xl font-bold text-black font-mono text-shadow-none tracking-tight">{{ activeFlight.depTime }}</span>
                      </div>
                  </div>

                  <div class="bg-[#BF443B] mx-0 px-5 pt-4 pb-5 flex justify-between items-end relative shadow-inner">
                      <div class="flex flex-col items-start gap-1">
                           <div class="flex items-baseline gap-2">
                               <span class="text-2xl font-bold text-white font-mono leading-none">{{ activeFlight.fromCode }}</span>
                               <span class="text-sm font-bold text-white/80 uppercase">{{ activeFlight.fromTerminal }}</span>
                           </div>
                           
                           <div class="text-white/60 font-bold italic text-sm pl-0.5 leading-none my-0.5">to</div>

                           <div class="flex items-baseline gap-2">
                               <span class="text-4xl font-bold text-[#FFCC00] font-mono leading-none drop-shadow-md">{{ activeFlight.toCode }}</span>
                               <span class="text-xl font-bold text-[#FFCC00]/90 uppercase">{{ activeFlight.toTerminal }}</span>
                           </div>
                      </div>

                      <div class="flex flex-col items-end text-right">
                          <div class="flex flex-col items-center">
                              <span class="text-[9px] text-white/60 uppercase font-bold tracking-wide mb-0.5">預計抵達</span>
                              <span class="text-2xl font-bold text-white font-mono leading-none">{{ activeFlight.arrTime }}</span>
                          </div>
                      </div>
                  </div>
              </div>

              <div v-else class="p-5 pb-6 relative z-10">
                  <div class="flex items-center justify-between mt-8 mb-2">
                    <div class="text-center min-w-[60px]">
                        <div class="text-3xl font-bold tracking-wider text-white">{{ activeFlight.fromCode }}</div>
                       <div class="text-[10px] font-bold opacity-60 mt-1 uppercase">{{ activeFlight.fromTerminal }}</div>
                    </div>
                 
                    <div class="flex-1 px-4 flex flex-col items-center">
                       <div class="text-[10px] font-mono opacity-50 mb-1">{{ activeFlight.code }}</div>
                       <div class="w-full flex items-center gap-2">
                           <div class="h-[2px] bg-white/20 flex-1 rounded-full"></div>
                            <i class="ph ph-airplane-tilt text-xl opacity-90 text-[#007AFF]"></i>
                           <div class="h-[2px] bg-white/20 flex-1 rounded-full"></div>
                       </div>
                       <div class="text-[10px] mt-1.5 opacity-80 font-medium tracking-wide text-center">{{ activeFlight.note }}</div>
                    </div>
                    
                    <div class="text-center min-w-[60px]">
                       <div class="text-3xl font-bold tracking-wider text-white">{{ activeFlight.toCode }}</div>
                       <div class="text-[10px] font-bold opacity-60 mt-1 uppercase">{{ activeFlight.toTerminal }}</div>
                    </div>
                  </div>
                  
                   <div class="flex justify-between items-end mt-8 pt-4 border-t border-white/10">
                      <div>
                          <div class="text-[10px] opacity-50 uppercase tracking-wider mb-0.5">預計起飛</div>
                          <div class="text-2xl font-mono font-bold leading-none">{{ activeFlight.depTime }}</div>
                      </div>
                      
                      <div class="flex flex-col items-center bg-white/10 px-4 py-2 rounded-xl border border-white/10">
                           <div class="text-[9px] opacity-50 uppercase tracking-widest mb-0.5">登機閘口</div>
                           <div class="text-xl font-bold text-[#FFCC00]">{{ activeFlight.gate || '--' }}</div>
                      </div>

                      <div class="flex flex-col items-end">
                           <div class="px-2 py-0.5 rounded-full text-[10px] font-bold tracking-wide border backdrop-blur-md mb-1.5"
                              :class="getStatusClass(activeFlight.status)">
                              {{ activeFlight.status || 'Scheduled' }}
                           </div>
                          <div class="text-[10px] opacity-50 uppercase tracking-wider mb-0.5 text-right">預計抵達</div>
                          <div class="text-2xl font-mono font-bold leading-none">{{ activeFlight.arrTime }}</div>
                      </div>
                  </div>
              </div>
          </div>
        </transition>

<div id="sortable-itinerary" class="space-y-3">
          <div v-for="item in sortedItinerary" :key="item.id" 
               class="ios-list-item group relative"
               :data-id="item.id">
            <div class="drag-handle mr-3">
              <i class="ph ph-dots-six-vertical text-gray-300"></i>
            </div>
            
            <div class="flex-1 min-w-0" @click="openItineraryModal(item)">
              <div class="flex items-center gap-2 mb-0.5">
                <span class="text-[13px] font-bold text-[#007AFF] font-mono">{{ item.time }}</span>
                <span class="text-[15px] font-bold text-gray-900 truncate">{{ item.title }}</span>
              </div>
              <div v-if="item.location" class="flex items-center gap-1 text-[12px] text-gray-500">
                <i class="ph ph-map-pin"></i>
                <span class="truncate">{{ item.location }}</span>
              </div>
            </div>

            <div class="action-btn-group">
              <button v-if="item.location" @click.stop="showLocationOnMap(item.location)" class="icon-btn">
                <i class="ph ph-navigation-arrow"></i>
              </button>
              <button @click.stop="removeItineraryItem(item.id)" class="icon-btn delete">
                <i class="ph ph-trash"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
            <input v-model="quickItinerary" @keyup.enter="addQuickItinerary"
                   type="text" placeholder="快速加入行程 (例如: 12:00 午飯)" 
                   class="ios-input !py-3 !text-sm flex-1" />
            <button @click="addQuickItinerary" class="bg-[#007AFF] text-white w-12 h-11 rounded-xl flex items-center justify-center shadow-sm active:scale-95 transition-transform">
                <i class="ph ph-plus-bold"></i>
            </button>
        </div>
      </div>

      <div v-if="currentTab === '準備'" class="space-y-6">
        <div class="ios-card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold flex items-center gap-2">
                <i class="ph ph-check-square-offset text-[#007AFF]"></i>
                事前準備 / 備忘
            </h2>
          </div>
          
          <div class="space-y-3">
             <div v-for="note in preTripNotes" :key="note.id" 
                  class="flex items-center justify-between p-3 rounded-xl transition-all"
                  :class="note.done ? 'bg-gray-50/50' : 'bg-white border border-gray-100 shadow-sm'">
                <div class="flex items-center gap-3 flex-1 min-w-0" @click="togglePreNoteDone(note)">
                    <i class="ph text-xl" :class="note.done ? 'ph-check-circle text-green-500' : 'ph-circle text-gray-300'"></i>
                    <span :class="{'task-done': note.done}" class="text-sm font-medium text-gray-700 truncate">{{ note.content }}</span>
                </div>
                <div class="flex items-center gap-1">
                    <button @click="editPreNote(note)" class="p-2 text-gray-400 hover:text-[#007AFF]">
                        <i class="ph ph-pencil-simple"></i>
                    </button>
                    <button @click="removePreNote(note.id)" class="p-2 text-gray-400 hover:text-red-500">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
             </div>
          </div>

          <div class="mt-4 flex gap-2">
            <input v-model="newPreNote" @keyup.enter="addPreNote"
                   type="text" placeholder="新增備忘事項..." 
                   class="ios-input !py-3 !text-sm" />
            <button @click="addPreNote" class="bg-[#007AFF] text-white px-4 rounded-xl font-bold active:scale-95 transition-transform">
                <i class="ph ph-plus-bold"></i>
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3">
            <div class="ios-card p-4 flex flex-col items-center justify-center text-center cursor-pointer active:scale-95 transition-transform" @click="currentTab = '資訊'">
                <i class="ph ph-info text-2xl text-[#5856D6] mb-1"></i>
                <span class="text-xs font-bold">實用資訊</span>
            </div>
            <div class="ios-card p-4 flex flex-col items-center justify-center text-center cursor-pointer active:scale-95 transition-transform" @click="currentTab = '帳目'">
                <i class="ph ph-coins text-2xl text-[#FF9500] mb-1"></i>
                <span class="text-xs font-bold">支出清單</span>
            </div>
        </div>
      </div>
/-哩度冇pro-/

<div v-if="currentTab === '資訊'" class="space-y-4">
        <div class="flex items-center justify-between px-1">
          <h2 class="text-xl font-bold text-black">實用資訊</h2>
          <button @click="openInfoModal()" class="text-[#007AFF] font-bold text-sm bg-white/50 px-3 py-1.5 rounded-full border border-black/5 active:scale-95 transition-transform">
            <i class="ph ph-plus-bold mr-1"></i> 新增
          </button>
        </div>

        <div class="grid grid-cols-1 gap-3">
          <div v-for="info in infoList" :key="info.id" class="ios-card p-4 flex flex-col group relative">
             <div class="flex justify-between items-start mb-2">
                <span class="text-[10px] font-bold text-[#007AFF] uppercase tracking-widest">{{ info.category }}</span>
                <div class="flex gap-1">
                    <button @click="openInfoModal(info)" class="p-1.5 text-gray-400 hover:text-blue-500"><i class="ph ph-pencil-simple"></i></button>
                    <button @click="removeInfo(info.id)" class="p-1.5 text-gray-400 hover:text-red-500"><i class="ph ph-trash"></i></button>
                </div>
             </div>
             <h3 class="font-bold text-gray-900 mb-1">{{ info.title }}</h3>
             <p class="text-sm text-gray-600 mb-3 whitespace-pre-wrap">{{ info.content }}</p>
             <div v-if="info.imageUrl" class="relative mt-2 rounded-xl overflow-hidden border border-black/5 aspect-video bg-gray-100" @click="openImageViewer(info.imageUrl)">
                <img :src="info.imageUrl" class="w-full h-full object-cover" />
                <div class="absolute inset-0 bg-black/5"></div>
             </div>
          </div>
        </div>
      </div>

      <div v-if="currentTab === '帳目'" class="space-y-4">
        <div class="ios-card-dark-glass p-6 mb-6">
            <div class="dark-glass-gradient"></div>
            <div class="relative z-10">
                <div class="text-white/60 text-xs font-bold uppercase tracking-widest mb-1">總支出 (TWD)</div>
                <div class="text-4xl font-bold tracking-tight mb-4">{{ formatNumber(totalExpense) }}</div>
                <div class="flex gap-2">
                    <button @click="expenseFilter = 'all'" :class="expenseFilter === 'all' ? 'bg-white text-black' : 'bg-white/10 text-white'" class="px-4 py-1.5 rounded-full text-[11px] font-bold transition-all">全部</button>
                    <button v-for="cat in expenseCats" :key="cat" @click="expenseFilter = cat" :class="expenseFilter === cat ? 'bg-white text-black' : 'bg-white/10 text-white'" class="px-4 py-1.5 rounded-full text-[11px] font-bold transition-all">
                        {{ cat }}
                    </button>
                </div>
            </div>
        </div>

        <div id="sortable-expenses" class="space-y-3">
            <div v-for="exp in filteredExpenses" :key="exp.id" class="ios-list-item" :data-id="exp.id">
                <div class="drag-handle mr-2"><i class="ph ph-dots-six-vertical text-gray-300"></i></div>
                <div class="w-10 h-10 rounded-full bg-[#007AFF]/10 flex items-center justify-center text-[#007AFF] mr-3">
                    <i :class="getCategoryIcon(exp.category)" class="text-xl"></i>
                </div>
                <div class="flex-1 min-w-0" @click="openExpenseModal(exp)">
                    <div class="font-bold text-gray-900 truncate">{{ exp.title }}</div>
                    <div class="text-[11px] text-gray-500 font-medium">{{ exp.category }} • {{ exp.payer }}</div>
                </div>
                <div class="text-right flex items-center gap-3">
                    <div class="font-mono font-bold text-gray-900">${{ formatNumber(exp.amount) }}</div>
                    <button @click="removeExpense(exp.id)" class="text-gray-300 hover:text-red-500 p-1"><i class="ph ph-trash"></i></button>
                </div>
            </div>
        </div>
      </div>

      <div v-if="currentTab === '購物'" class="space-y-4">
        <div class="flex items-center justify-between px-1">
          <h2 class="text-xl font-bold text-black">購物清單</h2>
          <button @click="openShoppingModal()" class="text-[#007AFF] font-bold text-sm bg-white/50 px-3 py-1.5 rounded-full border border-black/5 active:scale-95 transition-transform">
            <i class="ph ph-plus-bold mr-1"></i> 新增
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div v-for="item in shoppingList" :key="item.id" class="ios-card p-3 flex flex-col relative" @click="openShoppingModal(item)">
                <div v-if="item.imageUrl" class="w-full aspect-square rounded-xl overflow-hidden mb-2 border border-black/5 bg-gray-50">
                    <img :src="item.imageUrl" class="w-full h-full object-cover" />
                </div>
                <div v-else class="w-full aspect-square rounded-xl bg-gray-100 mb-2 flex items-center justify-center text-gray-300">
                    <i class="ph ph-bag text-3xl"></i>
                </div>
                <div class="font-bold text-[13px] text-gray-900 line-clamp-1">{{ item.title }}</div>
                <div class="flex items-center justify-between mt-1">
                    <span class="text-[11px] font-mono font-bold text-[#34C759]">${{ formatNumber(item.price) }}</span>
                    <i v-if="isInstagramLink(item.link)" class="ph ph-instagram-logo text-pink-500"></i>
                </div>
                <button @click.stop="removeShoppingItem(item.id)" class="absolute top-2 right-2 w-6 h-6 bg-black/20 backdrop-blur-md rounded-full flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="ph ph-x"></i>
                </button>
            </div>
        </div>
      </div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 p-5 pb-8 z-[80] pointer-events-none">
      <div class="iphone-dock max-w-md mx-auto pointer-events-auto">
        <button @click="currentTab = '行程'" class="flex flex-col items-center gap-1 w-14 transition-transform active:scale-90" :class="currentTab === '行程' ? 'text-[#007AFF]' : 'text-gray-400'">
          <i class="ph-fill ph-calendar-blank text-[26px]"></i>
          <span class="text-[10px] font-bold">行程</span>
        </button>
        <button @click="currentTab = '帳目'" class="flex flex-col items-center gap-1 w-14 transition-transform active:scale-90" :class="currentTab === '帳目' ? 'text-[#007AFF]' : 'text-gray-400'">
          <i class="ph-fill ph-coins text-[26px]"></i>
          <span class="text-[10px] font-bold">支出</span>
        </button>
        
        <button @click="openAddModal" class="flex flex-col items-center -translate-y-4 transition-transform active:scale-90">
            <div class="w-14 h-14 bg-[#007AFF] rounded-full flex items-center justify-center shadow-lg shadow-blue-500/40 border-4 border-white">
                <i class="ph ph-plus-bold text-2xl text-white"></i>
            </div>
        </button>

        <button @click="currentTab = '購物'" class="flex flex-col items-center gap-1 w-14 transition-transform active:scale-90" :class="currentTab === '購物' ? 'text-[#007AFF]' : 'text-gray-400'">
          <i class="ph-fill ph-bag text-[26px]"></i>
          <span class="text-[10px] font-bold">購物</span>
        </button>
        <button @click="currentTab = '資訊'" class="flex flex-col items-center gap-1 w-14 transition-transform active:scale-90" :class="currentTab === '資訊' ? 'text-[#007AFF]' : 'text-gray-400'">
          <i class="ph-fill ph-info text-[26px]"></i>
          <span class="text-[10px] font-bold">資訊</span>
        </button>
      </div>
    </div>

<div class="relative z-[100]">
      
      <transition name="fade">
        <div v-if="flightModalOpen" class="fixed inset-0 modal-backdrop flex items-end sm:items-center justify-center">
          <div class="ios-modal-container">
            <div class="ios-modal-header">編輯航班資訊</div>
            <div class="ios-modal-body space-y-4">
              <div class="grid grid-cols-2 gap-3">
                <input v-model="newFlight.code" placeholder="航班編號" class="ios-input" />
                <input v-model="newFlight.status" placeholder="狀態 (如: Landed)" class="ios-input" />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <input v-model="newFlight.fromCode" placeholder="起飛 (如: HKG)" class="ios-input" />
                <input v-model="newFlight.fromTerminal" placeholder="航廈 (如: T1)" class="ios-input" />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <input v-model="newFlight.toCode" placeholder="抵達 (如: TPE)" class="ios-input" />
                <input v-model="newFlight.toTerminal" placeholder="航廈 (如: T1)" class="ios-input" />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <input v-model="newFlight.depTime" placeholder="起飛時間" class="ios-input" />
                <input v-model="newFlight.arrTime" placeholder="抵達時間" class="ios-input" />
              </div>
              <input v-model="newFlight.gate" placeholder="閘口" class="ios-input" />
              <input v-model="newFlight.note" placeholder="備註" class="ios-input" />
              <input v-model="newFlight.liveLink" placeholder="Flighty 實況連結 (URL)" class="ios-input" />
            </div>
            <div class="ios-modal-footer">
              <button @click="closeFlightModal" class="btn-ios-cancel">取消</button>
              <button @click="saveFlight" class="btn-ios-primary">儲存</button>
            </div>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="itineraryModalOpen" class="fixed inset-0 modal-backdrop flex items-end sm:items-center justify-center">
          <div class="ios-modal-container">
            <div class="ios-modal-header">編輯行程</div>
            <div class="ios-modal-body space-y-4">
              <input v-model="newItineraryItem.time" placeholder="時間 (如: 12:00)" class="ios-input" />
              <input v-model="newItineraryItem.title" placeholder="活動標題" class="ios-input" />
              <input v-model="newItineraryItem.location" placeholder="地點" class="ios-input" />
            </div>
            <div class="ios-modal-footer">
              <button @click="closeItineraryModal" class="btn-ios-cancel">取消</button>
              <button @click="saveItineraryItem" class="btn-ios-primary">儲存</button>
            </div>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="expenseModalOpen" class="fixed inset-0 modal-backdrop flex items-end sm:items-center justify-center">
          <div class="ios-modal-container h-[90vh]">
            <div class="ios-modal-header">新增/編輯支出</div>
            <div class="ios-modal-body calc-body">
              <div class="mb-4 space-y-3">
                <div class="flex gap-2">
                    <select v-model="newExpense.category" class="ios-input !w-1/3 text-sm">
                        <option v-for="cat in expenseCats" :key="cat" :value="cat">{{ cat }}</option>
                    </select>
                    <input v-model="newExpense.title" placeholder="項目名稱" class="ios-input !flex-1" />
                </div>
                <div class="flex items-center gap-2">
                    <div class="bg-gray-100 px-4 py-3 rounded-xl flex-1 text-right text-2xl font-mono font-bold">
                        ${{ newExpense.amount || 0 }}
                    </div>
                </div>
                <div class="flex gap-2 items-center px-1">
                   <span class="text-xs font-bold text-gray-400">支付者:</span>
                   <div class="flex gap-1 overflow-x-auto no-scrollbar">
                        <button v-for="m in members" :key="m" @click="newExpense.payer = m"
                                :class="newExpense.payer === m ? 'bg-[#007AFF] text-white' : 'bg-gray-100 text-gray-600'"
                                class="px-3 py-1 rounded-full text-[11px] font-bold whitespace-nowrap transition-colors">
                            {{ m }}
                        </button>
                   </div>
                </div>
              </div>
              
              <div class="calc-grid">
                  <button v-for="b in ['7','8','9','/','4','5','6','*','1','2','3','-','0','.','C','+']" 
                          :key="b" @click="handleCalcInput(b)"
                          class="calc-btn" :class="{'op': ['/','*','-','+'].includes(b), 'top-op': b === 'C'}">
                      {{ b === '*' ? '×' : b === '/' ? '÷' : b }}
                  </button>
                  <button @click="handleCalcInput('=')" class="calc-btn op col-span-2">=</button>
                  <button @click="saveExpense" class="calc-btn done-btn col-span-2">儲存支出</button>
              </div>
            </div>
            <div class="ios-modal-footer">
              <button @click="closeExpenseModal" class="btn-ios-cancel">關閉</button>
            </div>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="infoModalOpen" class="fixed inset-0 modal-backdrop flex items-end sm:items-center justify-center">
          <div class="ios-modal-container">
            <div class="ios-modal-header">編輯實用資訊</div>
            <div class="ios-modal-body space-y-4">
              <input v-model="newInfoItem.category" placeholder="類別 (如: 交通, 酒店)" class="ios-input" />
              <input v-model="newInfoItem.title" placeholder="標題" class="ios-input" />
              <textarea v-model="newInfoItem.content" placeholder="內容..." class="ios-input h-32"></textarea>
              
              <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 ml-1">圖片連結 (可選)</label>
                <input v-model="newInfoItem.imageUrl" placeholder="https://..." class="ios-input" />
              </div>
            </div>
            <div class="ios-modal-footer">
              <button @click="closeInfoModal" class="btn-ios-cancel">取消</button>
              <button @click="saveInfoItem" class="btn-ios-primary">儲存</button>
            </div>
          </div>
        </div>
      </transition>

    </div>

<transition name="fade">
        <div v-if="shoppingModalOpen" class="fixed inset-0 modal-backdrop flex items-end sm:items-center justify-center">
          <div class="ios-modal-container">
            <div class="ios-modal-header">編輯購物項目</div>
            <div class="ios-modal-body space-y-4">
              <input v-model="newShoppingItem.title" placeholder="商品名稱" class="ios-input" />
              <input v-model.number="newShoppingItem.price" type="number" placeholder="預估價格 (TWD)" class="ios-input" />
              <input v-model="newShoppingItem.link" placeholder="參考連結 (IG/Web)" class="ios-input" />
              <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 ml-1">圖片連結 (可選)</label>
                <input v-model="newShoppingItem.imageUrl" placeholder="https://..." class="ios-input" />
              </div>
            </div>
            <div class="ios-modal-footer">
              <button @click="closeShoppingModal" class="btn-ios-cancel">取消</button>
              <button @click="saveShoppingItem" class="btn-ios-primary">儲存</button>
            </div>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="imageViewer.open" class="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center p-5" @click="imageViewer.open = false">
            <img :src="imageViewer.url" class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl" />
            <button class="mt-8 px-8 py-3 bg-white/20 text-white rounded-full font-bold backdrop-blur-md">關閉</button>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="selectedMapLocation" class="fixed bottom-32 left-1/2 -translate-x-1/2 z-[90] w-[90%] max-w-sm">
            <div class="bg-white/90 backdrop-blur-xl p-4 rounded-3xl shadow-2xl border border-black/5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white">
                        <i class="ph ph-map-pin-line text-xl"></i>
                    </div>
                    <div>
                        <div class="text-[10px] font-bold text-gray-400 uppercase">導航至</div>
                        <div class="text-sm font-bold truncate max-w-[150px]">{{ selectedMapLocation }}</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="selectedMapLocation = null" class="px-3 py-2 text-gray-400 font-bold text-xs">取消</button>
                    <a :href="generateMapLink(selectedMapLocation)" target="_blank" class="bg-blue-500 text-white px-4 py-2 rounded-2xl font-bold text-xs shadow-lg shadow-blue-500/30">打開地圖</a>
                </div>
            </div>
        </div>
      </transition>

    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
      setup() {
        // --- App Config ---
        const appVersion = ref('v5.11');
        const currentTab = ref('行程');
        const selectedDay = ref(0);
        const flightBoardStyle = ref('hkg'); // Default to HKG as requested

        // --- Mock Data ---
        const days = [
          { date: '21', week: 'SAT' },
          { date: '22', week: 'SUN' },
          { date: '23', week: 'MON' }
        ];

        const members = ref(['Gemini', 'User']);
        const expenseCats = ['食', '住', '行', '買', '玩', '其他'];

        // --- Database / State ---
        const syncState = ref('synced'); // synced, saving, loading, error
        const syncStatusText = computed(() => {
          if (syncState.value === 'synced') return '已同步雲端';
          if (syncState.value === 'saving') return '正在儲存...';
          if (syncState.value === 'loading') return '載入中...';
          return '連線錯誤';
        });

        // --- Core Data Arrays ---
        const flights = ref([]);
        const itinerary = ref([]);
        const expenses = ref([]);
        const shoppingList = ref([]);
        const infoList = ref([]);
        const preTripNotes = ref([]);

        // --- Rate Data ---
        const rate = ref(4.15); // Default
        const currentLiveRate = ref(null);
        const lastRateUpdateLabel = ref('--:--');
        const formattedRate = computed(() => (rate.value * 1.02).toFixed(3));

        // --- Flight Logic ---
        const activeFlight = computed(() => {
          const currentDayStr = days[selectedDay.value].date;
          return flights.value.find(f => f.dayDate === currentDayStr) || {
            code: 'TBC', fromCode: 'HKG', fromTerminal: 'T1', toCode: 'TPE', toTerminal: 'T1',
            depTime: '--:--', arrTime: '--:--', status: 'Ready', gate: '--', note: '尚未設定航班', dayDate: currentDayStr
          };
        });

        const shouldShowFlightCard = computed(() => currentTab.value === '行程');

        function getStatusClass(status) {
          if (!status) return 'bg-white/10 text-white border-white/20';
          const s = status.toLowerCase();
          if (s.includes('landed') || s.includes('arrived')) return 'bg-green-500/20 text-green-400 border-green-500/30';
          if (s.includes('board')) return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
          if (s.includes('delay')) return 'bg-red-500/20 text-red-400 border-red-500/30';
          return 'bg-white/10 text-white border-white/20';
        }

// --- Itinerary Sort & Drag ---
        const sortedItinerary = computed(() => {
          return [...itinerary.value].filter(item => item.dayIndex === selectedDay.value)
            .sort((a, b) => (a.order || 0) - (b.order || 0));
        });

        const quickItinerary = ref('');
        function addQuickItinerary() {
          if (!quickItinerary.value.trim()) return;
          const timeMatch = quickItinerary.value.match(/(\d{1,2}[:：]\d{2})/);
          const time = timeMatch ? timeMatch[1].replace('：', ':') : '00:00';
          const title = quickItinerary.value.replace(timeMatch ? timeMatch[0] : '', '').trim();
          
          const newItem = {
            id: Date.now().toString(),
            dayIndex: selectedDay.value,
            time: time,
            title: title || '新行程',
            location: '',
            order: itinerary.value.length
          };
          itinerary.value.push(newItem);
          quickItinerary.value = '';
          saveData();
        }

        // --- Expense Logic ---
        const expenseFilter = ref('all');
        const totalExpense = computed(() => {
          return expenses.value.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
        });

        const filteredExpenses = computed(() => {
          let list = [...expenses.value].sort((a, b) => (a.order || 0) - (b.order || 0));
          if (expenseFilter.value !== 'all') {
            list = list.filter(e => e.category === expenseFilter.value);
          }
          return list;
        });

        function getCategoryIcon(cat) {
          const icons = { '食': 'ph-fork-knife', '住': 'ph-bed', '行': 'ph-train', '買': 'ph-shopping-cart', '玩': 'ph-ticket', '其他': 'ph-dots-three-circle' };
          return icons[cat] || 'ph-currency-dollar';
        }

        // --- Calculator Engine ---
        const calcExpr = ref('');
        function handleCalcInput(btn) {
          if (btn === 'C') {
            newExpense.value.amount = 0;
            calcExpr.value = '';
          } else if (btn === '=') {
            try {
              // Basic security for eval
              const result = eval(calcExpr.value.replace(/[^-()\d/*+.]/g, ''));
              newExpense.value.amount = parseFloat(result.toFixed(2));
              calcExpr.value = newExpense.value.amount.toString();
            } catch (e) {
              newExpense.value.amount = 0;
              calcExpr.value = '';
            }
          } else if (['+','-','*','/'].includes(btn)) {
            calcExpr.value += btn;
          } else {
            calcExpr.value += btn;
            // Immediate partial update for user feedback
            try {
                const partial = eval(calcExpr.value.replace(/[^-()\d/*+.]/g, ''));
                if (!isNaN(partial)) newExpense.value.amount = parseFloat(partial.toFixed(2));
            } catch(e) {}
          }
        }

        // --- Pre-trip Notes ---
        const newPreNote = ref('');
        function addPreNote() {
          if (!newPreNote.value.trim()) return;
          preTripNotes.value.push({
            id: Date.now().toString(),
            content: newPreNote.value,
            done: false
          });
          newPreNote.value = '';
          saveData();
        }

        function togglePreNoteDone(note) {
          note.done = !note.done;
          saveData();
        }

        function removePreNote(id) {
          preTripNotes.value = preTripNotes.value.filter(n => n.id !== id);
          saveData();
        }

        // --- Shopping Helpers ---
        function isInstagramLink(url) {
          return url && (url.includes('instagram.com') || url.includes('instagr.am'));
        }

        // --- Map Link Generator ---
        const selectedMapLocation = ref(null);
        function showLocationOnMap(loc) {
          selectedMapLocation.value = loc;
        }
        function generateMapLink(loc) {
          return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;
        }

        function formatNumber(num) {
          return new Intl.NumberFormat().format(num);
        }

// --- Modal States & Controls ---
        const flightModalOpen = ref(false);
        const newFlight = ref({});
        const itineraryModalOpen = ref(false);
        const newItineraryItem = ref({});
        const expenseModalOpen = ref(false);
        const newExpense = ref({ category: '食', title: '', amount: 0, payer: members.value[0] });
        const infoModalOpen = ref(false);
        const newInfoItem = ref({});
        const shoppingModalOpen = ref(false);
        const newShoppingItem = ref({});
        const imageViewer = ref({ open: false, url: '' });

        function openFlightModal(id) {
          const f = flights.value.find(f => f.id === id);
          newFlight.value = f ? { ...f } : { id: Date.now().toString(), dayDate: days[selectedDay.value].date };
          flightModalOpen.value = true;
        }
        function closeFlightModal() { flightModalOpen.value = false; }
        function saveFlight() {
          const idx = flights.value.findIndex(f => f.id === newFlight.value.id);
          if (idx > -1) flights.value[idx] = { ...newFlight.value };
          else flights.value.push({ ...newFlight.value });
          saveData();
          closeFlightModal();
        }

        function openItineraryModal(item) {
          newItineraryItem.value = item ? { ...item } : { id: Date.now().toString(), dayIndex: selectedDay.value, time: '', title: '', location: '' };
          itineraryModalOpen.value = true;
        }
        function closeItineraryModal() { itineraryModalOpen.value = false; }
        function saveItineraryItem() {
          const idx = itinerary.value.findIndex(i => i.id === newItineraryItem.value.id);
          if (idx > -1) itinerary.value[idx] = { ...newItineraryItem.value };
          else itinerary.value.push({ ...newItineraryItem.value });
          saveData();
          closeItineraryModal();
        }
        function removeItineraryItem(id) {
          itinerary.value = itinerary.value.filter(i => i.id !== id);
          saveData();
        }

        function openExpenseModal(exp) {
          newExpense.value = exp ? { ...exp } : { id: Date.now().toString(), category: '食', title: '', amount: 0, payer: members.value[0] };
          calcExpr.value = newExpense.value.amount ? newExpense.value.amount.toString() : '';
          expenseModalOpen.value = true;
        }
        function closeExpenseModal() { expenseModalOpen.value = false; }
        function saveExpense() {
          const idx = expenses.value.findIndex(e => e.id === newExpense.value.id);
          if (idx > -1) expenses.value[idx] = { ...newExpense.value };
          else expenses.value.push({ ...newExpense.value, order: expenses.value.length });
          saveData();
          closeExpenseModal();
        }
        function removeExpense(id) {
          expenses.value = expenses.value.filter(e => e.id !== id);
          saveData();
        }

        function openInfoModal(info) {
          newInfoItem.value = info ? { ...info } : { id: Date.now().toString(), category: '交通', title: '', content: '', imageUrl: '' };
          infoModalOpen.value = true;
        }
        function closeInfoModal() { infoModalOpen.value = false; }
        function saveInfoItem() {
          const idx = infoList.value.findIndex(i => i.id === newInfoItem.value.id);
          if (idx > -1) infoList.value[idx] = { ...newInfoItem.value };
          else infoList.value.push({ ...newInfoItem.value });
          saveData();
          closeInfoModal();
        }
        function removeInfo(id) {
          infoList.value = infoList.value.filter(i => i.id !== id);
          saveData();
        }

        function openShoppingModal(item) {
          newShoppingItem.value = item ? { ...item } : { id: Date.now().toString(), title: '', price: 0, link: '', imageUrl: '' };
          shoppingModalOpen.value = true;
        }
        function closeShoppingModal() { shoppingModalOpen.value = false; }
        function saveShoppingItem() {
          const idx = shoppingList.value.findIndex(s => s.id === newShoppingItem.value.id);
          if (idx > -1) shoppingList.value[idx] = { ...newShoppingItem.value };
          else shoppingList.value.push({ ...newShoppingItem.value });
          saveData();
          closeShoppingModal();
        }
        function removeShoppingItem(id) {
          shoppingList.value = shoppingList.value.filter(s => s.id !== id);
          saveData();
        }

        function openImageViewer(url) { imageViewer.value = { open: true, url }; }

        function openAddModal() {
            if (currentTab.value === '行程') openItineraryModal();
            else if (currentTab.value === '帳目') openExpenseModal();
            else if (currentTab.value === '購物') openShoppingModal();
            else if (currentTab.value === '資訊') openInfoModal();
        }

        function selectDay(i) { selectedDay.value = i; }

        // --- Persistence Logic ---
        function saveData() {
          syncState.value = 'saving';
          const bundle = {
            flights: flights.value,
            itinerary: itinerary.value,
            expenses: expenses.value,
            shoppingList: shoppingList.value,
            infoList: infoList.value,
            preTripNotes: preTripNotes.value,
            lastUpdate: new Date().toISOString()
          };
          localStorage.setItem('travelSyncData_v5', JSON.stringify(bundle));
          setTimeout(() => { syncState.value = 'synced'; }, 800);
        }

        function loadData() {
          syncState.value = 'loading';
          const saved = localStorage.getItem('travelSyncData_v5');
          if (saved) {
            const data = JSON.parse(saved);
            flights.value = data.flights || [];
            itinerary.value = data.itinerary || [];
            expenses.value = data.expenses || [];
            shoppingList.value = data.shoppingList || [];
            infoList.value = data.infoList || [];
            preTripNotes.value = data.preTripNotes || [];
          }
          syncState.value = 'synced';
        }

        async function fetchRate() {
          try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/HKD');
            const data = await res.json();
            rate.value = data.rates.TWD;
            lastRateUpdateLabel.value = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          } catch (e) {
            console.error('Rate fetch failed');
          }
        }

        function initSortable() {
            nextTick(() => {
                const itinEl = document.getElementById('sortable-itinerary');
                if (itinEl) {
                    new Sortable(itinEl, {
                        handle: '.drag-handle',
                        animation: 150,
                        onEnd: (evt) => {
                            const newOrder = Array.from(itinEl.children).map(el => el.dataset.id);
                            // Update logic for orders...
                            saveData();
                        }
                    });
                }
                const expEl = document.getElementById('sortable-expenses');
                if (expEl) {
                    new Sortable(expEl, {
                        handle: '.drag-handle',
                        animation: 150,
                        onEnd: () => { saveData(); }
                    });
                }
            });
        }

        onMounted(() => {
          loadData();
          fetchRate();
          initSortable();
        });

        watch(currentTab, () => { initSortable(); });

return {
          appVersion, currentTab, selectedDay, days,
          flightBoardStyle, activeFlight, shouldShowFlightCard, getStatusClass,
          openFlightModal, closeFlightModal, saveFlight, flightModalOpen, newFlight,
          itinerary, sortedItinerary, quickItinerary, addQuickItinerary, 
          openItineraryModal, closeItineraryModal, saveItineraryItem, removeItineraryItem, 
          itineraryModalOpen, newItineraryItem,
          expenses, totalExpense, filteredExpenses, expenseFilter, expenseCats,
          openExpenseModal, closeExpenseModal, saveExpense, removeExpense, 
          expenseModalOpen, newExpense, handleCalcInput, getCategoryIcon,
          infoList, openInfoModal, closeInfoModal, saveInfoItem, removeInfo, 
          infoModalOpen, newInfoItem,
          shoppingList, openShoppingModal, closeShoppingModal, saveShoppingItem, 
          removeShoppingItem, shoppingModalOpen, newShoppingItem, isInstagramLink,
          preTripNotes, newPreNote, addPreNote, removePreNote, togglePreNoteDone,
          syncState, syncStatusText, rate, formattedRate, lastRateUpdateLabel,
          selectDay, openAddModal, formatNumber, members,
          imageViewer, openImageViewer,
          selectedMapLocation, showLocationOnMap, generateMapLink
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
