<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync v3.22</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    /* --- iOS 26 System Variables --- */
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.65);
      --ios-card-border: rgba(255, 255, 255, 0.4);
      --ios-primary: #007AFF;
      --ios-danger: #FF3B30;
      --ios-warning: #FFCC00;
      --ios-success: #34C759;
      --glass-blur: blur(25px);
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    html { height: 100%; overscroll-behavior-y: none; }
    body { height: 100%; font-family: var(--font-stack); -webkit-font-smoothing: antialiased; background-color: #000; margin: 0; color: #000; overflow: hidden; }

    #app { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
    main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-top: 20px; }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 100px); }
    
    /* 拖拽相關樣式 */
    .sortable-ghost { opacity: 0.3; background: var(--ios-primary) !important; }
    .drag-handle { cursor: grab; padding: 10px; color: #C7C7CC; }
    .drag-handle:active { cursor: grabbing; }

    .ios-card {
      background: var(--ios-card-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--ios-card-border);
      border-radius: 22px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    }

    .ios-list-item {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      border-radius: 18px;
      margin-bottom: 10px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid rgba(255,255,255,0.5);
    }

    /* 其餘樣式保持 3.21 原樣... */
    .btn-ios-primary { background: var(--ios-primary); color: white; font-weight: 600; border-radius: 14px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .ios-input { background: rgba(118, 118, 128, 0.12); border: none; border-radius: 12px; padding: 12px 16px; font-size: 17px; width: 100%; }
    .iphone-dock { background: rgba(245, 245, 245, 0.75); backdrop-filter: blur(50px); border-radius: 38px; padding: 8px 16px; border: 1px solid rgba(255, 255, 255, 0.5); }
    .status-ontime { color: var(--ios-success); background: rgba(52, 199, 89, 0.15); }
    .task-done { text-decoration: line-through; opacity: 0.5; }
  </style>
</head>

<body>
  <div id="app">
    <div class="fixed inset-0 z-0 pointer-events-none">
      <div class="absolute inset-0 bg-white/70 backdrop-blur-[2px]"></div>
    </div>

    <main class="relative z-10 no-scrollbar pb-safe px-5">
      <div class="flex items-center justify-between mb-8 mt-4">
        <div>
          <h1 class="text-[34px] font-bold tracking-tight text-black">eMenu Taipei</h1>
          <div class="flex items-center gap-2 mt-0.5">
            <span class="text-[9px] font-semibold text-gray-400 uppercase tracking-widest">{{ appVersion }}</span>
            <div class="flex items-center gap-2 bg-white/50 px-2 py-0.5 rounded-full border border-black/5">
                <div class="w-1.5 h-1.5 rounded-full" :class="syncClass"></div>
                <span class="text-[10px] text-gray-500">{{ syncStatusText }}</span>
            </div>
          </div>
        </div>
        <div class="text-right">
           <span class="text-[10px] font-bold text-[#007AFF] block">即時匯率 (-2%手續費)</span>
           <div class="text-xl font-bold text-gray-800">HKD/TWD {{ formattedRate }}</div>
           <div class="text-[9px] text-gray-400">最後更新：{{ lastRateUpdateLabel }}</div>
        </div>
      </div>

      <div class="mb-8 overflow-x-auto no-scrollbar">
        <div class="flex gap-3">
          <button @click="currentTab = '準備'" class="px-6 py-2 rounded-full font-bold" :class="currentTab==='準備'?'bg-blue-500 text-white':'bg-white/50 text-gray-500'">準備</button>
          <button v-for="(d, i) in days" @click="selectDay(i); currentTab='行程'" class="px-6 py-2 rounded-full font-bold" :class="selectedDay===i && currentTab==='行程'?'bg-blue-500 text-white':'bg-white/50 text-gray-500'">Day {{i+1}}</button>
          <button @click="currentTab = '購物'" class="px-6 py-2 rounded-full font-bold" :class="currentTab==='購物'?'bg-blue-500 text-white':'bg-white/50 text-gray-500'">購物</button>
          <button @click="currentTab = '資訊'" class="px-6 py-2 rounded-full font-bold" :class="currentTab==='資訊'?'bg-blue-500 text-white':'bg-white/50 text-gray-500'">資訊</button>
        </div>
      </div>

      <div class="space-y-4">
        <div v-if="currentTab === '準備'" id="prep-list">
          <div v-for="note in preTripNotes" :key="note.id" class="ios-list-item">
            <div class="flex items-center gap-3">
              <i class="ph ph-list drag-handle"></i>
              <span :class="{'task-done': note.isDone}">{{ note.name }}</span>
            </div>
            <button @click="togglePreNoteDone(note.id)"><i class="ph ph-check-circle"></i></button>
          </div>
        </div>

        <div v-if="currentTab === '行程'" id="itinerary-list">
          <div v-for="it in itinerary[selectedDay]" :key="it.id" class="ios-list-item">
            <div class="flex items-center gap-3">
              <i class="ph ph-list drag-handle"></i>
              <div>
                <div class="text-xs text-blue-500 font-bold">{{ it.time }}</div>
                <div class="font-bold">{{ it.title }}</div>
              </div>
            </div>
            <button @click="removeItineraryItem(it.id)"><i class="ph ph-trash text-red-500"></i></button>
          </div>
        </div>
        
        </div>
    </main>

    <nav class="fixed bottom-6 left-0 right-0 z-30 px-4">
      <div class="iphone-dock w-full max-w-[360px] mx-auto flex justify-around">
        <button @click="currentTab='行程'"><i class="ph ph-map-trifold text-2xl"></i></button>
        <button @click="currentTab='記帳'"><i class="ph ph-receipt text-2xl"></i></button>
        <button @click="currentTab='資訊'"><i class="ph ph-info text-2xl"></i></button>
      </div>
    </nav>
  </div>

  <script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    createApp({
      setup() {
        const appVersion = "v3.22";
        const syncState = ref('synced');
        const currentTab = ref('行程');
        const selectedDay = ref(0);
        const rate = ref(null);
        const lastRateUpdate = ref(null);
        
        // --- 核心數據 ---
        const preTripNotes = ref([]);
        const itinerary = reactive([[], [], [], []]);
        const shoppingList = ref([]);
        const infoList = ref([]);
        const expenses = ref([]);
        const flights = ref([]);

        const supabaseClient = supabase.createClient('YOUR_URL', 'YOUR_KEY');

        // --- 匯率修正：扣除 2% 手續費 ---
        async function fetchExchangeRate() {
          try {
            const res = await fetch('https://open.er-api.com/v6/latest/TWD');
            const d = await res.json();
            if(d?.rates?.HKD) {
              const rawRate = 1 / d.rates.HKD;
              // 實際顯示匯率 = 市場匯率 * 0.98 (減去 2% 手續費)
              rate.value = (rawRate * 0.98).toFixed(2);
              lastRateUpdate.value = new Date();
            }
          } catch(e) { console.error("匯率獲取失敗"); }
        }

        // --- 強化同步邏輯：防止回溯 ---
        async function saveAll() {
          if (syncState.value === 'loading') return;
          syncState.value = 'saving';
          
          const payload = {
            lastUpdated: Date.now(), // 增加時間戳記
            data: {
              itinerary, preTripNotes: preTripNotes.value, 
              shoppingList: shoppingList.value, expenses: expenses.value, 
              infoList: infoList.value, flights: flights.value
            }
          };

          // 同時儲存到本地和雲端
          localStorage.setItem('travel_sync_local', JSON.stringify(payload));

          try {
            await supabaseClient.from('travel_data').upsert({ id: 1, content: payload });
            syncState.value = 'synced';
          } catch (e) {
            syncState.value = 'error';
          }
        }

        async function loadFromCloud() {
          syncState.value = 'loading';
          try {
            const { data: cloudRow } = await supabaseClient.from('travel_data').select('content').eq('id', 1).single();
            const localPayload = JSON.parse(localStorage.getItem('travel_sync_local'));
            
            let finalData;
            const cloudPayload = cloudRow?.content;

            // 比對時間戳記：誰新用誰
            if (cloudPayload && (!localPayload || cloudPayload.lastUpdated > localPayload.lastUpdated)) {
              finalData = cloudPayload.data;
              console.log("使用雲端較新資料");
            } else if (localPayload) {
              finalData = localPayload.data;
              console.log("本地資料較新或雲端無資料");
            }

            if (finalData) {
              applyData(finalData);
            }
            syncState.value = 'synced';
          } catch (e) {
            syncState.value = 'error';
          }
        }

        function applyData(d) {
          if (d.itinerary) d.itinerary.forEach((day, i) => itinerary[i] = day);
          preTripNotes.value = d.preTripNotes || [];
          shoppingList.value = d.shoppingList || [];
          expenses.value = d.expenses || [];
          infoList.value = d.infoList || [];
          flights.value = d.flights || [];
        }

        // --- 初始化拖拽排序 ---
        function initSortable() {
          const options = {
            animation: 150,
            handle: '.drag-handle',
            onEnd: () => saveAll()
          };

          // 針對各個清單初始化
          const prepEl = document.getElementById('prep-list');
          if (prepEl) new Sortable(prepEl, options);

          const itinEl = document.getElementById('itinerary-list');
          if (itinEl) new Sortable(itinEl, options);
        }

        onMounted(() => {
          loadFromCloud();
          fetchExchangeRate();
          setTimeout(initSortable, 1000); // 延遲確保 DOM 已渲染
        });

        // 監聽標籤切換，重新綁定拖拽
        watch(currentTab, () => {
          setTimeout(initSortable, 100);
        });

        return {
          appVersion, syncState, currentTab, selectedDay,
          formattedRate: computed(() => rate.value || '...'),
          lastRateUpdateLabel: computed(() => lastRateUpdate.value?.toLocaleTimeString() || '--:--'),
          preTripNotes, itinerary, shoppingList, infoList,
          syncStatusText: computed(() => syncState.value === 'synced' ? '已同步' : '同步中...'),
          selectDay: (i) => selectedDay.value = i,
          saveAll, togglePreNoteDone: (id) => { /* 邏輯... */ saveAll(); }
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
