<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync v3.23</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    :root {
      --ios-bg: #F2F2F7;
      --ios-primary: #007AFF;
      --ios-card-bg: rgba(255, 255, 255, 0.8);
      --glass-blur: blur(20px);
    }

    /* 修正全黑問題：確保背景不是純黑且主體可見 */
    body { 
      background-color: var(--ios-bg); 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      margin: 0;
      color: #000;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    #app { min-height: 100dvh; display: flex; flex-direction: column; }
    main { flex: 1; padding-bottom: 120px; }

    .ios-card {
      background: var(--ios-card-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .ios-list-item {
      background: white;
      border-radius: 14px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    /* 拖拽手柄樣式 */
    .drag-handle {
      color: #C7C7CC;
      cursor: grab;
      padding: 4px;
      font-size: 20px;
    }
    .sortable-ghost { opacity: 0.2; background: #007AFF !important; }

    .iphone-dock {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      border-radius: 35px;
      padding: 10px;
      display: flex;
      justify-content: space-around;
      border: 1px solid rgba(255,255,255,0.5);
      z-index: 100;
    }

    .nav-btn { display: flex; flex-direction: column; align-items: center; color: #8E8E93; font-size: 10px; }
    .nav-btn.active { color: var(--ios-primary); }
    .nav-btn i { font-size: 24px; margin-bottom: 2px; }

    .task-done { text-decoration: line-through; opacity: 0.5; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>

<body>
  <div id="app" v-cloak>
    <main class="px-5 pt-8">
      <div class="flex justify-between items-start mb-6">
        <div>
          <h1 class="text-3xl font-bold">Taipei Trip</h1>
          <p class="text-[10px] text-gray-400 font-mono">{{ appVersion }} | {{ syncStatusText }}</p>
        </div>
        <div class="text-right ios-card p-3">
          <p class="text-[10px] font-bold text-blue-500">TWD/HKD (-2% Fee)</p>
          <p class="text-xl font-black">{{ displayRate }}</p>
        </div>
      </div>

      <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2">
        <button v-for="tab in tabs" :key="tab" @click="currentTab = tab"
          :class="['px-5 py-2 rounded-full text-sm font-bold transition', currentTab === tab ? 'bg-blue-500 text-white' : 'bg-white text-gray-500']">
          {{ tab }}
        </button>
      </div>

      <div id="main-list-container">
        
        <div v-if="currentTab === '準備'" id="prep-list">
          <div v-for="item in preTripNotes" :key="item.id" :data-id="item.id" class="ios-list-item">
            <i class="ph-bold ph-dots-six-vertical drag-handle"></i>
            <div class="flex-1 flex items-center gap-2" @click="toggleItem(item)">
              <i :class="['ph-bold', item.isDone ? 'ph-check-circle text-green-500' : 'ph-circle text-gray-300']"></i>
              <span :class="{ 'task-done': item.isDone }">{{ item.name }}</span>
            </div>
          </div>
        </div>

        <div v-if="currentTab === '行程'">
          <div class="flex gap-2 mb-4">
            <button v-for="n in 4" @click="selectedDay = n-1" 
              :class="['px-4 py-1 rounded-lg text-xs', selectedDay === n-1 ? 'bg-black text-white' : 'bg-gray-200']">
              Day {{ n }}
            </button>
          </div>
          <div :id="'itin-list-' + selectedDay">
            <div v-for="it in itinerary[selectedDay]" :key="it.id" :data-id="it.id" class="ios-list-item">
              <i class="ph-bold ph-dots-six-vertical drag-handle"></i>
              <div class="flex-1">
                <div class="text-[10px] font-bold text-blue-500">{{ it.time }}</div>
                <div class="font-bold">{{ it.title }}</div>
              </div>
            </div>
          </div>
        </div>

        <div v-if="currentTab === '購物'" id="shop-list">
          <div v-for="item in shoppingList" :key="item.id" :data-id="item.id" class="ios-list-item">
            <i class="ph-bold ph-dots-six-vertical drag-handle"></i>
            <div class="flex-1">{{ item.name }}</div>
            <div class="text-xs text-gray-400">${{ item.price }}</div>
          </div>
        </div>

        <div v-if="currentTab === '資訊'" id="info-list">
          <div v-for="info in infoList" :key="info.id" :data-id="info.id" class="ios-list-item">
            <i class="ph-bold ph-dots-six-vertical drag-handle"></i>
            <div class="flex-1 font-medium">{{ info.title }}</div>
          </div>
        </div>

      </div>
    </main>

    <nav class="iphone-dock">
      <button @click="currentTab='行程'" class="nav-btn" :class="{active: currentTab==='行程'}">
        <i class="ph-fill ph-map-trifold"></i><span>行程</span>
      </button>
      <button @click="currentTab='準備'" class="nav-btn" :class="{active: currentTab==='準備'}">
        <i class="ph-fill ph-briefcase"></i><span>準備</span>
      </button>
      <button @click="currentTab='購物'" class="nav-btn" :class="{active: currentTab==='購物'}">
        <i class="ph-fill ph-shopping-bag"></i><span>購物</span>
      </button>
      <button @click="currentTab='資訊'" class="nav-btn" :class="{active: currentTab==='資訊'}">
        <i class="ph-fill ph-info"></i><span>資訊</span>
      </button>
    </nav>
  </div>

  <script>
    const { createApp, ref, reactive, onMounted, watch, nextTick } = Vue;

    createApp({
      setup() {
        const appVersion = "v3.23";
        const currentTab = ref('行程');
        const selectedDay = ref(0);
        const tabs = ['準備', '行程', '購物', '資訊'];
        const syncStatusText = ref('Initializing...');
        const displayRate = ref('0.00');

        // 核心數據結構
        const preTripNotes = ref([
          { id: 1, name: '護照簽證', isDone: false },
          { id: 2, name: '悠遊卡', isDone: false }
        ]);
        const itinerary = reactive([
          [{ id: 101, time: '10:00', title: '桃園機場' }, { id: 102, time: '12:00', title: '西門町飯店' }],
          [{ id: 201, time: '09:00', title: '阜杭豆漿' }],
          [], []
        ]);
        const shoppingList = ref([{ id: 301, name: '鳳梨酥', price: '500' }]);
        const infoList = ref([{ id: 401, title: '飯店地址：台北市...' }]);

        // --- Supabase 設定 (請填入您的正確資訊) ---
        const SB_URL = "YOUR_SUPABASE_URL";
        const SB_KEY = "YOUR_SUPABASE_KEY";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        // --- 匯率：扣除 2% 手續費 ---
        async function updateExchangeRate() {
          try {
            const res = await fetch('https://open.er-api.com/v6/latest/TWD');
            const data = await res.json();
            const rawRate = 1 / data.rates.HKD;
            // 銀行手續費約 2%，實際開支會更多，因此顯示匯率調低 2% (更保守)
            displayRate.value = (rawRate * 0.98).toFixed(2);
          } catch (e) { displayRate.value = "ERR"; }
        }

        // --- 同步邏輯：修正回溯問題 ---
        async function saveData() {
          syncStatusText.value = "Saving...";
          const timestamp = Date.now();
          const payload = {
            ts: timestamp,
            data: {
              preTripNotes: preTripNotes.value,
              itinerary: itinerary,
              shoppingList: shoppingList.value,
              infoList: infoList.value
            }
          };

          // 1. 先存本地
          localStorage.setItem('travel_sync_data', JSON.stringify(payload));

          // 2. 存雲端
          try {
            await supabaseClient.from('travel_sync').upsert({ id: 1, content: payload });
            syncStatusText.value = "Synced";
          } catch (e) {
            syncStatusText.value = "Cloud Fail (Local OK)";
          }
        }

        async function loadData() {
          syncStatusText.value = "Loading...";
          try {
            const { data: cloud } = await supabaseClient.from('travel_sync').select('content').eq('id', 1).single();
            const local = JSON.parse(localStorage.getItem('travel_sync_data'));

            let bestData = null;

            // 回溯防護邏輯：比較時間戳記
            if (cloud?.content && local) {
              bestData = (cloud.content.ts > local.ts) ? cloud.content.data : local.data;
              console.log(cloud.content.ts > local.ts ? "Using Cloud (Newer)" : "Using Local (Newer)");
            } else {
              bestData = cloud?.content?.data || local?.data;
            }

            if (bestData) {
              preTripNotes.value = bestData.preTripNotes || [];
              bestData.itinerary?.forEach((d, i) => itinerary[i] = d);
              shoppingList.value = bestData.shoppingList || [];
              infoList.value = bestData.infoList || [];
            }
            syncStatusText.value = "Ready";
          } catch (e) {
            syncStatusText.value = "Offline Mode";
          }
        }

        // --- 拖拽排序初始化 ---
        function initDragSort() {
          const listIds = ['prep-list', 'shop-list', 'info-list', `itin-list-${selectedDay.value}`];
          
          listIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;

            new Sortable(el, {
              handle: '.drag-handle',
              animation: 200,
              ghostClass: 'sortable-ghost',
              onEnd: (evt) => {
                // 根據 ID 更新 Vue Data
                handleSortEnd(id, evt);
              }
            });
          });
        }

        function handleSortEnd(listId, evt) {
          if (listId === 'prep-list') {
            const arr = [...preTripNotes.value];
            const [moved] = arr.splice(evt.oldIndex, 1);
            arr.splice(evt.newIndex, 0, moved);
            preTripNotes.value = arr;
          } else if (listId.startsWith('itin-list')) {
            const dayIdx = selectedDay.value;
            const arr = [...itinerary[dayIdx]];
            const [moved] = arr.splice(evt.oldIndex, 1);
            arr.splice(evt.newIndex, 0, moved);
            itinerary[dayIdx] = arr;
          }
          saveData();
        }

        const toggleItem = (item) => {
          item.isDone = !item.isDone;
          saveData();
        };

        // 監聽 Tab 或 日期切換，切換後重新綁定拖拽
        watch([currentTab, selectedDay], () => {
          nextTick(() => initDragSort());
        });

        onMounted(async () => {
          await loadData();
          updateExchangeRate();
          nextTick(() => initDragSort());
          
          // 每 5 分鐘自動保存
          setInterval(saveData, 300000);
        });

        return {
          appVersion, currentTab, tabs, selectedDay,
          preTripNotes, itinerary, shoppingList, infoList,
          syncStatusText, displayRate,
          toggleItem
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
